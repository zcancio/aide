name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [created]

jobs:
  claude:
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'zcancio'
    runs-on: self-hosted

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: aide
          POSTGRES_PASSWORD: test
          POSTGRES_DB: aide_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      TESTING: "true"
      JWT_SECRET: test-secret-not-for-production-use-1234567890abcdef

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Get postgres container ID
        run: echo "POSTGRES_CONTAINER=$(docker ps --filter 'ancestor=postgres:16' -q)" >> $GITHUB_ENV

      - name: Create non-superuser app role
        run: |
          docker exec $POSTGRES_CONTAINER psql -U aide -d aide_test -c "
            CREATE ROLE aide_app WITH LOGIN PASSWORD 'test' NOSUPERUSER;
            GRANT ALL PRIVILEGES ON DATABASE aide_test TO aide_app;
          "

      - name: Run migrations
        env:
          DATABASE_URL: postgres://aide:test@localhost:5432/aide_test
        run: alembic upgrade head

      - name: Grant table permissions to app role
        run: |
          docker exec $POSTGRES_CONTAINER psql -U aide -d aide_test -c "
            GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO aide_app;
            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO aide_app;
          "

      - name: Configure git
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"

      - name: Create working branch
        run: |
          BRANCH="claude/issue-${{ github.event.issue.number || github.event.pull_request.number }}"
          git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Fetch issue body
        if: github.event.issue
        run: |
          gh issue view ${{ github.event.issue.number }} --json title,body --jq '"# " + .title + "\n\n" + .body' > /tmp/issue_body.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Claude Code
        run: |
          TASK=$(echo "$RAW_TASK" | sed 's/^@claude\s*//')
          ISSUE_BODY=""
          if [ -f /tmp/issue_body.txt ]; then
            ISSUE_BODY=$(cat /tmp/issue_body.txt)
          fi
          cat <<EOF | claude --print --model claude-sonnet-4-5-20250929 --allowedTools "Bash,Read,Write,Edit"
          ${TASK}

          ## Issue Details
          ${ISSUE_BODY}

          ## Instructions
          1. Complete all tasks in the issue checklist
          2. Run: ruff check backend/ && ruff format --check backend/
          3. If you created new migrations, run them: DATABASE_URL=postgres://aide:test@localhost:5432/aide_test alembic upgrade head
          4. Run tests with non-superuser to verify RLS: DATABASE_URL=postgres://aide_app:test@localhost:5432/aide_test pytest backend/tests/ -v
          5. Fix any failures before finishing
          6. Write a build log per /implement-phase command in .claude/commands/
          EOF
        env:
          RAW_TASK: ${{ github.event.comment.body }}
          DATABASE_URL: postgres://aide_app:test@localhost:5432/aide_test

      - name: Commit and push
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: implement from issue #${{ github.event.issue.number || github.event.pull_request.number }}"
            git push origin "$BRANCH"
          fi

      - name: Create PR
        if: github.event_name == 'issue_comment' && !github.event.issue.pull_request
        run: |
          gh pr create \
            --title "Claude: $(echo '${{ github.event.comment.body }}' | head -c 60)" \
            --body "Automated implementation from #${{ github.event.issue.number }}" \
            --head "$BRANCH" \
            --base main \
            || echo "PR already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
