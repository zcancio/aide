name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [created]

jobs:
  claude:
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'zcancio'
    runs-on: self-hosted

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: aide
          POSTGRES_PASSWORD: test
          POSTGRES_DB: aide_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      TESTING: "true"
      JWT_SECRET: test-secret-not-for-production-use-1234567890abcdef

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Get postgres container ID
        run: echo "POSTGRES_CONTAINER=$(docker ps --filter 'ancestor=postgres:16' -q)" >> $GITHUB_ENV

      - name: Create non-superuser app role
        run: |
          docker exec $POSTGRES_CONTAINER psql -U aide -d aide_test -c "
            CREATE ROLE aide_app WITH LOGIN PASSWORD 'test' NOSUPERUSER;
            GRANT ALL PRIVILEGES ON DATABASE aide_test TO aide_app;
          "

      - name: Run migrations
        env:
          DATABASE_URL: postgres://aide:test@localhost:5432/aide_test
        run: alembic upgrade head

      - name: Grant table permissions to app role
        run: |
          docker exec $POSTGRES_CONTAINER psql -U aide -d aide_test -c "
            GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO aide_app;
            GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO aide_app;
          "

      - name: Configure git
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"

      - name: Fetch issue body and detect branch
        if: github.event.issue
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Fetch issue details
          gh issue view "$ISSUE_NUM" --json title,body --jq '"# " + .title + "\n\n" + .body' > /tmp/issue_body.txt
          ISSUE_BODY=$(cat /tmp/issue_body.txt)

          # Check for branch specification in issue body (e.g., "branch: feature/foo" or "base: develop")
          SPECIFIED_BRANCH=$(echo "$ISSUE_BODY" | grep -iE "^(branch|base):\s*" | head -1 | sed 's/^[^:]*:\s*//' | tr -d '\r\n ')

          # Check for existing PR for this issue
          EXISTING_PR=$(gh pr list --search "head:claude/issue-$ISSUE_NUM" --json number,headRefName --jq '.[0].headRefName // empty')

          if [ -n "$SPECIFIED_BRANCH" ]; then
            echo "Using branch specified in issue: $SPECIFIED_BRANCH"
            BRANCH="$SPECIFIED_BRANCH"
            IS_CONTINUATION="false"
          elif [ -n "$EXISTING_PR" ]; then
            echo "Found existing PR branch: $EXISTING_PR"
            BRANCH="$EXISTING_PR"
            IS_CONTINUATION="true"
          else
            echo "Creating new branch for issue"
            BRANCH="claude/issue-$ISSUE_NUM"
            IS_CONTINUATION="false"
          fi

          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "IS_CONTINUATION=$IS_CONTINUATION" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout or create branch
        run: |
          # Fetch all remote branches
          git fetch origin

          if git show-ref --verify --quiet "refs/remotes/origin/$BRANCH"; then
            echo "Branch exists on remote, checking out"
            git checkout -B "$BRANCH" "origin/$BRANCH"
          elif git show-ref --verify --quiet "refs/heads/$BRANCH"; then
            echo "Branch exists locally, checking out"
            git checkout "$BRANCH"
          else
            echo "Creating new branch from main"
            git checkout -b "$BRANCH"
          fi

      - name: Read previous progress
        if: env.IS_CONTINUATION == 'true'
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          PROGRESS_FILE=".claude/build_logs/issue_${ISSUE_NUM}_progress.md"

          if [ -f "$PROGRESS_FILE" ]; then
            echo "Found previous progress log"
            cat "$PROGRESS_FILE" > /tmp/previous_progress.txt
            echo "PREVIOUS_PROGRESS_FILE=$PROGRESS_FILE" >> $GITHUB_ENV
          else
            echo "No previous progress file found"
            echo "" > /tmp/previous_progress.txt
          fi

      - name: Run Claude Code
        run: |
          TASK=$(echo "$RAW_TASK" | sed 's/^@claude\s*//')
          ISSUE_BODY=""
          PREVIOUS_PROGRESS=""

          if [ -f /tmp/issue_body.txt ]; then
            ISSUE_BODY=$(cat /tmp/issue_body.txt)
          fi

          if [ -f /tmp/previous_progress.txt ] && [ -s /tmp/previous_progress.txt ]; then
            PREVIOUS_PROGRESS=$(cat /tmp/previous_progress.txt)
          fi

          CONTINUATION_CONTEXT=""
          if [ "$IS_CONTINUATION" = "true" ]; then
            CONTINUATION_CONTEXT="
          ## Previous Progress
          This is a continuation of previous work on this issue. Review what was done:
          ${PREVIOUS_PROGRESS}

          Continue from where the previous run left off. Do not redo completed work.
          "
          fi

          cat <<EOF | claude --print --dangerously-skip-permissions --model claude-sonnet-4-5-20250929
          ${TASK}

          ## Issue Details
          ${ISSUE_BODY}
          ${CONTINUATION_CONTEXT}

          ## Instructions
          1. Complete all tasks in the issue checklist
          2. Run: ruff check backend/ && ruff format --check backend/
          3. If you created new migrations, run them: DATABASE_URL=postgres://aide:test@localhost:5432/aide_test alembic upgrade head
          4. Run tests with non-superuser to verify RLS: DATABASE_URL=postgres://aide_app:test@localhost:5432/aide_test pytest backend/tests/ -v
          5. Fix any failures before finishing
          6. Write a build log to .claude/build_logs/issue_${{ github.event.issue.number }}_progress.md documenting what was done
          EOF
        env:
          RAW_TASK: ${{ github.event.comment.body }}
          DATABASE_URL: postgres://aide_app:test@localhost:5432/aide_test
          IS_CONTINUATION: ${{ env.IS_CONTINUATION }}

      - name: Commit any uncommitted changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No uncommitted changes"
          else
            echo "Committing uncommitted changes:"
            git diff --cached --stat
            git commit -m "feat: implement from issue #${{ github.event.issue.number || github.event.pull_request.number }}"
          fi

      - name: Check for commits to push
        id: verify
        run: |
          # Check if branch exists on remote
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            COMMITS_AHEAD=$(git rev-list --count "origin/$BRANCH..HEAD")
          else
            # New branch - count commits ahead of main
            COMMITS_AHEAD=$(git rev-list --count "origin/main..HEAD")
          fi

          echo "Commits ahead: $COMMITS_AHEAD"

          if [ "$COMMITS_AHEAD" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git log --oneline "origin/main..HEAD"
          else
            echo "::warning::No new commits to push"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.verify.outputs.has_changes == 'true'
        run: git push -u origin "$BRANCH"

      - name: Create or update PR
        if: steps.verify.outputs.has_changes == 'true' && github.event_name == 'issue_comment' && !github.event.issue.pull_request
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists, adding comment with update"
            gh pr comment "$EXISTING_PR" --body "Updated with additional changes from @claude request in #$ISSUE_NUM"
          else
            echo "Creating new PR"
            PR_BODY=$(cat <<PRBODY
          Automated implementation from #$ISSUE_NUM

          ## Changes
          See build log in .claude/build_logs/issue_${ISSUE_NUM}_progress.md for details.

          Closes #$ISSUE_NUM
          PRBODY
            )
            gh pr create \
              --title "Claude: $(echo '${{ github.event.comment.body }}' | head -c 60)" \
              --body "$PR_BODY" \
              --head "$BRANCH" \
              --base main
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment if no changes
        if: steps.verify.outputs.has_changes == 'false' && github.event.issue
        run: |
          gh issue comment "${{ github.event.issue.number }}" \
            --body "Claude completed but made no file changes. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
