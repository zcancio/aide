name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [created]

jobs:
  claude:
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login == 'zcancio'
    runs-on: self-hosted

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: aide
          POSTGRES_PASSWORD: test
          POSTGRES_DB: aide_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgres://aide:test@localhost:5432/aide_test
      TESTING: "true"

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Configure git
        run: |
          git config user.name "claude-code[bot]"
          git config user.email "claude-code[bot]@users.noreply.github.com"

      - name: Create working branch
        run: |
          BRANCH="claude/issue-${{ github.event.issue.number || github.event.pull_request.number }}"
          git checkout -b "$BRANCH" 2>/dev/null || git checkout "$BRANCH"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: Run Claude Code
        run: |
          # Strip @claude from the beginning of the task
          TASK=$(echo "$RAW_TASK" | sed 's/^@claude\s*//')
          claude --print \
            --model claude-sonnet-4-5-20250929 \
            --allowedTools "Bash,Read,Write,Edit" \
            "$TASK

            After completing the task:
            1. Run: ruff check backend/ && ruff format --check backend/
            2. Run: alembic upgrade head (if migrations exist)
            3. Run: pytest backend/tests/ -v
            4. Fix any failures before finishing"
        env:
          RAW_TASK: ${{ github.event.comment.body }}

      - name: Commit and push
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: implement from issue #${{ github.event.issue.number || github.event.pull_request.number }}"
            git push origin "$BRANCH"
          fi

      - name: Create PR
        if: github.event_name == 'issue_comment' && !github.event.issue.pull_request
        run: |
          gh pr create \
            --title "Claude: $(echo '${{ github.event.comment.body }}' | head -c 60)" \
            --body "Automated implementation from #${{ github.event.issue.number }}" \
            --head "$BRANCH" \
            --base main \
            || echo "PR already exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
