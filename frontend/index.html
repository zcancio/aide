<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aide</title>
  <!-- Fonts for renderer display components -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --card: #1e1e1e;
      --elevated: #242424;
      --border: #2a2a2a;
      --border-strong: #3a3a3a;
      --text: #e8e8e8;
      --text-primary: #e8e8e8;
      --text-secondary: #a8a8a8;
      --text-tertiary: #888;
      --text-muted: #888;
      --accent: #fff;
      --sage-500: #7C8C6E;
      --sage-600: #667358;
      --overlay-bg: rgba(0, 0, 0, 0.3);
      --radius: 12px;
      --input-height: 52px;
      --chat-max-width: 640px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* ── DASHBOARD ─────────────────────────────────── */
    #dashboard {
      display: none;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      padding: 40px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    #dashboard.active { display: flex; }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .dashboard-header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.15s, opacity 0.15s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--sage-500); color: #F7F5F2; }
    .btn-primary:hover:not(:disabled) { background: var(--sage-600); }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); color: var(--text); }
    .btn-danger { background: transparent; color: #e55; border: 1px solid #e55; }
    .btn-danger:hover { background: rgba(238,85,85,0.1); }

    .aide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .aide-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      position: relative;
    }

    .aide-card:hover { border-color: #444; background: #202020; }

    .aide-card-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 60px;
    }

    .aide-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .status-draft { background: #2a2a2a; color: #888; }
    .status-published { background: rgba(80, 200, 120, 0.15); color: #5c8; }
    .status-archived { background: rgba(255, 100, 100, 0.1); color: #e66; }

    .aide-card-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .aide-card:hover .aide-card-actions { opacity: 1; }

    .icon-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: var(--border);
      color: var(--text-muted);
      font-size: 13px;
      transition: background 0.15s, color 0.15s;
    }

    .icon-btn:hover { background: #333; color: var(--text); }
    .icon-btn.danger:hover { background: rgba(238,85,85,0.2); color: #e55; }

    .empty-state {
      text-align: center;
      padding: 80px 0;
      color: var(--text-muted);
    }

    .empty-state p { margin-bottom: 20px; font-size: 15px; }

    /* ── FAB (floating action button) ── */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: var(--sage-500);
      border: none;
      color: #F7F5F2;
      font-size: 24px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: background 0.15s ease, transform 0.15s ease;
      z-index: 50;
    }

    .fab:hover {
      background: var(--sage-600);
      transform: scale(1.05);
    }

    #new-aide-fab {
      display: none;
    }

    #dashboard.active #new-aide-fab {
      display: flex;
    }

    /* ── EDITOR (responsive layout) ────────────────────── */
    #editor {
      display: none;
      position: relative;
      overflow: hidden;
    }

    #editor.active { display: block; }

    /* Desktop layout (≥768px): flex row with side panel */
    @media (min-width: 768px) {
      #editor {
        display: flex;
        height: 100vh;
        margin-top: 44px;
      }

      #editor.active {
        display: flex;
      }

      #page-container {
        flex: 1;
        display: flex;
        overflow: hidden;
        min-width: 0;
      }

      #aide-page-scroll {
        flex: 1;
        overflow: auto;
        min-width: 0;
        background: #F7F5F2;
      }

      @media (prefers-color-scheme: dark) {
        #aide-page-scroll {
          background: #1A1A18;
        }
      }

      #aide-page-content {
        max-width: 600px;
        margin: 0 auto;
        padding: 28px 32px 60px;
      }

      /* Chat panel (desktop) */
      #desktop-chat-panel {
        width: 360px;
        flex-shrink: 0;
        background: var(--surface);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.25s ease, min-width 0.25s ease;
      }

      #desktop-chat-panel.closed {
        width: 0;
        min-width: 0;
        border-left: none;
      }

      #mobile-bottom-sheet {
        display: none;
      }

      #mobile-toast {
        display: none;
      }
    }

    /* Mobile layout (<768px): stacked with bottom sheet */
    @media (max-width: 767px) {
      body {
        max-width: 430px;
        margin: 0 auto;
        overflow: hidden;
        height: 100dvh;
      }

      #editor {
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      #page-container {
        flex: 1;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      #aide-page-scroll {
        flex: 1;
        overflow: auto;
        background: #F7F5F2;
        padding-top: 44px;
        padding-bottom: 96px;
      }

      @media (prefers-color-scheme: dark) {
        #aide-page-scroll {
          background: #1A1A18;
        }
      }

      #aide-page-content {
        padding: 20px 20px 20px;
      }

      #desktop-chat-panel {
        display: none;
      }

      #mobile-bottom-sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        max-width: 430px;
        margin: 0 auto;
        z-index: 150;
        touch-action: none;
      }

      .fab {
        bottom: 20px;
        right: 16px;
        width: 48px;
        height: 48px;
        font-size: 22px;
      }
    }

    /* ── NAV BAR ─────────────────────────────────────── */
    #editor-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 44px;
      background: rgba(26, 26, 26, 0.9);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--border);
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 200;
    }

    #editor.active #editor-nav {
      display: flex;
    }

    .nav-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.15s;
    }

    .nav-back:hover {
      color: var(--text-primary);
    }

    .nav-title {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      border-radius: 6px;
    }

    .nav-btn:hover {
      background: var(--elevated);
      color: var(--text-primary);
    }

    .nav-btn.active {
      background: var(--elevated);
      color: var(--text-primary);
    }

    @media (min-width: 768px) {
      .nav-title {
        max-width: 40%;
      }

      #chat-toggle-btn {
        display: inline-flex;
      }
    }

    @media (max-width: 767px) {
      .nav-title {
        max-width: 55%;
      }

      #chat-toggle-btn {
        display: none;
      }
    }

    /* ── CHAT MESSAGES (shared) ───────────────────────── */
    .chat-message {
      display: flex;
      margin-bottom: 16px;
      animation: fadeIn 0.2s ease-out;
    }

    .chat-message.user {
      justify-content: flex-end;
    }

    .chat-message.assistant {
      justify-content: flex-start;
      gap: 8px;
    }

    .aide-avatar {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      background: var(--sage-500);
      color: #F7F5F2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      line-height: 10px;
      flex-shrink: 0;
    }

    @media (max-width: 767px) {
      .aide-avatar {
        width: 20px;
        height: 20px;
        border-radius: 5px;
        font-size: 10px;
      }
    }

    .message-bubble {
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .message-bubble.user {
      background: var(--elevated);
      color: var(--text-primary);
      padding: 9px 13px;
      border-radius: 14px 14px 4px 14px;
      max-width: 85%;
    }

    .message-bubble.assistant {
      color: var(--text-secondary);
      max-width: calc(100% - 30px);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dots span {
      width: 5px;
      height: 5px;
      background: var(--text-tertiary);
      border-radius: 50%;
      animation: pulse 1.2s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes pulse {
      0%, 60%, 100% { transform: scale(0.8); opacity: 0.5; }
      30% { transform: scale(1.2); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ── DESKTOP CHAT PANEL ─────────────────────────── */
    .panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-tertiary);
    }

    .panel-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .panel-messages::-webkit-scrollbar {
      display: none;
    }

    .panel-input {
      border-top: 1px solid var(--border);
      padding: 12px;
    }

    .input-container {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 5px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .input-container textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 100px;
      overflow-y: auto;
      line-height: 1.5;
      padding: 6px 8px;
      scrollbar-width: none;
    }

    .input-container textarea::-webkit-scrollbar {
      display: none;
    }

    .input-container textarea::placeholder {
      color: var(--text-tertiary);
    }

    .send-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--sage-500);
      color: #F7F5F2;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.15s;
    }

    .send-btn:hover:not(:disabled) {
      background: var(--sage-600);
    }

    .send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .send-btn.empty {
      background: var(--elevated);
      color: var(--text-tertiary);
    }

    /* ── MOBILE BOTTOM SHEET ────────────────────────── */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.35);
      z-index: 149;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sheet-backdrop.visible {
      display: block;
      opacity: 1;
    }

    .sheet-container {
      background: transparent;
      border-radius: 18px 18px 0 0;
      display: flex;
      flex-direction: column;
      transition: height 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      position: relative;
    }

    .sheet-container.dragging {
      transition: none;
    }

    .sheet-container.peek {
      background: transparent;
      border-radius: 0;
      box-shadow: none;
    }

    .sheet-container.input,
    .sheet-container.history {
      background: var(--card);
      border-top: 1px solid var(--border-strong);
      box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.3);
    }

    .sheet-handle {
      padding: 8px 0;
      display: flex;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      flex-shrink: 0;
    }

    .sheet-handle-bar {
      width: 36px;
      height: 4px;
      background: var(--border-strong);
      border-radius: 2px;
      transition: width 0.2s, background 0.2s;
    }

    .sheet-container.peek .sheet-handle-bar {
      width: 48px;
      background: var(--text-tertiary);
    }

    .sheet-peek-area {
      flex-shrink: 0;
      padding: 0 12px;
      display: none;
    }

    .sheet-peek-area.visible {
      display: block;
    }

    .sheet-messages {
      flex: 1;
      overflow-y: auto;
      padding: 0 12px;
      display: none;
      flex-direction: column;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .sheet-messages::-webkit-scrollbar {
      display: none;
    }

    .sheet-messages.visible {
      display: flex;
    }

    .sheet-messages-spacer {
      flex: 1;
      min-height: 20px;
    }

    .sheet-messages-content {
      flex-shrink: 0;
    }

    .sheet-input {
      flex-shrink: 0;
      padding: 6px 12px 20px;
      display: none;
    }

    .sheet-input.visible {
      display: block;
    }

    .sheet-input-container {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 4px;
      display: flex;
      align-items: flex-end;
      gap: 6px;
    }

    .sheet-input textarea {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      resize: none;
      max-height: 80px;
      overflow-y: auto;
      line-height: 1.5;
      padding: 6px 8px;
      scrollbar-width: none;
    }

    .sheet-input textarea::-webkit-scrollbar {
      display: none;
    }

    .sheet-input textarea::placeholder {
      color: var(--text-tertiary);
    }

    .sheet-send-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: var(--sage-500);
      color: #F7F5F2;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: background 0.15s;
    }

    .sheet-send-btn:hover:not(:disabled) {
      background: var(--sage-600);
    }

    .sheet-send-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* ── MOBILE TOAST ────────────────────────────────── */
    #mobile-toast {
      position: fixed;
      bottom: 84px;
      left: 16px;
      right: 16px;
      max-width: 430px;
      margin: 0 auto;
      z-index: 160;
      display: none;
      pointer-events: none;
    }

    #mobile-toast.visible {
      display: block;
      animation: toastIn 0.25s ease-out;
    }

    #mobile-toast.hiding {
      animation: toastOut 0.7s ease-out forwards;
    }

    .toast-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toast-text {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-secondary);
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastOut {
      to { opacity: 0; transform: translateY(10px); }
    }

    /* ── AUTH ───────────────────────────────────────── */
    #auth-screen {
      display: none;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      gap: 0;
    }

    #auth-screen.active { display: flex; }

    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: -12px;
    }

    .auth-form { display: flex; flex-direction: column; gap: 12px; }

    .form-input {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }

    .form-input:focus { border-color: #555; }
    .form-input::placeholder { color: var(--text-muted); }

    .auth-message {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      min-height: 20px;
    }

    .auth-message.error { color: #e66; }
    .auth-message.success { color: #5c8; }

    /* ── MODAL ──────────────────────────────────────── */
    #modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 360px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-desc { font-size: 13px; color: var(--text-muted); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }

    /* ── DRAG OVERLAY ───────────────────────────────── */
    #drag-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.04);
      border: 2px dashed #555;
      border-radius: 12px;
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #888;
      pointer-events: none;
    }

    #drag-overlay.active { display: flex; }

    /* Hidden scrollbars */
    ::-webkit-scrollbar { display: none; }
    * { scrollbar-width: none; }
  </style>
  <!-- Display.js: Universal renderer for AIde -->
  <script src="/static/display.js"></script>
</head>
<body>

<!-- Auth screen -->
<div id="auth-screen">
  <div class="auth-card">
    <div>
      <div class="auth-title">aide</div>
      <div class="auth-subtitle">Sign in to continue.</div>
    </div>
    <div id="auth-send-form" class="auth-form">
      <input id="email-input" class="form-input" type="email" placeholder="you@example.com" autocomplete="email" />
      <button id="send-link-btn" class="btn btn-primary" style="width:100%;justify-content:center;">Send magic link</button>
      <p id="auth-msg" class="auth-message"></p>
    </div>
    <div id="auth-sent-msg" style="display:none;text-align:center;">
      <p style="color:var(--text-muted);font-size:13px;">Check your email — link sent.</p>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <h1>aide</h1>
  </div>
  <div id="aide-grid" class="aide-grid"></div>
  <div id="empty-state" class="empty-state" style="display:none;">
    <p>Nothing yet.</p>
    <button class="btn btn-ghost" onclick="startNewAide()">Create your first aide</button>
  </div>
  <button id="new-aide-fab" class="fab" onclick="startNewAide()" title="New aide">+</button>
</div>

<!-- Editor -->
<div id="editor">
  <!-- Nav bar -->
  <nav id="editor-nav">
    <button class="nav-back" onclick="history.replaceState({}, '', '/'); location.reload();">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/>
      </svg>
      Back
    </button>
    <div class="nav-title" id="nav-title">aide</div>
    <div class="nav-right">
      <button class="nav-btn" id="share-btn" title="Share">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
          <polyline points="16 6 12 2 8 6"/>
          <line x1="12" y1="2" x2="12" y2="15"/>
        </svg>
      </button>
      <button class="nav-btn" id="chat-toggle-btn" title="Toggle chat">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
      </button>
    </div>
  </nav>

  <!-- Page container -->
  <div id="page-container">
    <div id="aide-page-scroll">
      <div id="aide-page-content"></div>
    </div>

    <!-- Desktop chat panel -->
    <div id="desktop-chat-panel">
      <div class="panel-header">CONVERSATION</div>
      <div class="panel-messages" id="desktop-messages"></div>
      <div class="panel-input">
        <div class="input-container">
          <textarea id="desktop-input" rows="1" placeholder="Tell aide what you're living…"></textarea>
          <button class="send-btn" id="desktop-send-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2 21L23 12 2 3v7l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile bottom sheet -->
    <div id="mobile-bottom-sheet">
      <div class="sheet-backdrop" id="sheet-backdrop"></div>
      <div class="sheet-container" id="sheet-container">
        <div class="sheet-handle" id="sheet-handle">
          <div class="sheet-handle-bar"></div>
        </div>
        <div class="sheet-peek-area" id="sheet-peek-area"></div>
        <div class="sheet-messages" id="sheet-messages">
          <div class="sheet-messages-spacer"></div>
          <div class="sheet-messages-content" id="sheet-messages-content"></div>
        </div>
        <div class="sheet-input" id="sheet-input">
          <div class="sheet-input-container">
            <textarea id="mobile-input" rows="1" placeholder="Tell aide what you're living…"></textarea>
            <button class="sheet-send-btn" id="mobile-send-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2 21L23 12 2 3v7l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile toast -->
<div id="mobile-toast">
  <div class="toast-content">
    <div class="aide-avatar">a</div>
    <div class="toast-text" id="toast-text"></div>
  </div>
</div>

<!-- Drag overlay -->
<div id="drag-overlay">Drop image here</div>

<!-- Modal -->
<div id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-desc" id="modal-desc"></div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────
  let currentUser = null;
  let currentAideId = null;
  let conversationHistory = []; // {role, content}
  let isSending = false;
  let pendingUserMessage = null;
  let pendingVoiceResponse = '';

  // ── Responsive state ────────────────────────────────
  let isMobile = window.innerWidth < 768;
  let desktopPanelOpen = true;
  let mobileSnapPosition = 1; // 0=PEEK, 1=INPUT, 2=HISTORY
  let mobilePeekMessages = [];
  let mobileDragState = null;

  // ── Entity Store ────────────────────────────────────
  const entityStore = {
    entities: {},
    rootIds: [],
    meta: {},

    applyDelta(delta) {
      if (delta.type === 'entity.create') {
        this.entities[delta.id] = delta.data || {};
        const parent = (delta.data || {}).parent;
        if (!parent || parent === 'root') {
          if (!this.rootIds.includes(delta.id)) {
            this.rootIds.push(delta.id);
          }
        }
      } else if (delta.type === 'entity.update') {
        if (this.entities[delta.id]) {
          Object.assign(this.entities[delta.id], delta.data || {});
        } else {
          this.entities[delta.id] = delta.data || {};
        }
      } else if (delta.type === 'entity.remove') {
        delete this.entities[delta.id];
        this.rootIds = this.rootIds.filter(id => id !== delta.id);
      }
    },

    reset() {
      this.entities = {};
      this.rootIds = [];
      this.meta = {};
    },
  };

  // ── Shadow DOM Preview Renderer ────────────────────
  let shadowRoot = null;
  let activeEditElement = null;

  function startInlineEdit(element) {
    if (activeEditElement) return;

    const entityId = element.dataset.entityId;
    const field = element.dataset.field;
    const currentValue = element.textContent;

    activeEditElement = element;
    const originalText = element.textContent;

    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.className = 'editable-input';
    input.style.cssText = 'font: inherit; color: inherit; background: var(--bg-elevated, #fff); border: 1px solid var(--accent, #7C8C6E); border-radius: var(--radius-sm, 6px); padding: 1px 4px; margin: -2px -5px; outline: none; min-width: 60px; width: 100%;';

    element.textContent = '';
    element.appendChild(input);
    input.focus();
    input.select();

    const finishEdit = (save) => {
      if (activeEditElement !== element) return;
      activeEditElement = null;

      const newValue = input.value;
      element.textContent = save ? newValue : originalText;

      if (save && newValue !== originalText) {
        sendDirectEdit(entityId, field, newValue);
      }
    };

    input.addEventListener('blur', () => finishEdit(true));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
      if (e.key === 'Escape') { finishEdit(false); }
    });
  }

  function refreshEntityPreview() {
    const host = document.getElementById('aide-page-content');
    if (!host) return;

    // Initialize shadow root on first render
    if (!shadowRoot) {
      shadowRoot = host.attachShadow({ mode: 'open' });

      // Click handler for links and editable fields
      shadowRoot.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (link && link.href) {
          e.preventDefault();
          window.open(link.href, '_blank');
          return;
        }

        const editable = e.target.closest('.editable-field');
        if (editable && editable.dataset.entityId) {
          e.preventDefault();
          startInlineEdit(editable);
          return;
        }
      });

      // Change handler for checkboxes
      shadowRoot.addEventListener('change', (e) => {
        const checkbox = e.target;
        if (checkbox.type === 'checkbox' && checkbox.dataset.entityId) {
          const entityId = checkbox.dataset.entityId;
          const field = checkbox.dataset.field;
          sendDirectEdit(entityId, field, checkbox.checked);
        }
      });

      // Scroll tracking for sticky section pill
      const scrollContainer = document.getElementById('aide-page-scroll');
      let rafPending = false;
      let prevPillTitle = null;
      scrollContainer.addEventListener('scroll', () => {
        if (rafPending) return;
        rafPending = true;
        requestAnimationFrame(() => {
          rafPending = false;
          const NAV_HEIGHT = 44;
          const threshold = NAV_HEIGHT + 10;
          let currentTitle = null;

          const sections = shadowRoot.querySelectorAll('.aide-section');
          for (const section of sections) {
            const rect = section.getBoundingClientRect();
            if (rect.top < threshold && rect.bottom > threshold + 24) {
              const titleEl = section.querySelector('.aide-section__title');
              if (titleEl) {
                currentTitle = titleEl.textContent.trim();
              }
            }
          }

          if (currentTitle !== prevPillTitle) {
            prevPillTitle = currentTitle;
            const pill = shadowRoot.getElementById('sticky-pill');
            if (pill) {
              const pillInner = pill.querySelector('.aide-pill');
              if (currentTitle && pillInner) {
                pill.style.display = 'flex';
                pillInner.textContent = currentTitle;
              } else {
                pill.style.display = 'none';
              }
            }
          }
        });
      }, { passive: true });
    }

    // Save scroll position
    const scrollContainer = document.getElementById('aide-page-scroll');
    const scrollY = scrollContainer.scrollTop;

    // Build HTML from entity store
    const html = display.renderHtml(entityStore);

    // Render with CSS into shadow DOM
    shadowRoot.innerHTML = `<style>${display.RENDERER_CSS}</style>${html}`;

    // Restore scroll position
    requestAnimationFrame(() => {
      scrollContainer.scrollTop = scrollY;
    });

    // Update nav title
    const navTitle = document.getElementById('nav-title');
    if (navTitle) {
      navTitle.textContent = entityStore.meta.title || 'aide';
    }
  }

  // ── Breakpoint detection ───────────────────────────
  function checkBreakpoint() {
    const wasMobile = isMobile;
    isMobile = window.innerWidth < 768;

    if (wasMobile !== isMobile) {
      // Breakpoint crossed - reinitialize chat UI
      renderChatUI();
    }
  }

  window.addEventListener('resize', checkBreakpoint);

  // ── Chat message rendering ─────────────────────────
  function renderChatMessage(msg, isNew = false) {
    const div = document.createElement('div');
    div.className = `chat-message ${msg.role}`;
    if (isNew) div.style.animation = 'fadeIn 0.2s ease-out';

    if (msg.role === 'assistant') {
      const avatarSize = isMobile ? 20 : 22;
      div.innerHTML = `
        <div class="aide-avatar" style="width:${avatarSize}px;height:${avatarSize}px;">a</div>
        <div class="message-bubble assistant">${escapeHtml(msg.content)}</div>
      `;
    } else {
      div.innerHTML = `
        <div class="message-bubble user">${escapeHtml(msg.content)}</div>
      `;
    }

    return div;
  }

  function renderTypingIndicator() {
    const div = document.createElement('div');
    div.className = 'typing-indicator';
    const avatarSize = isMobile ? 20 : 22;
    div.innerHTML = `
      <div class="aide-avatar" style="width:${avatarSize}px;height:${avatarSize}px;">a</div>
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    `;
    return div;
  }

  // ── Desktop chat panel ─────────────────────────────
  function renderDesktopMessages() {
    const container = document.getElementById('desktop-messages');
    if (!container) return;

    container.innerHTML = '';
    conversationHistory.forEach((msg, i) => {
      container.appendChild(renderChatMessage(msg, i === conversationHistory.length - 1));
    });

    if (isSending) {
      container.appendChild(renderTypingIndicator());
    }

    // Auto-scroll to bottom
    requestAnimationFrame(() => {
      container.scrollTop = container.scrollHeight;
    });
  }

  function toggleDesktopPanel() {
    desktopPanelOpen = !desktopPanelOpen;
    const panel = document.getElementById('desktop-chat-panel');
    const toggleBtn = document.getElementById('chat-toggle-btn');

    if (desktopPanelOpen) {
      panel.classList.remove('closed');
      toggleBtn.classList.add('active');
      setTimeout(() => {
        document.getElementById('desktop-input').focus();
      }, 250);
    } else {
      panel.classList.add('closed');
      toggleBtn.classList.remove('active');
    }
  }

  function handleDesktopSend() {
    const input = document.getElementById('desktop-input');
    const text = input.value.trim();
    if (!text || isSending) return;

    sendMessage(text);
    input.value = '';
    input.style.height = 'auto';
  }

  // ── Mobile bottom sheet ────────────────────────────
  const SNAP = { PEEK: 0, INPUT: 1, HISTORY: 2 };

  function getSnapHeights() {
    const vh = window.innerHeight;
    return [20, 96, Math.round(vh * 0.75)];
  }

  function setSheetHeight(height) {
    const container = document.getElementById('sheet-container');
    if (container) {
      container.style.height = height + 'px';
    }
  }

  function updateSheetState(snap) {
    mobileSnapPosition = snap;
    const snapHeights = getSnapHeights();
    const container = document.getElementById('sheet-container');
    const backdrop = document.getElementById('sheet-backdrop');
    const peekArea = document.getElementById('sheet-peek-area');
    const messages = document.getElementById('sheet-messages');
    const input = document.getElementById('sheet-input');

    setSheetHeight(snapHeights[snap]);

    // Update visual state
    container.className = 'sheet-container';
    if (snap === SNAP.PEEK) {
      container.classList.add('peek');
      backdrop.classList.remove('visible');
      peekArea.classList.remove('visible');
      messages.classList.remove('visible');
      input.classList.remove('visible');
    } else if (snap === SNAP.INPUT) {
      container.classList.add('input');
      backdrop.classList.remove('visible');
      peekArea.classList.remove('visible');
      messages.classList.remove('visible');
      input.classList.add('visible');
    } else if (snap === SNAP.HISTORY) {
      container.classList.add('history');
      backdrop.classList.add('visible');
      peekArea.classList.remove('visible');
      messages.classList.add('visible');
      input.classList.add('visible');
      renderMobileMessages();
      // Auto-scroll to bottom
      requestAnimationFrame(() => {
        const messagesEl = document.getElementById('sheet-messages');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    // Clear peek messages when changing position
    if (snap !== SNAP.INPUT) {
      mobilePeekMessages = [];
    }
  }

  function handleSheetHandleClick() {
    const next = (mobileSnapPosition + 1) % 3;
    updateSheetState(next);
  }

  function handleSheetDragStart(e) {
    const touch = e.touches[0];
    const snapHeights = getSnapHeights();
    mobileDragState = {
      startY: touch.clientY,
      startHeight: snapHeights[mobileSnapPosition],
    };

    const container = document.getElementById('sheet-container');
    container.classList.add('dragging');
  }

  function handleSheetDragMove(e) {
    if (!mobileDragState) return;
    e.preventDefault();

    const touch = e.touches[0];
    const dy = mobileDragState.startY - touch.clientY;
    const newHeight = mobileDragState.startHeight + dy;

    const snapHeights = getSnapHeights();
    const minHeight = 10;
    const maxHeight = snapHeights[SNAP.HISTORY] + 40;
    const clampedHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));

    setSheetHeight(clampedHeight);
  }

  function handleSheetDragEnd() {
    if (!mobileDragState) return;

    const container = document.getElementById('sheet-container');
    container.classList.remove('dragging');

    const snapHeights = getSnapHeights();
    const currentHeight = parseFloat(container.style.height);
    const dy = currentHeight - snapHeights[mobileSnapPosition];

    let nextSnap = mobileSnapPosition;
    if (dy > 15 && mobileSnapPosition < SNAP.HISTORY) {
      nextSnap = mobileSnapPosition + 1;
    } else if (dy < -15 && mobileSnapPosition > SNAP.PEEK) {
      nextSnap = mobileSnapPosition - 1;
    }

    updateSheetState(nextSnap);
    mobileDragState = null;
  }

  function renderMobileMessages() {
    const container = document.getElementById('sheet-messages-content');
    if (!container) return;

    container.innerHTML = '';
    conversationHistory.forEach((msg, i) => {
      container.appendChild(renderChatMessage(msg, i === conversationHistory.length - 1));
    });

    if (isSending) {
      container.appendChild(renderTypingIndicator());
    }
  }

  function renderMobilePeekMessages() {
    const container = document.getElementById('sheet-peek-area');
    if (!container) return;

    container.innerHTML = '';
    mobilePeekMessages.forEach((msg) => {
      container.appendChild(renderChatMessage(msg));
    });

    if (isSending) {
      container.appendChild(renderTypingIndicator());
    }

    // Measure and adjust sheet height
    requestAnimationFrame(() => {
      const peekHeight = container.getBoundingClientRect().height;
      const snapHeights = getSnapHeights();
      const newHeight = snapHeights[SNAP.INPUT] + peekHeight + 4;
      setSheetHeight(newHeight);
    });
  }

  function showMobileToast(text) {
    const toast = document.getElementById('mobile-toast');
    const toastText = document.getElementById('toast-text');

    toastText.textContent = text;
    toast.className = 'visible';

    setTimeout(() => {
      toast.classList.add('hiding');
      setTimeout(() => {
        toast.className = '';
      }, 700);
    }, 2800);
  }

  function handleMobileSend() {
    const input = document.getElementById('mobile-input');
    const text = input.value.trim();
    if (!text || isSending) return;

    const wasHistory = mobileSnapPosition === SNAP.HISTORY;

    if (wasHistory) {
      // Send from history - append inline
      sendMessage(text);
      input.value = '';
      input.style.height = 'auto';
    } else {
      // Send from input - use peek flow
      mobilePeekMessages = [{ role: 'user', content: text }];
      document.getElementById('sheet-peek-area').classList.add('visible');
      renderMobilePeekMessages();

      sendMessage(text);
      input.value = '';
      input.style.height = 'auto';
    }
  }

  function onMobileResponseComplete() {
    // After peek response, collapse and show toast
    if (mobileSnapPosition === SNAP.INPUT && mobilePeekMessages.length > 0) {
      const lastAssistantMsg = conversationHistory.slice().reverse().find(m => m.role === 'assistant');
      if (lastAssistantMsg) {
        setTimeout(() => {
          mobilePeekMessages = [];
          document.getElementById('sheet-peek-area').classList.remove('visible');
          updateSheetState(SNAP.INPUT);
          showMobileToast(lastAssistantMsg.content);
        }, 2200);
      }
    }
  }

  // ── Chat UI rendering ──────────────────────────────
  function renderChatUI() {
    if (isMobile) {
      // Mobile: initialize bottom sheet
      updateSheetState(SNAP.INPUT);

      const handle = document.getElementById('sheet-handle');
      handle.addEventListener('click', handleSheetHandleClick);
      handle.addEventListener('touchstart', handleSheetDragStart);
      handle.addEventListener('touchmove', handleSheetDragMove);
      handle.addEventListener('touchend', handleSheetDragEnd);

      const backdrop = document.getElementById('sheet-backdrop');
      backdrop.addEventListener('click', () => updateSheetState(SNAP.INPUT));

      const mobileInput = document.getElementById('mobile-input');
      mobileInput.addEventListener('input', (e) => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 80) + 'px';
      });
      mobileInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleMobileSend();
        }
      });

      document.getElementById('mobile-send-btn').addEventListener('click', handleMobileSend);
    } else {
      // Desktop: initialize panel
      const toggleBtn = document.getElementById('chat-toggle-btn');
      toggleBtn.addEventListener('click', toggleDesktopPanel);

      if (desktopPanelOpen) {
        document.getElementById('desktop-chat-panel').classList.remove('closed');
        toggleBtn.classList.add('active');
      }

      renderDesktopMessages();

      const desktopInput = document.getElementById('desktop-input');
      desktopInput.addEventListener('input', (e) => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 100) + 'px';
      });
      desktopInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleDesktopSend();
        }
      });

      document.getElementById('desktop-send-btn').addEventListener('click', handleDesktopSend);
      document.getElementById('share-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied'));
      });
    }
  }

  // ── WebSocket Client ────────────────────────────────
  let aideWs = null;
  let wsConnectedAideId = null;

  function connectWebSocket(aideId) {
    if (aideWs && wsConnectedAideId !== aideId) {
      aideWs.close();
      aideWs = null;
    }
    if (aideWs && aideWs.readyState === WebSocket.OPEN) {
      return Promise.resolve();
    }

    const wsId = aideId || 'new';
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${proto}//${location.host}/ws/aide/${wsId}`;

    return new Promise((resolve, reject) => {
      try {
        aideWs = new WebSocket(url);
        wsConnectedAideId = wsId;

        aideWs.onopen = () => {
          console.log('[WS] connected:', url);
          resolve();
        };

        let isHydrating = false;

        aideWs.onmessage = (event) => {
          let msg;
          try { msg = JSON.parse(event.data); } catch { return; }

          if (msg.type === 'snapshot.start') {
            isHydrating = true;
            entityStore.reset();
            console.log('[WS] Hydrating snapshot...');
          } else if (msg.type === 'snapshot.end') {
            isHydrating = false;
            refreshEntityPreview();
            console.log('[WS] Snapshot hydrated:', Object.keys(entityStore.entities).length, 'entities');
          } else if (msg.type === 'stream.start') {
            pendingVoiceResponse = '';
          } else if (msg.type === 'entity.create' || msg.type === 'entity.update' || msg.type === 'entity.remove') {
            entityStore.applyDelta(msg);
            if (!isHydrating) {
              refreshEntityPreview();
            }
          } else if (msg.type === 'meta.update') {
            if (msg.data) {
              entityStore.meta = msg.data;
              if (!isHydrating) {
                refreshEntityPreview();
              }
            }
          } else if (msg.type === 'voice') {
            if (msg.text) {
              pendingVoiceResponse = msg.text;
              const last = conversationHistory[conversationHistory.length - 1];
              if (!last || last.role !== 'assistant' || last.content !== msg.text) {
                conversationHistory.push({ role: 'assistant', content: msg.text });
                if (isMobile && mobileSnapPosition === SNAP.INPUT && mobilePeekMessages.length > 0) {
                  mobilePeekMessages.push({ role: 'assistant', content: msg.text });
                  renderMobilePeekMessages();
                }
                updateChatUI();
              }
            }
          } else if (msg.type === 'direct_edit.error') {
            console.warn('[WS] direct_edit rejected:', msg.error);
          } else if (msg.type === 'stream.interrupted') {
            console.log('[WS] stream interrupted by user');
            setSendingState(false);
            isSending = false;
          } else if (msg.type === 'stream.end') {
            setSendingState(false);
            isSending = false;

            if (currentAideId && (pendingUserMessage || pendingVoiceResponse)) {
              fetch(`/api/aides/${currentAideId}/conversation`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  message: pendingUserMessage,
                  response: pendingVoiceResponse,
                }),
              })
              .then(() => {
                pendingUserMessage = null;
                pendingVoiceResponse = '';
              })
              .catch(err => console.error('Failed to save conversation:', err));
            }

            if (isMobile) {
              onMobileResponseComplete();
            }
          } else if (msg.type === 'stream.error') {
            const errMsg = msg.error || 'Stream error.';
            conversationHistory.push({ role: 'assistant', content: errMsg });
            updateChatUI();
            setSendingState(false);
            isSending = false;
          }
        };

        aideWs.onerror = (err) => {
          console.warn('[WS] error:', err);
          reject(err);
        };

        aideWs.onclose = () => {
          console.log('[WS] disconnected');
          if (wsConnectedAideId === wsId) {
            aideWs = null;
          }
        };
      } catch (err) {
        console.warn('[WS] could not connect:', err);
        aideWs = null;
        reject(err);
      }
    });
  }

  function sendViaWebSocket(content, messageId) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) return false;
    aideWs.send(JSON.stringify({ type: 'message', content, message_id: messageId }));
    return true;
  }

  function sendDirectEdit(entityId, field, value) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) {
      console.warn('[WS] direct_edit: no open connection');
      return;
    }
    aideWs.send(JSON.stringify({ type: 'direct_edit', entity_id: entityId, field, value }));
  }

  // ── Sending messages ───────────────────────────────
  async function sendMessage(text) {
    if (isSending) return;
    if (!text) return;

    isSending = true;
    setSendingState(true);

    conversationHistory.push({ role: 'user', content: text });
    updateChatUI();

    const messageId = 'msg_' + Math.random().toString(36).slice(2, 10);

    if (!currentAideId) {
      try {
        const createRes = await fetch('/api/aides', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: 'Untitled' }),
        });
        if (createRes.ok) {
          const aideData = await createRes.json();
          currentAideId = aideData.id;
          history.replaceState({}, '', `?aide=${aideData.id}`);
          await connectWebSocket(aideData.id);
        } else if (createRes.status === 401) {
          showScreen('auth');
          return;
        }
      } catch (err) {
        console.error('Failed to create aide:', err);
      }
    }

    const sentViaWs = sendViaWebSocket(text, messageId);

    if (sentViaWs) {
      pendingUserMessage = text;
      return;
    }

    // Fallback: HTTP
    const body = {
      aide_id: currentAideId || undefined,
      message: text || ' ',
    };

    try {
      const res = await fetch('/api/message', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.status === 401) { showScreen('auth'); return; }

      const data = await res.json();

      if (!res.ok) {
        conversationHistory.push({ role: 'assistant', content: data.detail || 'Error.' });
        updateChatUI();
        return;
      }

      currentAideId = data.aide_id;
      history.replaceState({}, '', `?aide=${data.aide_id}`);

      if (data.response_text) {
        conversationHistory.push({ role: 'assistant', content: data.response_text });
        updateChatUI();
      }
    } catch (e) {
      conversationHistory.push({ role: 'assistant', content: 'Network error.' });
      updateChatUI();
    } finally {
      isSending = false;
      setSendingState(false);
    }
  }

  function setSendingState(sending) {
    isSending = sending;
    updateChatUI();

    if (!isMobile) {
      const desktopInput = document.getElementById('desktop-input');
      desktopInput.disabled = sending;
    } else {
      const mobileInput = document.getElementById('mobile-input');
      mobileInput.disabled = sending;
    }
  }

  function updateChatUI() {
    if (isMobile) {
      if (mobileSnapPosition === SNAP.HISTORY) {
        renderMobileMessages();
      } else if (mobileSnapPosition === SNAP.INPUT && mobilePeekMessages.length > 0) {
        renderMobilePeekMessages();
      }
    } else {
      renderDesktopMessages();
    }
  }

  // ── Screens ────────────────────────────────────────
  function showScreen(name) {
    document.getElementById('auth-screen').classList.toggle('active', name === 'auth');
    document.getElementById('dashboard').classList.toggle('active', name === 'dashboard');
    document.getElementById('editor').classList.toggle('active', name === 'editor');
  }

  // ── Auth ───────────────────────────────────────────
  async function checkAuth() {
    try {
      const res = await fetch('/auth/me', { credentials: 'include' });
      if (res.ok) {
        currentUser = await res.json();
        const aideId = new URLSearchParams(location.search).get('aide');
        if (aideId) {
          openEditor(aideId);
        } else {
          loadDashboard();
        }
      } else {
        showScreen('auth');
      }
    } catch {
      showScreen('auth');
    }
  }

  document.getElementById('send-link-btn').addEventListener('click', async () => {
    const email = document.getElementById('email-input').value.trim();
    const msg = document.getElementById('auth-msg');
    if (!email) { msg.textContent = 'Enter your email.'; msg.className = 'auth-message error'; return; }

    const btn = document.getElementById('send-link-btn');
    btn.disabled = true;
    msg.textContent = '';

    try {
      const res = await fetch('/auth/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      if (res.ok) {
        document.getElementById('auth-send-form').style.display = 'none';
        document.getElementById('auth-sent-msg').style.display = 'block';
      } else {
        const data = await res.json();
        msg.textContent = data.detail || 'Something went wrong.';
        msg.className = 'auth-message error';
        btn.disabled = false;
      }
    } catch {
      msg.textContent = 'Network error.';
      msg.className = 'auth-message error';
      btn.disabled = false;
    }
  });

  document.getElementById('email-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('send-link-btn').click();
  });

  // ── Dashboard ──────────────────────────────────────
  async function loadDashboard() {
    showScreen('dashboard');
    const grid = document.getElementById('aide-grid');
    const empty = document.getElementById('empty-state');
    grid.innerHTML = '';

    try {
      const res = await fetch('/api/aides', { credentials: 'include' });
      if (!res.ok) { showScreen('auth'); return; }
      const aides = await res.json();

      if (aides.length === 0) {
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      aides.forEach(aide => {
        const card = createAideCard(aide);
        grid.appendChild(card);
      });
    } catch {
      empty.style.display = 'block';
    }
  }

  function createAideCard(aide) {
    const card = document.createElement('div');
    card.className = 'aide-card';

    const updated = new Date(aide.updated_at).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric'
    });

    card.innerHTML = `
      <div class="aide-card-title">${escapeHtml(aide.title)}</div>
      <div class="aide-card-meta">
        <span class="status-badge status-${aide.status}">${aide.status}</span>
        <span>${updated}</span>
      </div>
      <div class="aide-card-actions">
        <button class="icon-btn danger" title="Archive" data-id="${aide.id}">×</button>
      </div>
    `;

    card.addEventListener('click', (e) => {
      if (e.target.closest('.aide-card-actions')) return;
      openEditor(aide.id);
    });

    card.querySelector('.icon-btn.danger').addEventListener('click', async (e) => {
      e.stopPropagation();
      const confirmed = await confirmModal('Archive aide?', `"${aide.title}" will be archived.`, 'Archive');
      if (!confirmed) return;
      await archiveAide(aide.id);
    });

    return card;
  }

  async function archiveAide(aideId) {
    await fetch(`/api/aides/${aideId}/archive`, { method: 'POST', credentials: 'include' });
    loadDashboard();
  }

  function startNewAide() {
    openEditor(null);
  }

  // ── Editor ─────────────────────────────────────────
  async function openEditor(aideId) {
    currentAideId = aideId;
    conversationHistory = [];
    mobilePeekMessages = [];

    entityStore.reset();
    refreshEntityPreview();

    if (aideId) {
      history.replaceState({}, '', `?aide=${aideId}`);

      try {
        const res = await fetch(`/api/aides/${aideId}/history`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          conversationHistory = data.messages || [];
        }
      } catch (e) {
        console.error('Failed to load conversation history:', e);
      }
    }

    showScreen('editor');
    renderChatUI();
    connectWebSocket(aideId);

    if (!isMobile) {
      setTimeout(() => {
        document.getElementById('desktop-input').focus();
      }, 100);
    }
  }

  // ── Modals ─────────────────────────────────────────
  function openModal({ title, desc, body = '', actions }) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-desc').textContent = desc;
    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-actions').innerHTML = actions;
    document.getElementById('modal-overlay').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
  }

  function confirmModal(title, desc, confirmLabel = 'Confirm') {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `
          <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
          <button class="btn btn-danger" id="modal-confirm">${escapeHtml(confirmLabel)}</button>
        `,
      });
      document.getElementById('modal-cancel').onclick = () => { closeModal(); resolve(false); };
      document.getElementById('modal-confirm').onclick = () => { closeModal(); resolve(true); };
    });
  }

  function alertModal(title, desc) {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `<button class="btn btn-primary" id="modal-ok">OK</button>`,
      });
      document.getElementById('modal-ok').onclick = () => { closeModal(); resolve(); };
    });
  }

  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modal-overlay')) closeModal();
  });

  // ── Utils ──────────────────────────────────────────
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // Handle magic link token in URL
  const urlParams = new URLSearchParams(location.search);
  const token = urlParams.get('token');
  if (token) {
    fetch(`/auth/verify?token=${encodeURIComponent(token)}`, { credentials: 'include' })
      .then(res => {
        history.replaceState({}, '', '/');
        if (res.ok) return res.json().then(user => { currentUser = user; loadDashboard(); });
        showScreen('auth');
      })
      .catch(() => showScreen('auth'));
  } else {
    checkAuth();
  }
</script>
</body>
</html>
