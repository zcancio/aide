<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>aide</title>
  <!-- Fonts for renderer display components -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --border: #2a2a2a;
      --text: #e8e8e8;
      --text-muted: #888;
      --accent: #fff;
      --overlay-bg: rgba(0, 0, 0, 0.3);
      --radius: 12px;
      --input-height: 52px;
      --chat-max-width: 640px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* ── DASHBOARD ─────────────────────────────────── */
    #dashboard {
      display: none;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      padding: 40px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    #dashboard.active { display: flex; }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .dashboard-header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.15s, opacity 0.15s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #7C8C6E; color: #F7F5F2; }
    .btn-primary:hover:not(:disabled) { background: #667358; }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); color: var(--text); }
    .btn-danger { background: transparent; color: #e55; border: 1px solid #e55; }
    .btn-danger:hover { background: rgba(238,85,85,0.1); }

    .aide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .aide-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      position: relative;
    }

    .aide-card:hover { border-color: #444; background: #202020; }

    .aide-card-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 60px;
    }

    .aide-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .status-draft { background: #2a2a2a; color: #888; }
    .status-published { background: rgba(80, 200, 120, 0.15); color: #5c8; }
    .status-archived { background: rgba(255, 100, 100, 0.1); color: #e66; }

    .aide-card-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .aide-card:hover .aide-card-actions { opacity: 1; }

    .icon-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: var(--border);
      color: var(--text-muted);
      font-size: 13px;
      transition: background 0.15s, color 0.15s;
    }

    .icon-btn:hover { background: #333; color: var(--text); }
    .icon-btn.danger:hover { background: rgba(238,85,85,0.2); color: #e55; }

    .empty-state {
      text-align: center;
      padding: 80px 0;
      color: var(--text-muted);
    }

    .empty-state p { margin-bottom: 20px; font-size: 15px; }

    /* ── EDITOR (preview + chat) ────────────────────── */
    #editor {
      display: none;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    #editor.active { display: block; }

    /* Full-viewport inline preview (host element for Shadow DOM) */
    #preview-root {
      width: 100%;
      height: 100%;
      overflow-y: auto;
      background: #fff;
      position: relative;
      padding-bottom: 100px;
    }

    /* Floating chat overlay */
    #chat-overlay {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: min(var(--chat-max-width), calc(100vw - 32px));
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: transparent;
      border-radius: var(--radius);
    }

    /* Conversation history (expandable) */
    #history-panel {
      background: rgba(20, 20, 20, 0.9);
      border-radius: var(--radius) var(--radius) 0 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease, padding 0.25s ease;
    }

    #history-panel.open {
      max-height: 160px;
      overflow-y: auto;
      padding: 12px 16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #history-panel::-webkit-scrollbar {
      display: none;
    }

    #history-panel.open + #input-bar {
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0 0 var(--radius) var(--radius);
    }

    .history-message {
      margin-bottom: 8px;
      display: flex;
    }

    .history-message:last-child { margin-bottom: 0; }

    .history-message.user {
      justify-content: flex-end;
    }

    .history-message.assistant {
      justify-content: flex-start;
    }

    .history-content {
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 85%;
    }

    .history-message.user .history-content {
      background: rgba(60, 60, 60, 0.6);
      color: var(--text);
      border-bottom-right-radius: 4px;
    }

    .history-message.assistant .history-content {
      background: rgba(30, 30, 30, 0.6);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    /* Input bar */
    #input-bar {
      background: rgba(20, 20, 20, 0.9);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Image preview strip */
    #image-preview-strip {
      display: none;
      padding: 8px 12px 0;
      gap: 8px;
      flex-wrap: wrap;
    }

    #image-preview-strip.has-image { display: flex; }

    .image-thumb {
      position: relative;
      width: 56px;
      height: 56px;
    }

    .image-thumb img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .image-thumb-remove {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #333;
      border: 1px solid var(--border);
      color: #fff;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    /* Row: text + actions */
    .input-row {
      display: flex;
      align-items: flex-end;
      padding: 8px 10px;
      gap: 8px;
      min-height: var(--input-height);
    }

    #message-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.5;
      padding: 6px 0;
      scrollbar-width: thin;
    }

    #message-input::placeholder { color: var(--text-muted); }

    .input-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .action-btn {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      font-size: 16px;
      transition: background 0.15s, color 0.15s;
    }

    .action-btn:hover { background: var(--border); color: var(--text); }
    .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    #send-btn {
      background: #7C8C6E;         /* sage-500 */
      color: #F7F5F2;              /* warm white */
      border-radius: 8px;
    }

    #send-btn:hover:not(:disabled) { background: #667358; }  /* sage-600 */

    /* Thinking indicator */
    #thinking-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 12px;
    }

    #thinking-indicator.visible { display: flex; }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: thinking-bounce 1.4s infinite ease-in-out both;
    }

    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes thinking-bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Back button (editor toolbar) */
    #editor-back {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 200;
      background: rgba(20, 20, 20, 0.9);
      border: none;
      border-radius: var(--radius);
      width: 36px;
      height: 36px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      transition: background 0.15s;
    }

    #editor-back.visible { display: flex; }
    #editor-back:hover { background: rgba(30, 30, 30, 0.95); }

    /* Publish button (editor toolbar) */
    #publish-btn-floating {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 200;
      background: rgba(20, 20, 20, 0.9);
      border: none;
      border-radius: var(--radius);
      padding: 8px 16px;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: none;
      align-items: center;
      transition: background 0.15s;
    }

    #publish-btn-floating.visible { display: flex; }
    #publish-btn-floating:hover { background: rgba(30, 30, 30, 0.95); }

    /* ── FAB (floating action button) ── */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: #7C8C6E;          /* sage-500 */
      border: none;
      color: #F7F5F2;               /* text-inverse (warm white) */
      font-size: 24px;
      font-weight: 300;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: background 0.15s ease, transform 0.15s ease;
      z-index: 50;
    }

    .fab:hover {
      background: #667358;          /* sage-600 */
      transform: scale(1.05);
    }

    #new-aide-fab {
      display: none;
    }

    #dashboard.active #new-aide-fab {
      display: flex;
    }

    @media (max-width: 767px) {
      .fab {
        bottom: 20px;
        right: 16px;
        width: 48px;
        height: 48px;
        font-size: 22px;
      }
    }

    /* ── AUTH ───────────────────────────────────────── */
    #auth-screen {
      display: none;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      gap: 0;
    }

    #auth-screen.active { display: flex; }

    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: -12px;
    }

    .auth-form { display: flex; flex-direction: column; gap: 12px; }

    .form-input {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }

    .form-input:focus { border-color: #555; }
    .form-input::placeholder { color: var(--text-muted); }

    .auth-message {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      min-height: 20px;
    }

    .auth-message.error { color: #e66; }
    .auth-message.success { color: #5c8; }

    /* ── MODAL ──────────────────────────────────────── */
    #modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 360px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-desc { font-size: 13px; color: var(--text-muted); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }

    /* ── DRAG OVERLAY ───────────────────────────────── */
    #drag-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.04);
      border: 2px dashed #555;
      border-radius: 12px;
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #888;
      pointer-events: none;
    }

    #drag-overlay.active { display: flex; }

    /* Mount animation for progressive entity rendering */
    @keyframes entity-mount {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .entity-new {
      animation: entity-mount 200ms ease-out;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  </style>
  <!-- CSS from renderer.py (source of truth for styling) -->
  <script id="renderer-css-template" type="text/template">
/* Import fonts for shadow DOM */
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap');

/* CSS custom properties - scoped to preview root */
:host {
  /* Design system defaults */
  --font-serif: 'Playfair Display', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --font-heading: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --text-primary: #2D2D2A;
  --text-secondary: #6B6963;
  --text-tertiary: #A8A5A0;
  --text-inverse: #F7F5F2;
  --bg-primary: #F7F5F2;
  --bg-secondary: #EFECEA;
  --bg-tertiary: #E6E3DF;
  --bg-elevated: #FFFFFF;
  /* Sage accent scale */
  --sage-50: #F0F3ED;
  --sage-100: #DDE4D7;
  --sage-200: #C2CCB8;
  --sage-300: #A3B394;
  --sage-400: #8B9E7C;
  --sage-500: #7C8C6E;
  --sage-600: #667358;
  --sage-700: #515C46;
  --sage-800: #3C4534;
  --sage-900: #282E23;
  --accent: var(--sage-500);
  --accent-hover: var(--sage-600);
  --accent-subtle: var(--sage-50);
  --accent-muted: var(--sage-100);
  --border-subtle: #E0DDD8;
  --border-default: #D4D1CC;
  --border-strong: #A8A5A0;
  --border: var(--border-default);
  --border-light: var(--border-subtle);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 16px;
  --radius-full: 999px;
  /* Spacing scale */
  --space-0: 0px;
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
  --space-6: 24px;
  --space-7: 32px;
  --space-8: 40px;
  --space-9: 48px;
  --space-10: 56px;
  --space-11: 64px;
  --space-12: 80px;
  --space-13: 96px;
  --space-14: 112px;
  --space-15: 128px;
  --space-16: 160px;
}

/* ── Base ── */
:host *, :host *::before, :host *::after { box-sizing: border-box; }

:host {
  font-family: var(--font-sans);
  font-size: 16px;
  font-weight: 400;
  line-height: 1.65;
  color: var(--text-primary);
  background: var(--bg-primary);
  -webkit-font-smoothing: antialiased;
}

:host .aide-page {
  max-width: 720px;
  margin: 0 auto;
  padding: 80px 40px;
}

@media (max-width: 640px) {
  :host .aide-page {
    padding: 40px 20px;
  }
}

@media (prefers-reduced-motion: reduce) {
  :host *, :host *::before, :host *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* ── Headings ── */
:host .aide-heading { margin-bottom: var(--space-4); }
:host .aide-heading--1 {
  font-family: var(--font-serif);
  font-size: clamp(36px, 4.5vw, 42px);
  font-weight: 700;
  line-height: 1.2;
  color: var(--text-primary);
}
:host .aide-heading--2 {
  font-family: var(--font-serif);
  font-size: clamp(28px, 3.5vw, 32px);
  font-weight: 700;
  line-height: 1.25;
  color: var(--text-primary);
}
:host .aide-heading--3 {
  font-family: var(--font-heading);
  font-size: 18px;
  font-weight: 600;
  line-height: 1.4;
  color: var(--text-primary);
}

/* ── Text ── */
:host .aide-text {
  font-family: var(--font-sans);
  font-size: 16px;
  font-weight: 400;
  line-height: 1.65;
  color: var(--text-secondary);
  margin-bottom: var(--space-4);
}
:host .aide-text a {
  color: var(--accent);
  text-decoration: underline;
  text-decoration-color: var(--border);
  text-underline-offset: 2px;
}
:host .aide-text a:hover {
  text-decoration-color: var(--accent);
}

/* ── Metric ── */
:host .aide-metric {
  display: flex;
  align-items: baseline;
  gap: var(--space-2);
  padding: var(--space-3) 0;
}
:host .aide-metric__label {
  font-family: var(--font-sans);
  font-size: 15px;
  font-weight: 400;
  color: var(--text-secondary);
}
:host .aide-metric__label::after { content: ':'; }
:host .aide-metric__value {
  font-family: var(--font-sans);
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ── Divider ── */
:host .aide-divider {
  border: none;
  border-top: 1px solid var(--border-light);
  margin: var(--space-6) 0;
}

/* ── Image ── */
:host .aide-image { margin: var(--space-6) 0; }
:host .aide-image img { max-width: 100%; height: auto; border-radius: var(--radius-sm); }
:host .aide-image__caption {
  font-size: 13px;
  color: var(--text-tertiary);
  margin-top: var(--space-2);
}

/* ── Callout ── */
:host .aide-callout {
  background: var(--bg-secondary);
  border-left: 3px solid var(--border);
  padding: var(--space-4) var(--space-5);
  margin: var(--space-4) 0;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  font-size: 15px;
  line-height: 1.55;
  color: var(--text-secondary);
}

/* ── Columns ── */
:host .aide-columns {
  display: flex;
  gap: var(--space-6);
}
@media (max-width: 640px) {
  :host .aide-columns {
    flex-direction: column;
  }
}

/* ── Empty states ── */
:host .aide-empty {
  color: var(--text-tertiary);
  font-size: 15px;
  padding: var(--space-16) 0;
  text-align: center;
}
:host .aide-collection-empty {
  color: var(--text-tertiary);
  font-size: 14px;
  padding: var(--space-4) 0;
}

/* ── Highlight ── */
:host .aide-highlight {
  background-color: var(--accent-subtle);
}

/* ── List view ── */
:host .aide-list {
  list-style: none;
  padding: 0;
}
:host .aide-list__item {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 12px;
  padding: var(--space-3) 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 15px;
  line-height: 1.5;
}
:host .aide-list__item:last-child { border-bottom: none; }
:host .aide-list__left {
  color: var(--text-secondary);
}
:host .aide-list__right {
  font-weight: 500;
  color: var(--text-primary);
}

/* ── Table view ── */
:host .aide-table-wrap {
  overflow-x: auto;
  margin: var(--space-4) 0;
}
:host .aide-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 15px;
}
:host .aide-table__th {
  font-family: var(--font-sans);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  text-align: left;
  padding: var(--space-2) var(--space-3);
  border-bottom: 2px solid var(--border);
}
:host .aide-table__td {
  padding: var(--space-3);
  border-bottom: 1px solid var(--border-light);
  color: var(--text-secondary);
  vertical-align: top;
}
:host .aide-table__td--bool { text-align: center; }
:host .aide-table__td--int,
:host .aide-table__td--float { text-align: right; font-variant-numeric: tabular-nums; }

/* ── Grid view ── */
:host .aide-grid {
  border-collapse: collapse;
  font-size: 13px;
}
:host .aide-grid__col-label,
:host .aide-grid__row-label {
  font-weight: 500;
  color: var(--text-tertiary);
  padding: var(--space-2);
  text-align: center;
}
:host .aide-grid__cell {
  border: 1px solid var(--border-light);
  padding: var(--space-2);
  text-align: center;
  min-width: 48px;
  min-height: 48px;
  vertical-align: middle;
}
:host .aide-grid__cell--filled {
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 500;
}
:host .aide-grid__cell--empty {
  color: var(--text-tertiary);
}

/* ── Group headers ── */
:host .aide-group { margin-bottom: var(--space-6); }
:host .aide-group__header {
  font-family: var(--font-sans);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--text-tertiary);
  margin-bottom: var(--space-3);
  padding-bottom: var(--space-2);
  border-bottom: 1px solid var(--border-light);
}

/* ── Annotations ── */
:host .aide-annotations { margin-top: var(--space-10); }
:host .aide-annotation {
  padding: var(--space-3) 0;
  border-bottom: 1px solid var(--border-light);
}
:host .aide-annotation:last-child { border-bottom: none; }
:host .aide-annotation__text {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.5;
}
:host .aide-annotation__meta {
  font-size: 12px;
  color: var(--text-tertiary);
  margin-left: var(--space-3);
}
:host .aide-annotation--pinned {
  border-left: 3px solid var(--accent);
  padding-left: var(--space-4);
}

/* ── Footer ── */
:host .aide-footer {
  margin-top: var(--space-16);
  padding-top: var(--space-6);
  border-top: 1px solid var(--border-light);
  font-size: 12px;
  color: var(--text-tertiary);
  text-align: center;
}
:host .aide-footer__link {
  color: var(--text-tertiary);
  text-decoration: none;
}
:host .aide-footer__link:hover {
  color: var(--text-secondary);
}

/* ── Card (React component) ── */
:host .aide-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  padding: var(--space-4);
  margin-bottom: var(--space-3);
}
:host .aide-card__title {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: var(--space-2);
}
:host .aide-card__field {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: var(--space-1) 0;
  border-bottom: 1px solid var(--border-light);
  gap: var(--space-3);
}
:host .aide-card__field:last-child { border-bottom: none; }
:host .aide-card__label {
  color: var(--text-tertiary);
  font-size: 12px;
  text-transform: capitalize;
  flex-shrink: 0;
}

/* ── Section (React component) ── */
:host .aide-section {
  margin-bottom: var(--space-6);
}
:host .aide-section__header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  cursor: pointer;
  padding: var(--space-1) 0;
  user-select: none;
}
:host .aide-section__icon {
  color: var(--text-tertiary);
  font-size: 12px;
  width: 14px;
  text-align: center;
  transition: transform 0.2s;
}
:host .aide-section__icon--collapsed {
  transform: rotate(-90deg);
}
:host .aide-section__title {
  font-family: var(--font-serif);
  font-size: clamp(28px, 3.5vw, 32px);
  font-weight: 700;
  line-height: 1.25;
  color: var(--text-primary);
}
:host .aide-section__content {
  margin-top: var(--space-3);
}
:host .aide-section__content--collapsed {
  display: none;
}

/* ── Checklist (React component) ── */
:host .aide-checklist {
  list-style: none;
  padding: 0;
  margin-bottom: var(--space-4);
}
:host .aide-checklist__item {
  display: flex;
  align-items: flex-start;
  gap: var(--space-3);
  padding: var(--space-3) 0;
  border-bottom: 1px solid var(--border-light);
  font-size: 15px;
  line-height: 1.5;
}
:host .aide-checklist__item:last-child { border-bottom: none; }
:host .aide-checklist__checkbox {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: var(--accent);
  flex-shrink: 0;
  margin-top: 2px;
}
:host .aide-checklist__label {
  font-weight: 500;
  color: var(--text-primary);
}
:host .aide-checklist__label--done {
  text-decoration: line-through;
  color: var(--text-tertiary);
}
:host .aide-checklist__summary {
  font-size: 13px;
  color: var(--text-tertiary);
  padding-top: var(--space-2);
}

/* ── Editable field (React component) ── */
:host .editable-field {
  cursor: text;
  border-radius: 2px;
  padding: 1px 2px;
  margin: -1px -2px;
  transition: background-color 0.15s;
}
:host .editable-field:hover {
  background-color: rgba(0, 0, 0, 0.04);
}
:host .editable-field--empty {
  color: var(--text-tertiary);
}
:host .editable-input {
  font: inherit;
  color: inherit;
  background: var(--bg-elevated);
  border: 1px solid var(--accent);
  border-radius: var(--radius-sm);
  padding: 1px 4px;
  margin: -2px -5px;
  outline: none;
  min-width: 60px;
}

/* ── Mount animation ── */
:host .aide-mount-animation {
  animation: aide-fade-in 0.2s ease-out;
}
@keyframes aide-fade-in {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ── Legacy editable support (for vanilla JS fallback) ── */
:host .editable-value {
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  display: inline;
}
:host .editable-value:hover {
  background: rgba(0, 0, 0, 0.04);
}

/* ── Fallback entity renderer ── */
:host .fb-entity {
  border-left: 2px solid var(--border);
  padding: 8px 0 8px 12px;
  margin: 4px 0;
}
:host .fb-header {
  display: flex;
  gap: 8px;
  align-items: baseline;
  margin-bottom: 4px;
}
:host .fb-id {
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 12px;
}
:host .fb-display {
  font-size: 11px;
  color: var(--text-tertiary);
}
:host .fb-props {
  display: grid;
  grid-template-columns: max-content 1fr;
  gap: 2px 12px;
  font-size: 12px;
  color: var(--text-secondary);
}
:host dt {
  font-weight: 500;
  color: var(--text-secondary);
}
:host dd {
  color: var(--text-secondary);
  word-break: break-word;
}
  </script>
  <!-- React for inline preview rendering -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
</head>
<body>

<!-- Auth screen -->
<div id="auth-screen">
  <div class="auth-card">
    <div>
      <div class="auth-title">aide</div>
      <div class="auth-subtitle">Sign in to continue.</div>
    </div>
    <div id="auth-send-form" class="auth-form">
      <input id="email-input" class="form-input" type="email" placeholder="you@example.com" autocomplete="email" />
      <button id="send-link-btn" class="btn btn-primary" style="width:100%;justify-content:center;">Send magic link</button>
      <p id="auth-msg" class="auth-message"></p>
    </div>
    <div id="auth-sent-msg" style="display:none;text-align:center;">
      <p style="color:var(--text-muted);font-size:13px;">Check your email — link sent.</p>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <h1>aide</h1>
  </div>
  <div id="aide-grid" class="aide-grid"></div>
  <div id="empty-state" class="empty-state" style="display:none;">
    <p>Nothing yet.</p>
    <button class="btn btn-ghost" onclick="startNewAide()">Create your first aide</button>
  </div>
  <button id="new-aide-fab" class="fab" onclick="startNewAide()" title="New aide">+</button>
</div>

<!-- Editor -->
<button id="editor-back">←</button>
<button id="publish-btn-floating">Publish</button>

<div id="editor">
  <!-- Inline preview div - replaces iframe for real-time React rendering -->
  <div id="preview-root"></div>

  <div id="chat-overlay">
    <div id="history-panel"></div>
    <div id="input-bar">
      <div id="image-preview-strip"></div>
      <div id="thinking-indicator">
        <div class="thinking-dots"><span></span><span></span><span></span></div>
        <span id="thinking-text">Thinking</span>
      </div>
      <div class="input-row">
        <textarea
          id="message-input"
          rows="1"
          placeholder="Tell aide what you're living…"
        ></textarea>
        <div class="input-actions">
          <button id="image-btn" class="action-btn" title="Attach image">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>
          <input id="image-file-input" type="file" accept="image/jpeg,image/png,image/webp,image/heic" style="display:none;" />
          <button id="stop-btn" class="action-btn" title="Stop" style="display:none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <rect x="6" y="6" width="12" height="12" rx="2"/>
            </svg>
          </button>
          <button id="send-btn" class="action-btn" title="Send">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2 21L23 12 2 3v7l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drag overlay -->
<div id="drag-overlay">Drop image here</div>

<!-- Modal -->
<div id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-desc" id="modal-desc"></div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────
  let currentUser = null;
  let currentAideId = null;
  let pendingImage = null; // { dataUrl, base64 }
  let conversationHistory = []; // {role, content}
  let isSending = false;
  let pendingPreviewUrl = null; // Server-rendered preview to load when stream ends
  let pendingUserMessage = null; // Track user message for stream persistence
  let pendingVoiceResponse = ''; // Accumulate voice response for stream persistence

  // ── Entity Store ────────────────────────────────────
  // Holds the live entity graph populated by WebSocket deltas.
  const entityStore = {
    entities: {},   // id → entity data
    rootIds: [],    // top-level entity IDs (parent === 'root' or no parent)
    meta: {},       // page metadata (title, description, etc.)

    applyDelta(delta) {
      if (delta.type === 'entity.create') {
        this.entities[delta.id] = delta.data || {};
        const parent = (delta.data || {}).parent;
        if (!parent || parent === 'root') {
          if (!this.rootIds.includes(delta.id)) {
            this.rootIds.push(delta.id);
          }
        }
      } else if (delta.type === 'entity.update') {
        if (this.entities[delta.id]) {
          Object.assign(this.entities[delta.id], delta.data || {});
        } else {
          this.entities[delta.id] = delta.data || {};
        }
      } else if (delta.type === 'entity.remove') {
        delete this.entities[delta.id];
        this.rootIds = this.rootIds.filter(id => id !== delta.id);
      }
      // Update progress indicator with entity count
      updateStreamProgress();
    },

    getChildren(parentId) {
      return Object.entries(this.entities)
        .filter(([, e]) => e.parent === parentId)
        .map(([id]) => id);
    },

    reset() {
      this.entities = {};
      this.rootIds = [];
      this.meta = {};
    },
  };

  // ── React Display Components (inline preview) ─────────────────────────────
  // Matches docs/eng_design/04_display_components.md
  const { useState, useContext, createContext, useMemo } = React;

  // ── Entity Context ────────────────────────────────────
  const EntityContext = createContext({ entities: {}, meta: {}, rootIds: [] });

  function useEntity(id) {
    const { entities } = useContext(EntityContext);
    return entities[id] || null;
  }

  function useChildren(parentId) {
    const { entities } = useContext(EntityContext);
    return Object.entries(entities)
      .filter(([, e]) => e.parent === parentId)
      .map(([id]) => id);
  }

  function useMeta() {
    const { meta } = useContext(EntityContext);
    return meta;
  }

  function useRootIds() {
    const { rootIds } = useContext(EntityContext);
    return rootIds;
  }

  // ── Helpers ────────────────────────────────────────────
  function humanize(str) {
    if (!str) return '';
    return str.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function getDisplayableProps(props) {
    if (!props) return {};
    const skip = new Set(['title', 'name', '_removed', '_styles', '_pos', '_schema', '_shape']);
    return Object.fromEntries(
      Object.entries(props).filter(([k]) => !k.startsWith('_') && !skip.has(k))
    );
  }

  function inferType(value) {
    if (typeof value === 'boolean') return 'boolean';
    if (typeof value === 'number') return 'number';
    if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) return 'date';
    return 'string';
  }

  function formatValue(value, type) {
    if (value === null || value === undefined) return '—';
    if (type === 'boolean') return value ? '✓' : '○';
    if (type === 'date' && typeof value === 'string') {
      try {
        const d = new Date(value);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      } catch { return value; }
    }
    return String(value);
  }

  function deriveColumns(children, entities) {
    const cols = new Set();
    const skip = new Set(['_pos', '_schema', '_shape']);
    children.forEach(id => {
      const entity = entities[id];
      const props = entity?.props || {};
      Object.keys(props).filter(k => !k.startsWith('_') && !skip.has(k)).forEach(k => cols.add(k));
    });
    return Array.from(cols);
  }

  function applyStyles(styles) {
    if (!styles) return {};
    const css = {};
    if (styles.bg_color) css.backgroundColor = styles.bg_color;
    if (styles.text_color) css.color = styles.text_color;
    return css;
  }

  // ── EditableField ──────────────────────────────────────
  function EditableField({ entityId, field, value, type = 'string', className = '' }) {
    const [editing, setEditing] = useState(false);
    const [draft, setDraft] = useState(value ?? '');

    const emitUpdate = (newValue) => {
      // Send direct edit via WebSocket
      sendDirectEdit(entityId, field, newValue);
    };

    // Booleans toggle immediately
    if (type === 'boolean') {
      return React.createElement('input', {
        type: 'checkbox',
        className: 'aide-checklist__checkbox',
        checked: !!value,
        onChange: () => emitUpdate(!value)
      });
    }

    if (!editing) {
      const displayValue = formatValue(value, type);
      const isEmpty = value === null || value === undefined || value === '';
      return React.createElement('span', {
        className: 'editable-field ' + (isEmpty ? 'editable-field--empty ' : '') + className,
        onClick: () => { setDraft(value ?? ''); setEditing(true); }
      }, displayValue);
    }

    return React.createElement('input', {
      type: type === 'number' ? 'number' : type === 'date' ? 'date' : 'text',
      className: 'editable-input',
      value: draft,
      autoFocus: true,
      onChange: (e) => setDraft(e.target.value),
      onBlur: () => {
        setEditing(false);
        if (draft !== value) {
          const coerced = type === 'number' ? Number(draft) : draft;
          emitUpdate(coerced);
        }
      },
      onKeyDown: (e) => {
        if (e.key === 'Enter') e.target.blur();
        if (e.key === 'Escape') { setDraft(value ?? ''); setEditing(false); }
      }
    });
  }

  // ── Display Components ─────────────────────────────────

  function PageDisplay({ entity, entityId, children }) {
    const props = entity?.props || {};
    const title = props.title || props.name || '';
    return React.createElement('div', { className: 'aide-page aide-mount-animation' },
      title && React.createElement('h1', { className: 'aide-heading aide-heading--1' },
        React.createElement(EditableField, { entityId, field: 'title', value: title })
      ),
      children || React.createElement('p', { className: 'aide-empty' }, 'Say something to get started.')
    );
  }

  function SectionDisplay({ entity, entityId, children }) {
    const [collapsed, setCollapsed] = useState(false);
    const props = entity?.props || {};
    const title = props.title || props.name || 'Section';

    return React.createElement('div', { className: 'aide-section aide-mount-animation' },
      React.createElement('div', {
        className: 'aide-section__header',
        onClick: () => setCollapsed(!collapsed)
      },
        React.createElement('span', {
          className: 'aide-section__icon' + (collapsed ? ' aide-section__icon--collapsed' : '')
        }, '▾'),
        React.createElement('span', { className: 'aide-section__title' },
          React.createElement(EditableField, { entityId, field: 'title', value: title })
        )
      ),
      React.createElement('div', {
        className: 'aide-section__content' + (collapsed ? ' aide-section__content--collapsed' : '')
      }, children || React.createElement('p', { className: 'aide-collection-empty' }, 'No items yet.'))
    );
  }

  function CardDisplay({ entity, entityId, children }) {
    const props = entity?.props || {};
    const title = props.title || props.name || '';
    const displayProps = getDisplayableProps(props);
    const styles = applyStyles(entity?._styles);

    return React.createElement('div', { className: 'aide-card aide-mount-animation', style: styles },
      title && React.createElement('div', { className: 'aide-card__title' },
        React.createElement(EditableField, { entityId, field: props.title !== undefined ? 'title' : 'name', value: title })
      ),
      Object.entries(displayProps).map(([key, value]) =>
        React.createElement('div', { key, className: 'aide-card__field' },
          React.createElement('span', { className: 'aide-card__label' }, humanize(key)),
          React.createElement(EditableField, { entityId, field: key, value, type: inferType(value) })
        )
      ),
      children
    );
  }

  function ListDisplay({ entity, entityId, children }) {
    const props = entity?.props || {};
    const title = props.title || props.name || '';

    return React.createElement('div', { className: 'aide-mount-animation' },
      title && React.createElement('h3', { className: 'aide-heading aide-heading--3' },
        React.createElement(EditableField, { entityId, field: 'title', value: title })
      ),
      React.createElement('ul', { className: 'aide-list' },
        children || React.createElement('li', { className: 'aide-collection-empty' }, 'No items yet.')
      )
    );
  }

  function TableDisplay({ entity, entityId, children }) {
    const { entities } = useContext(EntityContext);
    const childIds = useChildren(entityId);
    const props = entity?.props || {};
    const title = props.title || props.name || '';

    if (childIds.length === 0) {
      return React.createElement(CardDisplay, { entity, entityId, children });
    }

    const columns = deriveColumns(childIds, entities);

    return React.createElement('div', { className: 'aide-mount-animation' },
      title && React.createElement('h3', { className: 'aide-heading aide-heading--3' },
        React.createElement(EditableField, { entityId, field: 'title', value: title })
      ),
      React.createElement('div', { className: 'aide-table-wrap' },
        React.createElement('table', { className: 'aide-table' },
          React.createElement('thead', null,
            React.createElement('tr', null,
              columns.map(col =>
                React.createElement('th', { key: col, className: 'aide-table__th' }, humanize(col))
              )
            )
          ),
          React.createElement('tbody', null,
            childIds.map(cid => {
              const child = entities[cid];
              const cp = child?.props || {};
              return React.createElement('tr', { key: cid, className: 'aide-mount-animation' },
                columns.map(col =>
                  React.createElement('td', { key: col, className: 'aide-table__td aide-table__td--' + inferType(cp[col]) },
                    React.createElement(EditableField, { entityId: cid, field: col, value: cp[col], type: inferType(cp[col]) })
                  )
                )
              );
            })
          )
        )
      )
    );
  }

  function ChecklistDisplay({ entity, entityId, children }) {
    const { entities } = useContext(EntityContext);
    const childIds = useChildren(entityId);
    const props = entity?.props || {};
    const title = props.title || props.name || '';

    if (childIds.length === 0) {
      return React.createElement(CardDisplay, { entity, entityId, children });
    }

    const completed = childIds.filter(cid => {
      const cp = entities[cid]?.props || {};
      return cp.done === true || cp.checked === true || cp.completed === true;
    }).length;

    return React.createElement('div', { className: 'aide-mount-animation' },
      title && React.createElement('h3', { className: 'aide-heading aide-heading--3' },
        React.createElement(EditableField, { entityId, field: 'title', value: title })
      ),
      React.createElement('div', { className: 'aide-checklist' },
        childIds.map(cid => {
          const child = entities[cid];
          const cp = child?.props || {};
          const done = cp.done === true || cp.checked === true || cp.completed === true;
          const label = cp.task || cp.label || cp.name || cid;
          const labelField = cp.task !== undefined ? 'task' : (cp.label !== undefined ? 'label' : 'name');

          return React.createElement('div', { key: cid, className: 'aide-checklist__item aide-mount-animation' },
            React.createElement(EditableField, { entityId: cid, field: 'done', value: done, type: 'boolean' }),
            React.createElement('span', {
              className: 'aide-checklist__label' + (done ? ' aide-checklist__label--done' : '')
            },
              React.createElement(EditableField, { entityId: cid, field: labelField, value: label })
            )
          );
        })
      ),
      React.createElement('div', { className: 'aide-checklist__summary' },
        completed + ' of ' + childIds.length + ' complete'
      )
    );
  }

  function MetricDisplay({ entity, entityId }) {
    const props = entity?.props || {};
    const value = props.value ?? props.count ?? props.total ?? '';
    const label = props.label || props.name || '';
    const styles = applyStyles(entity?._styles);

    return React.createElement('div', { className: 'aide-metric aide-mount-animation', style: styles },
      React.createElement('span', { className: 'aide-metric__label' }, label),
      React.createElement('span', { className: 'aide-metric__value' },
        React.createElement(EditableField, { entityId, field: 'value', value, type: inferType(value) })
      )
    );
  }

  function TextDisplay({ entity, entityId }) {
    const props = entity?.props || {};
    const text = props.text || props.content || props.body || '';
    const field = props.text !== undefined ? 'text' : (props.content !== undefined ? 'content' : 'body');

    return React.createElement('p', { className: 'aide-text aide-mount-animation' },
      React.createElement(EditableField, { entityId, field, value: text })
    );
  }

  function ImageDisplay({ entity, entityId }) {
    const props = entity?.props || {};
    const src = props.src || props.url || '';
    const caption = props.caption || '';

    return React.createElement('figure', { className: 'aide-image aide-mount-animation' },
      src && React.createElement('img', { src, alt: caption, loading: 'lazy' }),
      caption && React.createElement('figcaption', { className: 'aide-image__caption' },
        React.createElement(EditableField, { entityId, field: 'caption', value: caption })
      )
    );
  }

  function FallbackDisplay({ entity, entityId, children }) {
    const props = entity?.props || {};
    const displayProps = Object.entries(props).filter(([k]) => !k.startsWith('_'));

    return React.createElement('div', { className: 'aide-card aide-mount-animation' },
      displayProps.map(([key, value]) =>
        React.createElement('div', { key, className: 'aide-card__field' },
          React.createElement('span', { className: 'aide-card__label' }, humanize(key)),
          React.createElement(EditableField, { entityId, field: key, value, type: inferType(value) })
        )
      ),
      children
    );
  }

  // ── Display Resolution ─────────────────────────────────
  const DISPLAY_COMPONENTS = {
    page: PageDisplay,
    section: SectionDisplay,
    card: CardDisplay,
    list: ListDisplay,
    table: TableDisplay,
    checklist: ChecklistDisplay,
    metric: MetricDisplay,
    text: TextDisplay,
    image: ImageDisplay
  };

  function resolveDisplay(entity, childIds, entities) {
    const hint = (entity?.display || '').toLowerCase();
    if (DISPLAY_COMPONENTS[hint]) return DISPLAY_COMPONENTS[hint];

    // Heuristics based on props and children
    const props = entity?.props || {};

    // Image
    if (props.src || props.url) return ImageDisplay;

    // Checklist items have done/checked/completed - leaf nodes
    if (typeof props.done === 'boolean' || typeof props.checked === 'boolean' || typeof props.completed === 'boolean') {
      return CardDisplay;
    }

    // Metric (few fields with value/count)
    if ((props.value !== undefined || props.count !== undefined) && Object.keys(props).filter(k => !k.startsWith('_')).length <= 3) {
      return MetricDisplay;
    }

    // Text block
    if (props.text && Object.keys(props).filter(k => !k.startsWith('_')).length === 1) {
      return TextDisplay;
    }

    // If entity has multiple children, render as table or checklist
    if (childIds && childIds.length > 0 && entities) {
      const firstChild = entities[childIds[0]];
      const cp = firstChild?.props || {};
      // Check if children are checklist items
      if (typeof cp.done === 'boolean' || typeof cp.checked === 'boolean' || typeof cp.completed === 'boolean') {
        return ChecklistDisplay;
      }
      // Multiple children with props → table
      return TableDisplay;
    }

    return CardDisplay;
  }

  // ── AideEntity (recursive renderer) ────────────────────
  function AideEntity({ entityId }) {
    const { entities } = useContext(EntityContext);
    const entity = useEntity(entityId);
    const childIds = useChildren(entityId);
    const Component = resolveDisplay(entity, childIds, entities);

    if (!entity || entity._removed) return null;

    // For table/checklist displays, don't recursively render children
    // - the component handles its own child rendering
    const shouldPassChildren = Component !== TableDisplay && Component !== ChecklistDisplay;
    const children = (shouldPassChildren && childIds.length > 0)
      ? childIds.map(id => React.createElement(AideEntity, { key: id, entityId: id }))
      : null;

    return React.createElement(Component, { entity, entityId }, children);
  }

  // ── PreviewApp (root) ──────────────────────────────────
  function PreviewApp() {
    const meta = useMeta();
    const rootIds = useRootIds();

    return React.createElement('main', { className: 'aide-page' },
      meta.title && React.createElement('h1', { className: 'aide-heading aide-heading--1' }, meta.title),
      rootIds.length > 0
        ? rootIds.map(id => React.createElement(AideEntity, { key: id, entityId: id }))
        : React.createElement('p', { className: 'aide-empty' }, 'Send a message to get started.')
    );
  }

  // ── Shadow DOM Preview Renderer ────────────────────────────────
  // Uses Shadow DOM for complete CSS isolation between editor and preview

  let shadowRoot = null;
  const rendererCss = document.getElementById('renderer-css-template').textContent;

  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function humanize(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  function getChildren(parentId) {
    return Object.entries(entityStore.entities)
      .filter(([, e]) => e.parent === parentId && !e._removed)
      .map(([id]) => id);
  }

  function inferDisplay(entity, childIds) {
    const hint = (entity?.display || '').toLowerCase();
    if (hint) return hint;

    const props = entity?.props || {};
    if (props.src || props.url) return 'image';
    if (typeof props.done === 'boolean' || typeof props.checked === 'boolean') return 'card';
    if ((props.value !== undefined || props.count !== undefined) && Object.keys(props).filter(k => !k.startsWith('_')).length <= 3) return 'metric';
    if (props.text && Object.keys(props).filter(k => !k.startsWith('_')).length === 1) return 'text';

    if (childIds.length > 0) {
      const firstChild = entityStore.entities[childIds[0]];
      const cp = firstChild?.props || {};
      if (typeof cp.done === 'boolean' || typeof cp.checked === 'boolean') return 'checklist';
      return 'table';
    }
    return 'card';
  }

  function renderEntity(entityId) {
    const entity = entityStore.entities[entityId];
    if (!entity || entity._removed) return '';

    const childIds = getChildren(entityId);
    const display = inferDisplay(entity, childIds);
    const props = entity.props || {};

    switch (display) {
      case 'page': return renderPage(entity, childIds);
      case 'section': return renderSection(entity, childIds);
      case 'metric': return renderMetric(entity);
      case 'text': return renderText(entity);
      case 'image': return renderImage(entity);
      case 'checklist': return renderChecklist(entity, childIds);
      case 'table': return renderTable(entity, childIds);
      case 'list': return renderList(entity, childIds);
      default: return renderCard(entity, childIds);
    }
  }

  function renderPage(entity, childIds) {
    const props = entity.props || {};
    const title = props.title || props.name || '';
    const titleField = props.title !== undefined ? 'title' : 'name';
    const children = childIds.length > 0
      ? childIds.map(id => renderEntity(id)).join('')
      : '<p class="aide-empty">Send a message to get started.</p>';
    return `<div class="aide-page">
      ${title ? `<h1 class="aide-heading aide-heading--1 editable-field" data-entity-id="${entity.id}" data-field="${titleField}">${escapeHtml(title)}</h1>` : ''}
      ${children}
    </div>`;
  }

  function renderSection(entity, childIds) {
    const props = entity.props || {};
    const title = props.title || props.name || 'Section';
    const titleField = props.title !== undefined ? 'title' : 'name';
    const children = childIds.map(id => renderEntity(id)).join('');
    return `<div class="aide-section">
      <div class="aide-section__header">
        <span class="aide-section__icon">▾</span>
        <span class="aide-section__title editable-field" data-entity-id="${entity.id}" data-field="${titleField}">${escapeHtml(title)}</span>
      </div>
      <div class="aide-section__content">${children || '<p class="aide-collection-empty">No items yet.</p>'}</div>
    </div>`;
  }

  function renderMetric(entity) {
    const props = entity.props || {};
    const label = props.label || props.name || 'Value';
    const value = props.value ?? props.count ?? '';
    const valueField = props.value !== undefined ? 'value' : 'count';
    return `<div class="aide-metric">
      <span class="aide-metric__label">${escapeHtml(label)}</span>
      <span class="aide-metric__value editable-field" data-entity-id="${entity.id}" data-field="${valueField}">${escapeHtml(value)}</span>
    </div>`;
  }

  function renderText(entity) {
    const props = entity.props || {};
    const text = props.text || props.content || props.body || '';
    const field = props.text !== undefined ? 'text' : (props.content !== undefined ? 'content' : 'body');
    return `<p class="aide-text editable-field" data-entity-id="${entity.id}" data-field="${field}">${escapeHtml(text)}</p>`;
  }

  function renderImage(entity) {
    const props = entity.props || {};
    const src = props.src || props.url || '';
    const alt = props.alt || '';
    const caption = props.caption || '';
    return `<div class="aide-image">
      <img src="${escapeHtml(src)}" alt="${escapeHtml(alt)}">
      ${caption ? `<div class="aide-image__caption editable-field" data-entity-id="${entity.id}" data-field="caption">${escapeHtml(caption)}</div>` : ''}
    </div>`;
  }

  function renderChecklist(entity, childIds) {
    const items = childIds.map(id => {
      const child = entityStore.entities[id];
      if (!child) return '';
      const cp = child.props || {};
      const done = cp.done || cp.checked || false;
      const doneField = cp.done !== undefined ? 'done' : 'checked';
      const label = cp.label || cp.name || cp.title || '';
      const labelField = cp.label !== undefined ? 'label' : (cp.name !== undefined ? 'name' : 'title');
      return `<li class="aide-checklist__item">
        <input type="checkbox" class="aide-checklist__checkbox" ${done ? 'checked' : ''} data-entity-id="${id}" data-field="${doneField}" data-type="boolean">
        <span class="aide-checklist__label ${done ? 'aide-checklist__label--done' : ''} editable-field" data-entity-id="${id}" data-field="${labelField}">${escapeHtml(label)}</span>
      </li>`;
    }).join('');
    return `<ul class="aide-checklist">${items}</ul>`;
  }

  function renderTable(entity, childIds) {
    if (childIds.length === 0) return '<p class="aide-collection-empty">No items yet.</p>';

    // Collect columns from all children
    const colSet = new Set();
    childIds.forEach(id => {
      const child = entityStore.entities[id];
      if (!child) return;
      Object.keys(child.props || {}).filter(k => !k.startsWith('_')).forEach(k => colSet.add(k));
    });
    const cols = Array.from(colSet);

    const thead = `<tr>${cols.map(c => `<th class="aide-table__th">${escapeHtml(humanize(c))}</th>`).join('')}</tr>`;
    const tbody = childIds.map(id => {
      const child = entityStore.entities[id];
      if (!child) return '';
      const cp = child.props || {};
      return `<tr>${cols.map(c => `<td class="aide-table__td"><span class="editable-field" data-entity-id="${id}" data-field="${c}">${escapeHtml(cp[c] ?? '')}</span></td>`).join('')}</tr>`;
    }).join('');

    return `<div class="aide-table-wrap">
      <table class="aide-table">
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
      </table>
    </div>`;
  }

  function renderList(entity, childIds) {
    const items = childIds.map(id => {
      const child = entityStore.entities[id];
      if (!child) return '';
      const cp = child.props || {};

      // Primary (name/title) on left, secondary on right
      const primaryField = cp.name !== undefined ? 'name' : (cp.title !== undefined ? 'title' : null);
      const primaryValue = primaryField ? cp[primaryField] : '';
      const secondaryProps = Object.entries(cp).filter(([k]) => !k.startsWith('_') && k !== 'name' && k !== 'title');

      const rightHtml = primaryValue
        ? `<span class="aide-list__right editable-field" data-entity-id="${id}" data-field="${primaryField}">${escapeHtml(primaryValue)}</span>`
        : '';
      const leftHtml = secondaryProps.map(([k, v]) =>
        `<span class="aide-list__left editable-field" data-entity-id="${id}" data-field="${k}">${escapeHtml(v)}</span>`
      ).join(' ');

      return `<li class="aide-list__item">${leftHtml}${rightHtml}</li>`;
    }).join('');
    return `<ul class="aide-list">${items}</ul>`;
  }

  function renderCard(entity, childIds) {
    const props = entity.props || {};
    const title = props.title || props.name || '';
    const titleField = props.title !== undefined ? 'title' : 'name';
    const displayProps = Object.entries(props).filter(([k]) => !k.startsWith('_') && k !== 'title' && k !== 'name');

    const fields = displayProps.map(([k, v]) => `
      <div class="aide-card__field">
        <span class="aide-card__label">${escapeHtml(humanize(k))}</span>
        <span class="editable-field" data-entity-id="${entity.id}" data-field="${k}">${escapeHtml(v)}</span>
      </div>
    `).join('');

    const children = childIds.map(id => renderEntity(id)).join('');

    return `<div class="aide-card">
      ${title ? `<div class="aide-card__title editable-field" data-entity-id="${entity.id}" data-field="${titleField}">${escapeHtml(title)}</div>` : ''}
      ${fields}
      ${children}
    </div>`;
  }

  function buildPreviewHtml() {
    if (entityStore.rootIds.length === 0 && Object.keys(entityStore.meta).length === 0) {
      return '<div class="aide-page"><p class="aide-empty">Send a message to get started.</p></div>';
    }
    // Always wrap in .aide-page for consistent padding/layout
    const content = entityStore.rootIds.map(id => renderEntity(id)).join('');
    // Check if content already has a page wrapper
    if (content.trim().startsWith('<div class="aide-page">')) {
      return content;
    }
    return `<div class="aide-page">${content}</div>`;
  }

  let activeEditElement = null;

  function startInlineEdit(element) {
    if (activeEditElement) return; // Already editing

    const entityId = element.dataset.entityId;
    const field = element.dataset.field;
    const currentValue = element.textContent;

    activeEditElement = element;
    const originalText = element.textContent;

    // Create input
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.className = 'editable-input';
    input.style.cssText = 'font: inherit; color: inherit; background: var(--bg-elevated, #fff); border: 1px solid var(--accent, #7C8C6E); border-radius: var(--radius-sm, 6px); padding: 1px 4px; margin: -2px -5px; outline: none; min-width: 60px; width: 100%;';

    // Replace content with input
    element.textContent = '';
    element.appendChild(input);
    input.focus();
    input.select();

    const finishEdit = (save) => {
      if (activeEditElement !== element) return;
      activeEditElement = null;

      const newValue = input.value;
      element.textContent = save ? newValue : originalText;

      if (save && newValue !== originalText) {
        sendDirectEdit(entityId, field, newValue);
      }
    };

    input.addEventListener('blur', () => finishEdit(true));
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
      if (e.key === 'Escape') { finishEdit(false); }
    });
  }

  function refreshEntityPreview() {
    const host = document.getElementById('preview-root');
    if (!host) return;

    // Initialize shadow root on first render
    if (!shadowRoot) {
      shadowRoot = host.attachShadow({ mode: 'open' });

      // Click handler for links, editable fields, and checkboxes
      shadowRoot.addEventListener('click', (e) => {
        // Handle link clicks
        const link = e.target.closest('a');
        if (link && link.href) {
          e.preventDefault();
          window.open(link.href, '_blank');
          return;
        }

        // Handle editable field clicks
        const editable = e.target.closest('.editable-field');
        if (editable && editable.dataset.entityId) {
          e.preventDefault();
          startInlineEdit(editable);
          return;
        }
      });

      // Change handler for checkboxes
      shadowRoot.addEventListener('change', (e) => {
        const checkbox = e.target;
        if (checkbox.type === 'checkbox' && checkbox.dataset.entityId) {
          const entityId = checkbox.dataset.entityId;
          const field = checkbox.dataset.field;
          sendDirectEdit(entityId, field, checkbox.checked);
        }
      });
    }

    // Save scroll position
    const scrollY = shadowRoot.host.scrollTop;

    // Build HTML from entity store
    const html = buildPreviewHtml();

    // Render with CSS into shadow DOM
    shadowRoot.innerHTML = `<style>${rendererCss}</style>${html}`;

    // Restore scroll position
    requestAnimationFrame(() => {
      shadowRoot.host.scrollTop = scrollY;
    });
  }

  // ── WebSocket Client ────────────────────────────────
  let aideWs = null;
  let wsConnectedAideId = null;

  function connectWebSocket(aideId) {
    // Close existing connection if switching aides
    if (aideWs && wsConnectedAideId !== aideId) {
      aideWs.close();
      aideWs = null;
    }
    if (aideWs && aideWs.readyState === WebSocket.OPEN) {
      return Promise.resolve();
    }

    const wsId = aideId || 'new';
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${proto}//${location.host}/ws/aide/${wsId}`;

    return new Promise((resolve, reject) => {
      try {
        aideWs = new WebSocket(url);
        wsConnectedAideId = wsId;

        aideWs.onopen = () => {
          console.log('[WS] connected:', url);
          resolve();
        };

      let isHydrating = false; // Track if we're receiving initial snapshot

      aideWs.onmessage = (event) => {
        let msg;
        try { msg = JSON.parse(event.data); } catch { return; }

        if (msg.type === 'snapshot.start') {
          // Beginning of initial snapshot hydration - reset store
          isHydrating = true;
          entityStore.reset();
          console.log('[WS] Hydrating snapshot...');
        } else if (msg.type === 'snapshot.end') {
          // End of snapshot hydration - refresh preview once
          isHydrating = false;
          refreshEntityPreview();
          console.log('[WS] Snapshot hydrated:', Object.keys(entityStore.entities).length, 'entities');
        } else if (msg.type === 'stream.start') {
          // Don't reset entityStore - keep existing entities for follow-up messages
          // Only reset voice accumulator for new stream
          pendingVoiceResponse = '';
        } else if (msg.type === 'entity.create' || msg.type === 'entity.update' || msg.type === 'entity.remove') {
          entityStore.applyDelta(msg);
          // Only refresh preview during streaming, not during hydration (wait for snapshot.end)
          if (!isHydrating) {
            refreshEntityPreview();
          }
        } else if (msg.type === 'meta.update') {
          // Update page metadata (title, etc.)
          if (msg.data) {
            entityStore.meta = msg.data;
            if (!isHydrating) {
              refreshEntityPreview();
            }
          }
        } else if (msg.type === 'voice') {
          // Show voice text as assistant message in history
          if (msg.text) {
            // Track for persistence (use last voice message as the response)
            pendingVoiceResponse = msg.text;
            // Only add if not already the last assistant message
            const last = conversationHistory[conversationHistory.length - 1];
            if (!last || last.role !== 'assistant' || last.content !== msg.text) {
              conversationHistory.push({ role: 'assistant', content: msg.text });
              renderHistory();
              // Smooth scroll to show new voice message
              const historyPanel = document.getElementById('history-panel');
              if (historyPanel.classList.contains('open')) {
                historyPanel.scrollTo({
                  top: historyPanel.scrollHeight,
                  behavior: 'smooth'
                });
              }
            }
          }
        } else if (msg.type === 'direct_edit.error') {
          console.warn('[WS] direct_edit rejected:', msg.error);
        } else if (msg.type === 'stream.interrupted') {
          console.log('[WS] stream interrupted by user');
          setSendingState(false);
          isSending = false;
        } else if (msg.type === 'stream.end') {
          setSendingState(false);
          isSending = false;
          pendingPreviewUrl = null;

          // Save conversation history only (server saves snapshot in ws.py)
          if (currentAideId && (pendingUserMessage || pendingVoiceResponse)) {
            fetch(`/api/aides/${currentAideId}/conversation`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: pendingUserMessage,
                response: pendingVoiceResponse,
              }),
            })
            .then(() => {
              // Clear pending conversation after successful save
              pendingUserMessage = null;
              pendingVoiceResponse = '';
            })
            .catch(err => console.error('Failed to save conversation:', err));
          }
        } else if (msg.type === 'stream.error') {
          const errMsg = msg.error || 'Stream error.';
          conversationHistory.push({ role: 'assistant', content: errMsg });
          renderHistory();
          setSendingState(false);
          isSending = false;
        }
      };

      aideWs.onerror = (err) => {
        console.warn('[WS] error, will fall back to HTTP:', err);
        reject(err);
      };

      aideWs.onclose = () => {
        console.log('[WS] disconnected');
        if (wsConnectedAideId === wsId) {
          aideWs = null;
        }
      };
    } catch (err) {
      console.warn('[WS] could not connect:', err);
      aideWs = null;
      reject(err);
    }
    });
  }

  function sendViaWebSocket(content, messageId) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) return false;
    aideWs.send(JSON.stringify({ type: 'message', content, message_id: messageId }));
    return true;
  }

  function sendDirectEdit(entityId, field, value) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) {
      console.warn('[WS] direct_edit: no open connection');
      return;
    }
    aideWs.send(JSON.stringify({ type: 'direct_edit', entity_id: entityId, field, value }));
  }

  // postMessage listener removed - inline preview calls sendDirectEdit() directly

  // ── Screens ────────────────────────────────────────
  function showScreen(name) {
    document.getElementById('auth-screen').classList.toggle('active', name === 'auth');
    document.getElementById('dashboard').classList.toggle('active', name === 'dashboard');
    document.getElementById('editor').classList.toggle('active', name === 'editor');
    document.getElementById('editor-back').classList.toggle('visible', name === 'editor');
    document.getElementById('publish-btn-floating').classList.toggle('visible', name === 'editor');
  }

  // ── Auth ───────────────────────────────────────────
  async function checkAuth() {
    try {
      const res = await fetch('/auth/me', { credentials: 'include' });
      if (res.ok) {
        currentUser = await res.json();
        // Check if there's an aide ID in the URL
        const aideId = new URLSearchParams(location.search).get('aide');
        console.log('[URL Debug] Page load - URL aide param:', aideId, 'Full URL:', location.href);
        if (aideId) {
          openEditor(aideId);
        } else {
          loadDashboard();
        }
      } else {
        showScreen('auth');
      }
    } catch {
      showScreen('auth');
    }
  }

  document.getElementById('send-link-btn').addEventListener('click', async () => {
    const email = document.getElementById('email-input').value.trim();
    const msg = document.getElementById('auth-msg');
    if (!email) { msg.textContent = 'Enter your email.'; msg.className = 'auth-message error'; return; }

    const btn = document.getElementById('send-link-btn');
    btn.disabled = true;
    msg.textContent = '';

    try {
      const res = await fetch('/auth/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      if (res.ok) {
        document.getElementById('auth-send-form').style.display = 'none';
        document.getElementById('auth-sent-msg').style.display = 'block';
      } else {
        const data = await res.json();
        msg.textContent = data.detail || 'Something went wrong.';
        msg.className = 'auth-message error';
        btn.disabled = false;
      }
    } catch {
      msg.textContent = 'Network error.';
      msg.className = 'auth-message error';
      btn.disabled = false;
    }
  });

  document.getElementById('email-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('send-link-btn').click();
  });

  // ── Dashboard ──────────────────────────────────────
  async function loadDashboard() {
    showScreen('dashboard');
    const grid = document.getElementById('aide-grid');
    const empty = document.getElementById('empty-state');
    grid.innerHTML = '';

    try {
      const res = await fetch('/api/aides', { credentials: 'include' });
      if (!res.ok) { showScreen('auth'); return; }
      const aides = await res.json();

      if (aides.length === 0) {
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      aides.forEach(aide => {
        const card = createAideCard(aide);
        grid.appendChild(card);
      });
    } catch {
      empty.style.display = 'block';
    }
  }

  function createAideCard(aide) {
    const card = document.createElement('div');
    card.className = 'aide-card';

    const updated = new Date(aide.updated_at).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric'
    });

    card.innerHTML = `
      <div class="aide-card-title">${escapeHtml(aide.title)}</div>
      <div class="aide-card-meta">
        <span class="status-badge status-${aide.status}">${aide.status}</span>
        <span>${updated}</span>
      </div>
      <div class="aide-card-actions">
        <button class="icon-btn danger" title="Archive" data-id="${aide.id}">×</button>
      </div>
    `;

    card.addEventListener('click', (e) => {
      if (e.target.closest('.aide-card-actions')) return;
      openEditor(aide.id);
    });

    card.querySelector('.icon-btn.danger').addEventListener('click', async (e) => {
      e.stopPropagation();
      const confirmed = await confirmModal('Archive aide?', `"${aide.title}" will be archived.`, 'Archive');
      if (!confirmed) return;
      await archiveAide(aide.id);
    });

    return card;
  }

  async function archiveAide(aideId) {
    await fetch(`/api/aides/${aideId}/archive`, { method: 'POST', credentials: 'include' });
    loadDashboard();
  }

  function startNewAide() {
    openEditor(null);
  }

  document.getElementById('new-aide-fab').addEventListener('click', startNewAide);

  // ── Editor ─────────────────────────────────────────
  async function openEditor(aideId) {
    console.log('[URL Debug] openEditor called with aideId:', aideId);
    currentAideId = aideId;
    conversationHistory = [];
    pendingImage = null;

    renderHistory();
    clearImagePreview();
    document.getElementById('message-input').value = '';

    // Always reset entity store when opening editor (new or existing aide)
    // This clears stale data from previous aide before WebSocket hydration
    entityStore.reset();
    refreshEntityPreview();

    if (aideId) {
      // Update URL to include aide ID (for refresh persistence)
      history.replaceState({}, '', `?aide=${aideId}`);

      // Load conversation history
      try {
        const res = await fetch(`/api/aides/${aideId}/history`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          conversationHistory = data.messages || [];
          renderHistory();
        }
      } catch (e) {
        console.error('Failed to load conversation history:', e);
      }
    }

    showScreen('editor');
    document.getElementById('message-input').focus();

    // Connect WebSocket for real-time entity streaming
    // WebSocket will send snapshot.start/snapshot.end to hydrate entityStore
    connectWebSocket(aideId);
  }

  document.getElementById('editor-back').addEventListener('click', () => {
    currentAideId = null;
    history.replaceState({}, '', '/');
    loadDashboard();
  });

  // ── Publish ────────────────────────────────────────
  document.getElementById('publish-btn-floating').addEventListener('click', async () => {
    if (!currentAideId) return;

    const slug = await promptModal('Publish', 'Enter a URL slug for your page:', 'my-page');
    if (!slug) return;

    try {
      const res = await fetch(`/api/aides/${currentAideId}/publish`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug }),
      });
      if (res.ok) {
        const data = await res.json();
        await alertModal('Published', `Your page is live at: ${data.url}`);
      } else {
        const data = await res.json();
        await alertModal('Error', data.detail || 'Could not publish.');
      }
    } catch {
      await alertModal('Error', 'Network error.');
    }
  });

  // ── Sending messages ───────────────────────────────
  async function sendMessage() {
    if (isSending) return;
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text && !pendingImage) return;

    isSending = true;
    setSendingState(true);

    const userContent = text || '(image)';
    conversationHistory.push({ role: 'user', content: userContent });
    renderHistory();

    input.value = '';
    resizeTextarea(input);

    const messageId = 'msg_' + Math.random().toString(36).slice(2, 10);
    clearImagePreview();

    // If new aide, create it first to get aide_id immediately
    if (!currentAideId) {
      try {
        const createRes = await fetch('/api/aides', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: 'Untitled' }),
        });
        if (createRes.ok) {
          const aideData = await createRes.json();
          currentAideId = aideData.id;
          history.replaceState({}, '', `?aide=${aideData.id}`);
          // Reconnect WebSocket with real aide ID and wait for it
          await connectWebSocket(aideData.id);
        } else if (createRes.status === 401) {
          showScreen('auth');
          return;
        }
      } catch (err) {
        console.error('Failed to create aide:', err);
      }
    }

    // Try WebSocket first (streaming entity deltas)
    const sentViaWs = !pendingImage && sendViaWebSocket(text, messageId);

    if (sentViaWs) {
      // Track user message for persistence at stream.end
      pendingUserMessage = text;
      // WebSocket handles streaming. State persistence happens at stream.end
      // via POST /api/aides/{id}/state (no duplicate LLM call)
      return;
    }

    // Fallback: HTTP-only path (used when no image support in WS or WS unavailable)
    const body = {
      aide_id: currentAideId || undefined,
      message: text || ' ',
      image: pendingImage ? pendingImage.base64 : undefined,
    };

    try {
      const res = await fetch('/api/message', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.status === 401) { showScreen('auth'); return; }

      const data = await res.json();

      if (!res.ok) {
        conversationHistory.push({ role: 'assistant', content: data.detail || 'Error.' });
        renderHistory();
        return;
      }

      // Update state
      currentAideId = data.aide_id;
      // Update URL for new AIde (persist across refresh)
      history.replaceState({}, '', `?aide=${data.aide_id}`);

      if (data.response_text) {
        conversationHistory.push({ role: 'assistant', content: data.response_text });
        renderHistory();
      }

      // Preview will be refreshed by WebSocket delta events (entity.create/update/remove)
      // No need to manually refresh here - the WebSocket already handles it

    } catch (e) {
      conversationHistory.push({ role: 'assistant', content: 'Network error.' });
      renderHistory();
    } finally {
      isSending = false;
      setSendingState(false);
    }
  }

  // refreshPreview() removed - WebSocket delta events handle all preview updates

  let thinkingInterval = null;
  const thinkingStates = ['Thinking', 'Processing', 'Generating'];

  function updateStreamProgress() {
    // Update progress indicator with entity count during streaming
    if (isSending) {
      const count = Object.keys(entityStore.entities).length;
      const thinkingText = document.getElementById('thinking-text');
      if (count > 0) {
        thinkingText.textContent = `Building (${count} items)`;
      }
    }
  }

  function setSendingState(sending) {
    const sendBtn = document.getElementById('send-btn');
    const stopBtn = document.getElementById('stop-btn');
    const messageInput = document.getElementById('message-input');
    const indicator = document.getElementById('thinking-indicator');
    const thinkingText = document.getElementById('thinking-text');

    // Toggle between send and stop buttons
    sendBtn.style.display = sending ? 'none' : '';
    stopBtn.style.display = sending ? '' : 'none';
    messageInput.disabled = sending;

    if (sending) {
      indicator.classList.add('visible');
      let stateIndex = 0;
      thinkingText.textContent = thinkingStates[0];
      thinkingInterval = setInterval(() => {
        stateIndex = (stateIndex + 1) % thinkingStates.length;
        thinkingText.textContent = thinkingStates[stateIndex];
      }, 2000);
    } else {
      indicator.classList.remove('visible');
      if (thinkingInterval) {
        clearInterval(thinkingInterval);
        thinkingInterval = null;
      }
    }
  }

  // ── History ────────────────────────────────────────
  function renderHistory() {
    const panel = document.getElementById('history-panel');
    if (conversationHistory.length === 0) {
      panel.classList.remove('open');
      panel.innerHTML = '';
      return;
    }

    panel.innerHTML = conversationHistory.map(m => `
      <div class="history-message ${m.role}">
        <div class="history-content">${escapeHtml(m.content)}</div>
      </div>
    `).join('');

    panel.classList.add('open');
    // Delay scroll to allow panel to expand
    setTimeout(() => {
      panel.scrollTop = panel.scrollHeight;
    }, 50);
  }

  // ── Image handling ─────────────────────────────────
  document.getElementById('image-btn').addEventListener('click', () => {
    document.getElementById('image-file-input').click();
  });

  document.getElementById('image-file-input').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) handleImageFile(file);
    e.target.value = '';
  });

  function handleImageFile(file) {
    if (file.size > 10 * 1024 * 1024) { alert('Image must be under 10 MB.'); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      const base64 = dataUrl.split(',')[1];
      pendingImage = { dataUrl, base64 };
      showImagePreview(dataUrl);
    };
    reader.readAsDataURL(file);
  }

  function showImagePreview(dataUrl) {
    const strip = document.getElementById('image-preview-strip');
    strip.innerHTML = `
      <div class="image-thumb">
        <img src="${dataUrl}" alt="attachment" />
        <button class="image-thumb-remove" id="remove-image-btn">×</button>
      </div>
    `;
    strip.classList.add('has-image');
    document.getElementById('remove-image-btn').addEventListener('click', clearImagePreview);
  }

  function clearImagePreview() {
    pendingImage = null;
    const strip = document.getElementById('image-preview-strip');
    strip.innerHTML = '';
    strip.classList.remove('has-image');
  }

  // Drag-and-drop
  let dragCounter = 0;
  document.addEventListener('dragenter', e => {
    if (e.dataTransfer.types.includes('Files')) {
      dragCounter++;
      document.getElementById('drag-overlay').classList.add('active');
    }
  });
  document.addEventListener('dragleave', () => {
    dragCounter--;
    if (dragCounter <= 0) {
      dragCounter = 0;
      document.getElementById('drag-overlay').classList.remove('active');
    }
  });
  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', e => {
    e.preventDefault();
    dragCounter = 0;
    document.getElementById('drag-overlay').classList.remove('active');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleImageFile(file);
  });

  // ── Input handlers ─────────────────────────────────
  const messageInput = document.getElementById('message-input');

  messageInput.addEventListener('input', () => resizeTextarea(messageInput));

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById('send-btn').addEventListener('click', sendMessage);

  // Stop button handler - interrupts the current stream
  document.getElementById('stop-btn').addEventListener('click', () => {
    if (aideWs && aideWs.readyState === WebSocket.OPEN) {
      aideWs.send(JSON.stringify({ type: 'interrupt' }));
    }
  });

  function resizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  // ── Modals ─────────────────────────────────────────
  function openModal({ title, desc, body = '', actions }) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-desc').textContent = desc;
    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-actions').innerHTML = actions;
    document.getElementById('modal-overlay').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
  }

  function confirmModal(title, desc, confirmLabel = 'Confirm') {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `
          <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
          <button class="btn btn-danger" id="modal-confirm">${escapeHtml(confirmLabel)}</button>
        `,
      });
      document.getElementById('modal-cancel').onclick = () => { closeModal(); resolve(false); };
      document.getElementById('modal-confirm').onclick = () => { closeModal(); resolve(true); };
    });
  }

  function promptModal(title, desc, placeholder = '') {
    return new Promise(resolve => {
      openModal({
        title, desc,
        body: `<input id="modal-input" class="form-input" placeholder="${escapeHtml(placeholder)}" style="margin-top:4px;" />`,
        actions: `
          <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="modal-confirm">OK</button>
        `,
      });
      const inp = document.getElementById('modal-input');
      inp.focus();
      const submit = () => { const v = inp.value.trim(); closeModal(); resolve(v || null); };
      inp.addEventListener('keydown', e => { if (e.key === 'Enter') submit(); });
      document.getElementById('modal-cancel').onclick = () => { closeModal(); resolve(null); };
      document.getElementById('modal-confirm').onclick = submit;
    });
  }

  function alertModal(title, desc) {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `<button class="btn btn-primary" id="modal-ok">OK</button>`,
      });
      document.getElementById('modal-ok').onclick = () => { closeModal(); resolve(); };
    });
  }

  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modal-overlay')) closeModal();
  });

  // ── Utils ──────────────────────────────────────────
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // Handle magic link token in URL
  const urlParams = new URLSearchParams(location.search);
  const token = urlParams.get('token');
  if (token) {
    fetch(`/auth/verify?token=${encodeURIComponent(token)}`, { credentials: 'include' })
      .then(res => {
        history.replaceState({}, '', '/');
        if (res.ok) return res.json().then(user => { currentUser = user; loadDashboard(); });
        showScreen('auth');
      })
      .catch(() => showScreen('auth'));
  } else {
    checkAuth();
  }
</script>
</body>
</html>
