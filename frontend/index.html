<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIde</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --border: #2a2a2a;
      --text: #e8e8e8;
      --text-muted: #888;
      --accent: #fff;
      --overlay-bg: rgba(0, 0, 0, 0.3);
      --radius: 12px;
      --input-height: 52px;
      --chat-max-width: 640px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }

    /* ── DASHBOARD ─────────────────────────────────── */
    #dashboard {
      display: none;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      padding: 40px 24px;
      max-width: 900px;
      margin: 0 auto;
    }

    #dashboard.active { display: flex; }

    .dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .dashboard-header h1 {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.15s, opacity 0.15s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover:not(:disabled) { background: #ddd; }
    .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--surface); color: var(--text); }
    .btn-danger { background: transparent; color: #e55; border: 1px solid #e55; }
    .btn-danger:hover { background: rgba(238,85,85,0.1); }

    .aide-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .aide-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
      position: relative;
    }

    .aide-card:hover { border-color: #444; background: #202020; }

    .aide-card-title {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-right: 60px;
    }

    .aide-card-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .status-draft { background: #2a2a2a; color: #888; }
    .status-published { background: rgba(80, 200, 120, 0.15); color: #5c8; }
    .status-archived { background: rgba(255, 100, 100, 0.1); color: #e66; }

    .aide-card-actions {
      position: absolute;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .aide-card:hover .aide-card-actions { opacity: 1; }

    .icon-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: var(--border);
      color: var(--text-muted);
      font-size: 13px;
      transition: background 0.15s, color 0.15s;
    }

    .icon-btn:hover { background: #333; color: var(--text); }
    .icon-btn.danger:hover { background: rgba(238,85,85,0.2); color: #e55; }

    .empty-state {
      text-align: center;
      padding: 80px 0;
      color: var(--text-muted);
    }

    .empty-state p { margin-bottom: 20px; font-size: 15px; }

    /* ── EDITOR (preview + chat) ────────────────────── */
    #editor {
      display: none;
      height: 100vh;
      position: relative;
    }

    #editor.active { display: block; }

    /* Full-viewport preview iframe */
    #preview-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    /* Floating chat overlay */
    #chat-overlay {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: min(var(--chat-max-width), calc(100vw - 32px));
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: transparent;
      border-radius: var(--radius);
    }

    /* Conversation history (expandable) */
    #history-panel {
      background: rgba(20, 20, 20, 0.9);
      border-radius: var(--radius) var(--radius) 0 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease, padding 0.25s ease;
    }

    #history-panel.open {
      max-height: 160px;
      overflow-y: auto;
      padding: 12px 16px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #history-panel::-webkit-scrollbar {
      display: none;
    }

    #history-panel.open + #input-bar {
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0 0 var(--radius) var(--radius);
    }

    .history-message {
      margin-bottom: 8px;
      display: flex;
    }

    .history-message:last-child { margin-bottom: 0; }

    .history-message.user {
      justify-content: flex-end;
    }

    .history-message.assistant {
      justify-content: flex-start;
    }

    .history-content {
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      padding: 8px 12px;
      border-radius: 16px;
      max-width: 85%;
    }

    .history-message.user .history-content {
      background: rgba(60, 60, 60, 0.6);
      color: var(--text);
      border-bottom-right-radius: 4px;
    }

    .history-message.assistant .history-content {
      background: rgba(30, 30, 30, 0.6);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    /* Input bar */
    #input-bar {
      background: rgba(20, 20, 20, 0.9);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Image preview strip */
    #image-preview-strip {
      display: none;
      padding: 8px 12px 0;
      gap: 8px;
      flex-wrap: wrap;
    }

    #image-preview-strip.has-image { display: flex; }

    .image-thumb {
      position: relative;
      width: 56px;
      height: 56px;
    }

    .image-thumb img {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .image-thumb-remove {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #333;
      border: 1px solid var(--border);
      color: #fff;
      font-size: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    /* Row: text + actions */
    .input-row {
      display: flex;
      align-items: flex-end;
      padding: 8px 10px;
      gap: 8px;
      min-height: var(--input-height);
    }

    #message-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      resize: none;
      max-height: 120px;
      overflow-y: auto;
      line-height: 1.5;
      padding: 6px 0;
      scrollbar-width: thin;
    }

    #message-input::placeholder { color: var(--text-muted); }

    .input-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .action-btn {
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: transparent;
      color: var(--text-muted);
      font-size: 16px;
      transition: background 0.15s, color 0.15s;
    }

    .action-btn:hover { background: var(--border); color: var(--text); }
    .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    #send-btn {
      background: var(--accent);
      color: #000;
      border-radius: 8px;
    }

    #send-btn:hover:not(:disabled) { background: #ddd; }

    /* Thinking indicator */
    #thinking-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 12px;
    }

    #thinking-indicator.visible { display: flex; }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: thinking-bounce 1.4s infinite ease-in-out both;
    }

    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes thinking-bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Back button (editor toolbar) */
    #editor-back {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 200;
      background: rgba(20, 20, 20, 0.9);
      border: none;
      border-radius: var(--radius);
      width: 36px;
      height: 36px;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0;
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      transition: background 0.15s;
    }

    #editor-back.visible { display: flex; }
    #editor-back:hover { background: rgba(30, 30, 30, 0.95); }

    /* Publish button (editor toolbar) */
    #publish-btn-floating {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 200;
      background: rgba(20, 20, 20, 0.9);
      border: none;
      border-radius: var(--radius);
      padding: 8px 16px;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: none;
      align-items: center;
      transition: background 0.15s;
    }

    #publish-btn-floating.visible { display: flex; }
    #publish-btn-floating:hover { background: rgba(30, 30, 30, 0.95); }

    /* ── AUTH ───────────────────────────────────────── */
    #auth-screen {
      display: none;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      gap: 0;
    }

    #auth-screen.active { display: flex; }

    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 340px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: -12px;
    }

    .auth-form { display: flex; flex-direction: column; gap: 12px; }

    .form-input {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      width: 100%;
      transition: border-color 0.15s;
    }

    .form-input:focus { border-color: #555; }
    .form-input::placeholder { color: var(--text-muted); }

    .auth-message {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      min-height: 20px;
    }

    .auth-message.error { color: #e66; }
    .auth-message.success { color: #5c8; }

    /* ── MODAL ──────────────────────────────────────── */
    #modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 300;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 360px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .modal-title { font-size: 16px; font-weight: 600; }
    .modal-desc { font-size: 13px; color: var(--text-muted); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 4px; }

    /* ── DRAG OVERLAY ───────────────────────────────── */
    #drag-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.04);
      border: 2px dashed #555;
      border-radius: 12px;
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #888;
      pointer-events: none;
    }

    #drag-overlay.active { display: flex; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  </style>
  <!-- Display component styles (injected into preview iframe) -->
  <script id="display-css-template" type="text/template">
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; font-size: 14px; color: #1a1a1a; padding: 24px; background: #fafaf9; margin: 0; }
    * { box-sizing: border-box; }

    /* Page */
    .aide-page { max-width: 800px; margin: 0 auto; padding: 8px; }
    .page-title { font-size: 28px; font-weight: 700; margin-bottom: 24px; color: #111; letter-spacing: -0.5px; }

    /* Card */
    .aide-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    .card-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 10px; }
    .card-field { display: flex; justify-content: space-between; align-items: baseline; padding: 6px 0; border-bottom: 1px solid #f0f0f0; gap: 12px; }
    .card-field:last-child { border-bottom: none; }
    .field-label { color: #888; font-size: 12px; text-transform: capitalize; flex-shrink: 0; }

    /* Table */
    .aide-table-wrap { overflow-x: auto; margin-bottom: 16px; }
    .aide-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid #e5e5e5; }
    .aide-table th { padding: 10px 14px; text-align: left; font-weight: 500; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; background: #fafafa; border-bottom: 1px solid #e5e5e5; }
    .aide-table td { padding: 10px 14px; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
    .aide-table tr:last-child td { border-bottom: none; }
    .aide-table tr:hover td { background: #fafafa; }

    /* Checklist */
    .aide-checklist { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 12px 16px; margin-bottom: 12px; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 7px 0; border-bottom: 1px solid #f5f5f5; cursor: default; }
    .checklist-item:last-child { border-bottom: none; }
    .checklist-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: #1a1a1a; flex-shrink: 0; }
    .checklist-item.done .item-label { text-decoration: line-through; color: #aaa; }

    /* Section */
    .aide-section { margin-bottom: 20px; }
    .section-header { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 0; user-select: none; }
    .collapse-icon { color: #888; font-size: 12px; width: 14px; text-align: center; }
    .section-title { font-size: 17px; font-weight: 600; color: #222; }
    .section-content { padding-left: 22px; margin-top: 8px; }

    /* Metric */
    .aide-metric { background: #fff; border: 1px solid #e5e5e5; border-radius: 10px; padding: 20px 24px; margin-bottom: 12px; display: inline-flex; flex-direction: column; gap: 4px; min-width: 140px; }
    .metric-value { font-size: 36px; font-weight: 700; color: #111; letter-spacing: -1px; }
    .metric-label { font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.4px; }
    .metric-group { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }

    /* Text */
    .aide-text { color: #444; line-height: 1.7; margin-bottom: 12px; font-size: 14px; }

    /* List */
    .aide-list { padding-left: 20px; margin-bottom: 12px; color: #333; }
    .aide-list li { padding: 4px 0; font-size: 13px; }

    /* Image */
    .aide-image { margin-bottom: 16px; }
    .aide-image img { max-width: 100%; border-radius: 8px; border: 1px solid #e5e5e5; }
    .aide-image figcaption { font-size: 12px; color: #888; margin-top: 6px; text-align: center; }

    /* Grid */
    .aide-grid-display { display: grid; gap: 2px; margin-bottom: 16px; }
    .grid-cell { background: #fff; border: 1px solid #e5e5e5; padding: 8px; font-size: 12px; text-align: center; border-radius: 4px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
    .grid-cell.claimed { background: #f0fdf4; color: #166534; font-weight: 500; }

    /* Editable fields */
    .editable-value { cursor: pointer; padding: 2px 4px; border-radius: 4px; display: inline; }
    .editable-value:hover { background: #f0f0f0; }
    .editable-input { font: inherit; font-size: inherit; color: inherit; padding: 2px 6px; border: 1.5px solid #2563eb; border-radius: 4px; outline: none; background: #fff; display: inline; min-width: 80px; }

    /* Fallback (unchanged) */
    .fb-entity { border-left: 2px solid #e0e0e0; padding: 8px 0 8px 12px; margin: 4px 0; }
    .fb-header { display: flex; gap: 8px; align-items: baseline; margin-bottom: 4px; }
    .fb-id { font-weight: 600; color: #2d3748; font-size: 12px; }
    .fb-display { font-size: 11px; color: #888; }
    .fb-props { display: grid; grid-template-columns: max-content 1fr; gap: 2px 12px; font-size: 12px; color: #555; }
    dt { font-weight: 500; color: #444; }
    dd { color: #666; word-break: break-word; }
    .empty { color: #aaa; text-align: center; padding: 40px; font-size: 13px; }
  </script>
</head>
<body>

<!-- Auth screen -->
<div id="auth-screen">
  <div class="auth-card">
    <div>
      <div class="auth-title">AIde</div>
      <div class="auth-subtitle">Sign in to continue.</div>
    </div>
    <div id="auth-send-form" class="auth-form">
      <input id="email-input" class="form-input" type="email" placeholder="you@example.com" autocomplete="email" />
      <button id="send-link-btn" class="btn btn-primary" style="width:100%;justify-content:center;">Send magic link</button>
      <p id="auth-msg" class="auth-message"></p>
    </div>
    <div id="auth-sent-msg" style="display:none;text-align:center;">
      <p style="color:var(--text-muted);font-size:13px;">Check your email — link sent.</p>
    </div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <div class="dashboard-header">
    <h1>AIde</h1>
    <button id="new-aide-btn" class="btn btn-primary">+ New AIde</button>
  </div>
  <div id="aide-grid" class="aide-grid"></div>
  <div id="empty-state" class="empty-state" style="display:none;">
    <p>Nothing yet.</p>
    <button class="btn btn-ghost" onclick="startNewAide()">Create your first AIde</button>
  </div>
</div>

<!-- Editor -->
<button id="editor-back">←</button>
<button id="publish-btn-floating">Publish</button>

<div id="editor">
  <iframe id="preview-frame" sandbox="allow-scripts allow-same-origin"></iframe>

  <div id="chat-overlay">
    <div id="history-panel"></div>
    <div id="input-bar">
      <div id="image-preview-strip"></div>
      <div id="thinking-indicator">
        <div class="thinking-dots"><span></span><span></span><span></span></div>
        <span id="thinking-text">Thinking</span>
      </div>
      <div class="input-row">
        <textarea
          id="message-input"
          rows="1"
          placeholder="Tell AIde what you're running…"
        ></textarea>
        <div class="input-actions">
          <button id="image-btn" class="action-btn" title="Attach image">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </button>
          <input id="image-file-input" type="file" accept="image/jpeg,image/png,image/webp,image/heic" style="display:none;" />
          <button id="send-btn" class="action-btn" title="Send">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2 21L23 12 2 3v7l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drag overlay -->
<div id="drag-overlay">Drop image here</div>

<!-- Modal -->
<div id="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-desc" id="modal-desc"></div>
    <div id="modal-body"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────
  let currentUser = null;
  let currentAideId = null;
  let pendingImage = null; // { dataUrl, base64 }
  let conversationHistory = []; // {role, content}
  let isSending = false;

  // ── Entity Store ────────────────────────────────────
  // Holds the live entity graph populated by WebSocket deltas.
  const entityStore = {
    entities: {},   // id → entity data
    rootIds: [],    // top-level entity IDs (parent === 'root' or no parent)

    applyDelta(delta) {
      if (delta.type === 'entity.create') {
        this.entities[delta.id] = delta.data || {};
        const parent = (delta.data || {}).parent;
        if (!parent || parent === 'root') {
          if (!this.rootIds.includes(delta.id)) {
            this.rootIds.push(delta.id);
          }
        }
      } else if (delta.type === 'entity.update') {
        if (this.entities[delta.id]) {
          Object.assign(this.entities[delta.id], delta.data || {});
        } else {
          this.entities[delta.id] = delta.data || {};
        }
      } else if (delta.type === 'entity.remove') {
        delete this.entities[delta.id];
        this.rootIds = this.rootIds.filter(id => id !== delta.id);
      }
    },

    getChildren(parentId) {
      return Object.entries(this.entities)
        .filter(([, e]) => e.parent === parentId)
        .map(([id]) => id);
    },

    reset() {
      this.entities = {};
      this.rootIds = [];
    },
  };

  // ── Display utilities ───────────────────────────────
  function escapeAttr(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function formatLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
  }

  // EditableField — renders as a span click-to-edit; edits posted via postMessage to parent
  function editableField(value, entityId, field, opts) {
    const cls = opts && opts.className ? ` ${opts.className}` : '';
    const display = String(value ?? '—');
    return `<span class="editable-value${cls}" data-entity-id="${escapeAttr(entityId)}" data-field="${escapeAttr(field)}" onclick="window.__startEdit(this)">${escapeHtml(display)}</span>`;
  }

  // Helper: get props from entity (v2 format nests props under entity.props)
  function getProps(entity) {
    return entity.props || {};
  }

  // ── Display Renderers ────────────────────────────────

  function renderPageDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const title = p.title || p.name || 'Untitled';
    const children = entityStore.getChildren(id).map(renderEntity).join('');
    return `<div class="aide-page">
      <div class="page-title">${editableField(title, id, p.title !== undefined ? 'title' : 'name', { className: 'page-title' })}</div>
      <div class="page-content">${children}</div>
    </div>`;
  }

  function renderCardDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const skipKeys = new Set(['_pos', '_schema', '_shape']);
    const name = p.name || p.title || '';
    const fields = Object.entries(p)
      .filter(([k]) => !k.startsWith('_') && !skipKeys.has(k) && k !== 'name' && k !== 'title')
      .map(([k, v]) => `<div class="card-field">
        <span class="field-label">${escapeHtml(formatLabel(k))}</span>
        ${editableField(v, id, k)}
      </div>`)
      .join('');
    const children = entityStore.getChildren(id).map(renderEntity).join('');
    return `<div class="aide-card">
      ${name ? `<div class="card-title">${editableField(name, id, p.title !== undefined ? 'title' : 'name')}</div>` : ''}
      ${fields}
      ${children}
    </div>`;
  }

  function renderSectionDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const title = p.title || p.name || 'Section';
    const uid = `sec_${id.replace(/[^a-z0-9]/gi, '_')}`;
    const children = entityStore.getChildren(id).map(renderEntity).join('');
    return `<div class="aide-section" id="${escapeAttr(uid)}">
      <div class="section-header" onclick="window.__toggleSection('${escapeAttr(uid)}')">
        <span class="collapse-icon" id="${escapeAttr(uid)}_icon">▾</span>
        <span class="section-title">${editableField(title, id, p.title !== undefined ? 'title' : 'name')}</span>
      </div>
      <div class="section-content" id="${escapeAttr(uid)}_content">${children}</div>
    </div>`;
  }

  function renderTableDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const children = entityStore.getChildren(id);
    if (children.length === 0) {
      return renderCardDisplay(id);
    }
    // Infer columns from child props
    const skipKeys = new Set(['_pos', '_schema', '_shape']);
    const colSet = new Set();
    children.forEach(cid => {
      const child = entityStore.entities[cid];
      const cp = child ? getProps(child) : {};
      Object.keys(cp).filter(k => !k.startsWith('_') && !skipKeys.has(k)).forEach(k => colSet.add(k));
    });
    const cols = Array.from(colSet);
    const thead = `<tr>${cols.map(c => `<th>${escapeHtml(formatLabel(c))}</th>`).join('')}</tr>`;
    const tbody = children.map(cid => {
      const child = entityStore.entities[cid];
      if (!child) return '';
      const cp = getProps(child);
      return `<tr>${cols.map(c => `<td>${editableField(cp[c], cid, c)}</td>`).join('')}</tr>`;
    }).join('');
    return `<div class="aide-table-wrap">
      <table class="aide-table">
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
      </table>
    </div>`;
  }

  function renderChecklistDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const children = entityStore.getChildren(id);
    if (children.length === 0) return renderCardDisplay(id);
    const items = children.map(cid => {
      const child = entityStore.entities[cid];
      if (!child) return '';
      const cp = getProps(child);
      const done = cp.done === true || cp.done === 'true' || cp.completed === true;
      const label = cp.task || cp.label || cp.name || cid;
      const labelField = cp.task !== undefined ? 'task' : (cp.label !== undefined ? 'label' : 'name');
      return `<div class="checklist-item${done ? ' done' : ''}">
        <input type="checkbox"${done ? ' checked' : ''} data-entity-id="${escapeAttr(cid)}" data-field="done" onchange="window.__toggleCheck(this)">
        <span class="item-label">${editableField(label, cid, labelField)}</span>
      </div>`;
    }).join('');
    return `<div class="aide-checklist">${items}</div>`;
  }

  function renderMetricDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const value = p.value ?? p.count ?? p.total ?? '';
    const label = p.label || p.name || '';
    return `<div class="aide-metric">
      <div class="metric-value">${escapeHtml(String(value))}</div>
      ${label ? `<div class="metric-label">${escapeHtml(label)}</div>` : ''}
    </div>`;
  }

  function renderTextDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const text = p.text || p.content || p.body || '';
    const field = p.text !== undefined ? 'text' : (p.content !== undefined ? 'content' : 'body');
    return `<div class="aide-text">${editableField(text, id, field)}</div>`;
  }

  function renderListDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const ordered = p.ordered === true;
    const children = entityStore.getChildren(id);
    const Tag = ordered ? 'ol' : 'ul';
    let items;
    if (children.length > 0) {
      items = children.map(cid => {
        const child = entityStore.entities[cid];
        const cp = child ? getProps(child) : {};
        const text = cp.text || cp.label || cp.name || cid;
        return `<li>${editableField(text, cid, 'text')}</li>`;
      }).join('');
    } else {
      const itemsArr = p.items || [];
      items = itemsArr.map(item => `<li>${escapeHtml(String(item))}</li>`).join('');
    }
    return `<${Tag} class="aide-list">${items}</${Tag}>`;
  }

  function renderImageDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const src = p.src || p.url || '';
    const caption = p.caption || '';
    return `<figure class="aide-image">
      ${src ? `<img src="${escapeAttr(src)}" alt="${escapeAttr(caption)}">` : ''}
      ${caption ? `<figcaption>${escapeHtml(caption)}</figcaption>` : ''}
    </figure>`;
  }

  function renderGridDisplay(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const p = getProps(entity);
    const cols = p.cols || (p._shape && p._shape[1]) || 10;
    const children = entityStore.getChildren(id);
    const cells = children.length > 0
      ? children.map(cid => {
          const child = entityStore.entities[cid];
          const cp = child ? getProps(child) : {};
          const label = cp.label || cp.name || cp.claim || cid;
          const claimed = cp.claim || cp.claimed || cp.owner;
          return `<div class="grid-cell${claimed ? ' claimed' : ''}">${escapeHtml(String(label))}</div>`;
        }).join('')
      : '';
    return `<div class="aide-grid-display" style="grid-template-columns:repeat(${parseInt(cols, 10) || 10},1fr)">${cells}</div>`;
  }

  // ── FallbackDisplay ─────────────────────────────────
  function renderFallbackEntity(id, depth) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const display = entity.display || 'entity';
    const props = Object.entries(entity)
      .filter(([k]) => !k.startsWith('_') && k !== 'parent' && k !== 'display')
      .map(([k, v]) => `<dt>${escapeHtml(k)}</dt><dd>${escapeHtml(typeof v === 'object' ? JSON.stringify(v) : String(v))}</dd>`)
      .join('');
    const children = entityStore.getChildren(id)
      .map(cid => renderFallbackEntity(cid, depth + 1))
      .join('');
    const indent = depth * 16;
    return `<div class="fb-entity" style="margin-left:${indent}px">
      <div class="fb-header"><span class="fb-id">${escapeHtml(id)}</span><span class="fb-display">[${escapeHtml(display)}]</span></div>
      ${props ? `<dl class="fb-props">${props}</dl>` : ''}
      ${children}
    </div>`;
  }

  // ── Display resolution ───────────────────────────────
  function resolveDisplay(entity) {
    const hint = (entity.display || '').toLowerCase();
    const id = entity._id || '';
    // Check hint first
    if (hint === 'page') return 'page';
    if (hint === 'card') return 'card';
    if (hint === 'table') return 'table';
    if (hint === 'checklist') return 'checklist';
    if (hint === 'section') return 'section';
    if (hint === 'metric') return 'metric';
    if (hint === 'text') return 'text';
    if (hint === 'list') return 'list';
    if (hint === 'image') return 'image';
    if (hint === 'grid') return 'grid';
    // Heuristic: if entity has children that look like checklist items
    if (hint === 'fallback' || !hint) return 'fallback';
    return 'fallback';
  }

  function renderEntity(id) {
    const entity = entityStore.entities[id];
    if (!entity) return '';
    const displayType = resolveDisplay(entity);
    switch (displayType) {
      case 'page':      return renderPageDisplay(id);
      case 'card':      return renderCardDisplay(id);
      case 'table':     return renderTableDisplay(id);
      case 'checklist': return renderChecklistDisplay(id);
      case 'section':   return renderSectionDisplay(id);
      case 'metric':    return renderMetricDisplay(id);
      case 'text':      return renderTextDisplay(id);
      case 'list':      return renderListDisplay(id);
      case 'image':     return renderImageDisplay(id);
      case 'grid':      return renderGridDisplay(id);
      default:          return renderFallbackEntity(id, 0);
    }
  }

  // ── Preview HTML builder ─────────────────────────────
  function buildPreviewHtml() {
    const css = document.getElementById('display-css-template').textContent;
    const entities = entityStore.rootIds.map(renderEntity).join('');

    // Inline script for iframe interactivity (direct edit, collapse)
    const iframeScript = `
      // Toggle section collapse
      window.__toggleSection = function(uid) {
        const content = document.getElementById(uid + '_content');
        const icon = document.getElementById(uid + '_icon');
        if (!content) return;
        const collapsed = content.style.display === 'none';
        content.style.display = collapsed ? '' : 'none';
        if (icon) icon.textContent = collapsed ? '▾' : '▸';
      };

      // Start inline edit
      window.__startEdit = function(el) {
        if (el.dataset.editing) return;
        el.dataset.editing = '1';
        const val = el.textContent === '—' ? '' : el.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'editable-input';
        input.value = val;
        input.style.width = Math.max(el.offsetWidth, 80) + 'px';
        el.parentNode.insertBefore(input, el);
        el.style.display = 'none';
        input.focus();
        input.select();

        const commit = () => {
          const newVal = input.value;
          el.textContent = newVal || '—';
          el.style.display = '';
          delete el.dataset.editing;
          input.remove();
          if (newVal !== val) {
            window.parent.postMessage({
              type: 'direct_edit',
              entity_id: el.dataset.entityId,
              field: el.dataset.field,
              value: newVal
            }, '*');
          }
        };

        input.addEventListener('blur', commit);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); commit(); }
          if (e.key === 'Escape') {
            el.style.display = '';
            delete el.dataset.editing;
            input.remove();
          }
        });
      };

      // Toggle checkbox
      window.__toggleCheck = function(el) {
        window.parent.postMessage({
          type: 'direct_edit',
          entity_id: el.dataset.entityId,
          field: el.dataset.field,
          value: el.checked
        }, '*');
        const item = el.closest('.checklist-item');
        if (item) item.classList.toggle('done', el.checked);
      };
    `;

    return `<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<style>${css}</style>
</head><body>
${entities || '<div class="empty">Send a message to get started.</div>'}
<script>${iframeScript}<\/script>
</body></html>`;
  }

  function refreshEntityPreview() {
    const frame = document.getElementById('preview-frame');
    // Only use entity preview when we have live entity data from WebSocket
    if (entityStore.rootIds.length > 0) {
      frame.srcdoc = buildPreviewHtml();
    }
  }

  // ── WebSocket Client ────────────────────────────────
  let aideWs = null;
  let wsConnectedAideId = null;

  function connectWebSocket(aideId) {
    // Close existing connection if switching aides
    if (aideWs && wsConnectedAideId !== aideId) {
      aideWs.close();
      aideWs = null;
    }
    if (aideWs && aideWs.readyState === WebSocket.OPEN) return;

    const wsId = aideId || 'new';
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${proto}//${location.host}/ws/aide/${wsId}`;

    try {
      aideWs = new WebSocket(url);
      wsConnectedAideId = wsId;

      aideWs.onopen = () => {
        console.log('[WS] connected:', url);
      };

      aideWs.onmessage = (event) => {
        let msg;
        try { msg = JSON.parse(event.data); } catch { return; }

        if (msg.type === 'stream.start') {
          // Reset entity store for new message
          entityStore.reset();
        } else if (msg.type === 'entity.create' || msg.type === 'entity.update' || msg.type === 'entity.remove') {
          entityStore.applyDelta(msg);
          refreshEntityPreview();
        } else if (msg.type === 'voice') {
          // Show voice text as assistant message in history
          if (msg.text) {
            // Only add if not already the last assistant message
            const last = conversationHistory[conversationHistory.length - 1];
            if (!last || last.role !== 'assistant' || last.content !== msg.text) {
              conversationHistory.push({ role: 'assistant', content: msg.text });
              renderHistory();
            }
          }
        } else if (msg.type === 'direct_edit.error') {
          console.warn('[WS] direct_edit rejected:', msg.error);
        } else if (msg.type === 'stream.end') {
          setSendingState(false);
          isSending = false;
        } else if (msg.type === 'stream.error') {
          const errMsg = msg.error || 'Stream error.';
          conversationHistory.push({ role: 'assistant', content: errMsg });
          renderHistory();
          setSendingState(false);
          isSending = false;
        }
      };

      aideWs.onerror = (err) => {
        console.warn('[WS] error, will fall back to HTTP:', err);
      };

      aideWs.onclose = () => {
        console.log('[WS] disconnected');
        if (wsConnectedAideId === wsId) {
          aideWs = null;
        }
      };
    } catch (err) {
      console.warn('[WS] could not connect:', err);
      aideWs = null;
    }
  }

  function sendViaWebSocket(content, messageId) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) return false;
    aideWs.send(JSON.stringify({ type: 'message', content, message_id: messageId }));
    return true;
  }

  function sendDirectEdit(entityId, field, value) {
    if (!aideWs || aideWs.readyState !== WebSocket.OPEN) {
      console.warn('[WS] direct_edit: no open connection');
      return;
    }
    aideWs.send(JSON.stringify({ type: 'direct_edit', entity_id: entityId, field, value }));
  }

  // Listen for postMessage from the preview iframe (direct edits + checkbox toggles)
  window.addEventListener('message', (event) => {
    if (!event.data || typeof event.data !== 'object') return;
    if (event.data.type === 'direct_edit') {
      const { entity_id, field, value } = event.data;
      sendDirectEdit(entity_id, field, value);
    }
  });

  // ── Screens ────────────────────────────────────────
  function showScreen(name) {
    document.getElementById('auth-screen').classList.toggle('active', name === 'auth');
    document.getElementById('dashboard').classList.toggle('active', name === 'dashboard');
    document.getElementById('editor').classList.toggle('active', name === 'editor');
    document.getElementById('editor-back').classList.toggle('visible', name === 'editor');
    document.getElementById('publish-btn-floating').classList.toggle('visible', name === 'editor');
  }

  // ── Auth ───────────────────────────────────────────
  async function checkAuth() {
    try {
      const res = await fetch('/auth/me', { credentials: 'include' });
      if (res.ok) {
        currentUser = await res.json();
        // Check if there's an aide ID in the URL
        const aideId = new URLSearchParams(location.search).get('aide');
        if (aideId) {
          openEditor(aideId);
        } else {
          loadDashboard();
        }
      } else {
        showScreen('auth');
      }
    } catch {
      showScreen('auth');
    }
  }

  document.getElementById('send-link-btn').addEventListener('click', async () => {
    const email = document.getElementById('email-input').value.trim();
    const msg = document.getElementById('auth-msg');
    if (!email) { msg.textContent = 'Enter your email.'; msg.className = 'auth-message error'; return; }

    const btn = document.getElementById('send-link-btn');
    btn.disabled = true;
    msg.textContent = '';

    try {
      const res = await fetch('/auth/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email }),
      });
      if (res.ok) {
        document.getElementById('auth-send-form').style.display = 'none';
        document.getElementById('auth-sent-msg').style.display = 'block';
      } else {
        const data = await res.json();
        msg.textContent = data.detail || 'Something went wrong.';
        msg.className = 'auth-message error';
        btn.disabled = false;
      }
    } catch {
      msg.textContent = 'Network error.';
      msg.className = 'auth-message error';
      btn.disabled = false;
    }
  });

  document.getElementById('email-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('send-link-btn').click();
  });

  // ── Dashboard ──────────────────────────────────────
  async function loadDashboard() {
    showScreen('dashboard');
    const grid = document.getElementById('aide-grid');
    const empty = document.getElementById('empty-state');
    grid.innerHTML = '';

    try {
      const res = await fetch('/api/aides', { credentials: 'include' });
      if (!res.ok) { showScreen('auth'); return; }
      const aides = await res.json();

      if (aides.length === 0) {
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      aides.forEach(aide => {
        const card = createAideCard(aide);
        grid.appendChild(card);
      });
    } catch {
      empty.style.display = 'block';
    }
  }

  function createAideCard(aide) {
    const card = document.createElement('div');
    card.className = 'aide-card';

    const updated = new Date(aide.updated_at).toLocaleDateString('en-US', {
      month: 'short', day: 'numeric', year: 'numeric'
    });

    card.innerHTML = `
      <div class="aide-card-title">${escapeHtml(aide.title)}</div>
      <div class="aide-card-meta">
        <span class="status-badge status-${aide.status}">${aide.status}</span>
        <span>${updated}</span>
      </div>
      <div class="aide-card-actions">
        <button class="icon-btn danger" title="Archive" data-id="${aide.id}">×</button>
      </div>
    `;

    card.addEventListener('click', (e) => {
      if (e.target.closest('.aide-card-actions')) return;
      openEditor(aide.id);
    });

    card.querySelector('.icon-btn.danger').addEventListener('click', async (e) => {
      e.stopPropagation();
      const confirmed = await confirmModal('Archive aide?', `"${aide.title}" will be archived.`, 'Archive');
      if (!confirmed) return;
      await archiveAide(aide.id);
    });

    return card;
  }

  async function archiveAide(aideId) {
    await fetch(`/api/aides/${aideId}/archive`, { method: 'POST', credentials: 'include' });
    loadDashboard();
  }

  function startNewAide() {
    openEditor(null);
  }

  document.getElementById('new-aide-btn').addEventListener('click', startNewAide);

  // ── Editor ─────────────────────────────────────────
  async function openEditor(aideId) {
    currentAideId = aideId;
    conversationHistory = [];
    pendingImage = null;

    renderHistory();
    clearImagePreview();
    document.getElementById('message-input').value = '';

    const frame = document.getElementById('preview-frame');

    if (aideId) {
      // Update URL to include aide ID (for refresh persistence)
      history.replaceState({}, '', `?aide=${aideId}`);

      // Existing AIde - load preview and conversation history
      frame.removeAttribute('srcdoc');
      frame.src = `/api/aides/${aideId}/preview`;

      // Load conversation history
      try {
        const res = await fetch(`/api/aides/${aideId}/history`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          conversationHistory = data.messages || [];
          renderHistory();
        }
      } catch (e) {
        console.error('Failed to load conversation history:', e);
      }
    } else {
      // New AIde - show placeholder
      frame.srcdoc = '<html><body style="background:#f9f9f9;display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#aaa;font-size:14px;">Send a message to get started.</body></html>';
    }

    showScreen('editor');
    document.getElementById('message-input').focus();

    // Connect WebSocket for real-time entity streaming
    entityStore.reset();
    connectWebSocket(aideId);
  }

  document.getElementById('editor-back').addEventListener('click', () => {
    currentAideId = null;
    history.replaceState({}, '', '/');
    loadDashboard();
  });

  // ── Publish ────────────────────────────────────────
  document.getElementById('publish-btn-floating').addEventListener('click', async () => {
    if (!currentAideId) return;

    const slug = await promptModal('Publish', 'Enter a URL slug for your page:', 'my-page');
    if (!slug) return;

    try {
      const res = await fetch(`/api/aides/${currentAideId}/publish`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug }),
      });
      if (res.ok) {
        const data = await res.json();
        await alertModal('Published', `Your page is live at: ${data.url}`);
      } else {
        const data = await res.json();
        await alertModal('Error', data.detail || 'Could not publish.');
      }
    } catch {
      await alertModal('Error', 'Network error.');
    }
  });

  // ── Sending messages ───────────────────────────────
  async function sendMessage() {
    if (isSending) return;
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    if (!text && !pendingImage) return;

    isSending = true;
    setSendingState(true);

    const userContent = text || '(image)';
    conversationHistory.push({ role: 'user', content: userContent });
    renderHistory();

    input.value = '';
    resizeTextarea(input);

    const messageId = 'msg_' + Math.random().toString(36).slice(2, 10);
    clearImagePreview();

    // Try WebSocket first (streaming entity deltas)
    const sentViaWs = !pendingImage && sendViaWebSocket(text, messageId);

    if (sentViaWs) {
      // WS handler will call setSendingState(false) on stream.end
      // Also call HTTP endpoint in background to persist state
      const body = {
        aide_id: currentAideId || undefined,
        message: text || ' ',
      };
      fetch('/api/message', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      }).then(async res => {
        if (res.status === 401) { showScreen('auth'); return; }
        if (res.ok) {
          const data = await res.json();
          currentAideId = data.aide_id;
          history.replaceState({}, '', `?aide=${data.aide_id}`);
          // Reconnect WS with real aide ID if we started without one
          if (wsConnectedAideId === 'new' && data.aide_id) {
            connectWebSocket(data.aide_id);
          }
        }
      }).catch(() => {});
      return;
    }

    // Fallback: HTTP-only path (used when no image support in WS or WS unavailable)
    const body = {
      aide_id: currentAideId || undefined,
      message: text || ' ',
      image: pendingImage ? pendingImage.base64 : undefined,
    };

    try {
      const res = await fetch('/api/message', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      if (res.status === 401) { showScreen('auth'); return; }

      const data = await res.json();

      if (!res.ok) {
        conversationHistory.push({ role: 'assistant', content: data.detail || 'Error.' });
        renderHistory();
        return;
      }

      // Update state
      currentAideId = data.aide_id;
      // Update URL for new AIde (persist across refresh)
      history.replaceState({}, '', `?aide=${data.aide_id}`);

      if (data.response_text) {
        conversationHistory.push({ role: 'assistant', content: data.response_text });
        renderHistory();
      }

      // Refresh preview: use page_url if accessible, otherwise fetch HTML
      refreshPreview(data.page_url);

    } catch (e) {
      conversationHistory.push({ role: 'assistant', content: 'Network error.' });
      renderHistory();
    } finally {
      isSending = false;
      setSendingState(false);
    }
  }

  async function refreshPreview(pageUrl) {
    // Load the preview URL in the iframe
    // Preview URL is now a backend proxy endpoint that handles auth
    const frame = document.getElementById('preview-frame');
    if (pageUrl) {
      // Clear srcdoc first - it takes precedence over src
      frame.removeAttribute('srcdoc');
      frame.src = pageUrl;
    }
  }

  let thinkingInterval = null;
  const thinkingStates = ['Thinking', 'Processing', 'Generating'];

  function setSendingState(sending) {
    document.getElementById('send-btn').disabled = sending;
    document.getElementById('message-input').disabled = sending;
    const indicator = document.getElementById('thinking-indicator');
    const thinkingText = document.getElementById('thinking-text');

    if (sending) {
      indicator.classList.add('visible');
      let stateIndex = 0;
      thinkingText.textContent = thinkingStates[0];
      thinkingInterval = setInterval(() => {
        stateIndex = (stateIndex + 1) % thinkingStates.length;
        thinkingText.textContent = thinkingStates[stateIndex];
      }, 2000);
    } else {
      indicator.classList.remove('visible');
      if (thinkingInterval) {
        clearInterval(thinkingInterval);
        thinkingInterval = null;
      }
    }
  }

  // ── History ────────────────────────────────────────
  function renderHistory() {
    const panel = document.getElementById('history-panel');
    if (conversationHistory.length === 0) {
      panel.classList.remove('open');
      panel.innerHTML = '';
      return;
    }

    panel.innerHTML = conversationHistory.map(m => `
      <div class="history-message ${m.role}">
        <div class="history-content">${escapeHtml(m.content)}</div>
      </div>
    `).join('');

    panel.classList.add('open');
    // Delay scroll to allow panel to expand
    setTimeout(() => {
      panel.scrollTop = panel.scrollHeight;
    }, 50);
  }

  // ── Image handling ─────────────────────────────────
  document.getElementById('image-btn').addEventListener('click', () => {
    document.getElementById('image-file-input').click();
  });

  document.getElementById('image-file-input').addEventListener('change', e => {
    const file = e.target.files[0];
    if (file) handleImageFile(file);
    e.target.value = '';
  });

  function handleImageFile(file) {
    if (file.size > 10 * 1024 * 1024) { alert('Image must be under 10 MB.'); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      const base64 = dataUrl.split(',')[1];
      pendingImage = { dataUrl, base64 };
      showImagePreview(dataUrl);
    };
    reader.readAsDataURL(file);
  }

  function showImagePreview(dataUrl) {
    const strip = document.getElementById('image-preview-strip');
    strip.innerHTML = `
      <div class="image-thumb">
        <img src="${dataUrl}" alt="attachment" />
        <button class="image-thumb-remove" id="remove-image-btn">×</button>
      </div>
    `;
    strip.classList.add('has-image');
    document.getElementById('remove-image-btn').addEventListener('click', clearImagePreview);
  }

  function clearImagePreview() {
    pendingImage = null;
    const strip = document.getElementById('image-preview-strip');
    strip.innerHTML = '';
    strip.classList.remove('has-image');
  }

  // Drag-and-drop
  let dragCounter = 0;
  document.addEventListener('dragenter', e => {
    if (e.dataTransfer.types.includes('Files')) {
      dragCounter++;
      document.getElementById('drag-overlay').classList.add('active');
    }
  });
  document.addEventListener('dragleave', () => {
    dragCounter--;
    if (dragCounter <= 0) {
      dragCounter = 0;
      document.getElementById('drag-overlay').classList.remove('active');
    }
  });
  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', e => {
    e.preventDefault();
    dragCounter = 0;
    document.getElementById('drag-overlay').classList.remove('active');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleImageFile(file);
  });

  // ── Input handlers ─────────────────────────────────
  const messageInput = document.getElementById('message-input');

  messageInput.addEventListener('input', () => resizeTextarea(messageInput));

  messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  document.getElementById('send-btn').addEventListener('click', sendMessage);

  function resizeTextarea(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  }

  // ── Modals ─────────────────────────────────────────
  function openModal({ title, desc, body = '', actions }) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-desc').textContent = desc;
    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-actions').innerHTML = actions;
    document.getElementById('modal-overlay').classList.add('active');
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.remove('active');
  }

  function confirmModal(title, desc, confirmLabel = 'Confirm') {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `
          <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
          <button class="btn btn-danger" id="modal-confirm">${escapeHtml(confirmLabel)}</button>
        `,
      });
      document.getElementById('modal-cancel').onclick = () => { closeModal(); resolve(false); };
      document.getElementById('modal-confirm').onclick = () => { closeModal(); resolve(true); };
    });
  }

  function promptModal(title, desc, placeholder = '') {
    return new Promise(resolve => {
      openModal({
        title, desc,
        body: `<input id="modal-input" class="form-input" placeholder="${escapeHtml(placeholder)}" style="margin-top:4px;" />`,
        actions: `
          <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
          <button class="btn btn-primary" id="modal-confirm">OK</button>
        `,
      });
      const inp = document.getElementById('modal-input');
      inp.focus();
      const submit = () => { const v = inp.value.trim(); closeModal(); resolve(v || null); };
      inp.addEventListener('keydown', e => { if (e.key === 'Enter') submit(); });
      document.getElementById('modal-cancel').onclick = () => { closeModal(); resolve(null); };
      document.getElementById('modal-confirm').onclick = submit;
    });
  }

  function alertModal(title, desc) {
    return new Promise(resolve => {
      openModal({
        title, desc,
        actions: `<button class="btn btn-primary" id="modal-ok">OK</button>`,
      });
      document.getElementById('modal-ok').onclick = () => { closeModal(); resolve(); };
    });
  }

  document.getElementById('modal-overlay').addEventListener('click', e => {
    if (e.target === document.getElementById('modal-overlay')) closeModal();
  });

  // ── Utils ──────────────────────────────────────────
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  // Handle magic link token in URL
  const urlParams = new URLSearchParams(location.search);
  const token = urlParams.get('token');
  if (token) {
    fetch(`/auth/verify?token=${encodeURIComponent(token)}`, { credentials: 'include' })
      .then(res => {
        history.replaceState({}, '', '/');
        if (res.ok) return res.json().then(user => { currentUser = user; loadDashboard(); });
        showScreen('auth');
      })
      .catch(() => showScreen('auth'));
  } else {
    checkAuth();
  }
</script>
</body>
</html>
