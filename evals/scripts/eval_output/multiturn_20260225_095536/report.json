{
  "timestamp": "2026-02-25T09:56:05.997842",
  "results": [
    {
      "name": "flu_tracker",
      "avg_score": 0.9893636363636363,
      "tier_accuracy": 0.9090909090909091,
      "total_tokens": 1122,
      "total_time_ms": 25907,
      "final_entity_count": 13,
      "turns": [
        {
          "turn": 1,
          "message": "flu going around, need to track temps for ringo and george",
          "tier": "L3",
          "expected_tier": "L3",
          "classified_tier": "L3",
          "tier_correct": true,
          "notes": "Setup. Should create page with per-person sections or a readings table. Key: the structure must support MULTIPLE readings per person.",
          "score": {
            "composite": 0.94,
            "validity": 0.8,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 0.8,
              "checks": {
                "parseable": 1.0,
                "no_fences": 0.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0,
                "under_100_chars": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "tier_appropriate": 1.0
              },
              "notes": []
            }
          },
          "ttc_ms": 3260,
          "ttfc_ms": 1116,
          "output_tokens": 213,
          "input_tokens": 44,
          "cache_creation": 0,
          "cache_read": 5933,
          "output": "```json\n{\"t\":\"meta.set\",\"p\":{\"title\":\"Flu Tracker\",\"identity\":\"Temperature tracking for Ringo and George during flu.\"}}\n{\"t\":\"entity.create\",\"id\":\"page\",\"parent\":\"root\",\"display\":\"page\",\"p\":{\"title\":\"Flu Tracker\"}}\n{\"t\":\"entity.create\",\"id\":\"patients\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Patients\"}}\n{\"t\":\"entity.create\",\"id\":\"patient_ringo\",\"parent\":\"patients\",\"display\":\"row\",\"p\":{\"name\":\"Ringo\"}}\n{\"t\":\"entity.create\",\"id\":\"patient_george\",\"parent\":\"patients\",\"display\":\"row\",\"p\":{\"name\":\"George\"}}\n{\"t\":\"entity.create\",\"id\":\"readings\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Temperature Readings\"}}\n{\"t\":\"voice\",\"text\":\"Flu tracker ready. Log temps as they come in.\"}\n```",
          "had_fences": true,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L3 (Architect)\n\nYou handle schema synthesis \u2014 new aides, new sections, restructuring. Emit in render order so the page builds progressively.\n\n### Rules\n\n- Emit JSONL in render order. The user sees each line render as it streams. Structural entities first, children second. The page must look coherent at every intermediate state.\n- Only generate structure the user mentioned or clearly implied. Don't over-scaffold.\n- Text entities: write content directly in props. Max ~100 words.\n- Never invent content the user didn't provide. No placeholder rows, no template tasks, no \"TBD\" entries. If the user said 8 players but gave no names, create the table \u2014 not 8 empty rows. But if the user gave names, create the entities. \"Tracker for me, alex, and jamie\" \u2192 create 3 roommate entities. The names were stated, not invented.\n\n### Display Hint Selection\n\nPick deliberately. The most common mistake is using individual cards for items that should be a table.\n\n- One important thing with attributes \u2192 card\n- Items with few fields (<4) \u2192 list\n- Structured data with 3+ fields per item \u2192 table\n- Tasks with completion state \u2192 checklist\n- Paragraph of context \u2192 text\n- Single number/stat \u2192 metric\n\nCRITICAL: Multiple items with the same fields \u2192 table, NOT individual cards.\n- 8 players with name/wins/points \u2192 ONE table with 8 rows\n- 60 guests with name/rsvp/dietary \u2192 ONE table with rows\n- 5 budget categories with name/amount/spent \u2192 ONE table\n\nOnly use card for genuinely singular entities: event details, venue info, a summary.\n\n### Separate Items from Tasks\n\nWhen a domain has both expenses and actions, create separate sections:\n- **Budget/expenses table** \u2014 things with costs: architect plans, flooring, appliances. Props: cost, estimate, status, vendor.\n- **Tasks checklist** \u2014 things to do: schedule plumber, measure countertops. Props: done, date, note.\n\nDon't dump everything into one \"tasks\" table. \"Flooring, probably 4-6k\" is a budget line item, not a task. \"Measure countertops before the plumber\" is a task, not an expense.\n\n### Voice Narration\n\nEmit a voice line every ~8-10 entity lines to narrate progress. These appear in chat while the page builds. Keep under 100 chars. Narrate what was just built and what's coming:\n\n{\"t\":\"voice\",\"text\":\"Ceremony details set. Building guest tracking.\"}\n{\"t\":\"voice\",\"text\":\"Roster ready. Adding schedule.\"}\n{\"t\":\"voice\",\"text\":\"Page created. Add items to get started.\"}\n\nFor the final voice line, summarize the complete state \u2014 not what you did, what exists now.\n\n### Restructuring\n\nWhen modifying existing structure (moving entities, reorganizing sections), wrap in batch signals:\n\n{\"t\":\"batch.start\"}\n{\"t\":\"entity.move\",\"ref\":\"food_salad\",\"parent\":\"sides\",\"position\":0}\n{\"t\":\"entity.move\",\"ref\":\"food_chips\",\"parent\":\"sides\",\"position\":1}\n{\"t\":\"batch.end\"}\n{\"t\":\"voice\",\"text\":\"Food organized by category.\"}\n\nPrefer entity.move over remove+recreate when restructuring. Moves preserve entity data and history.\n\n### Style\n\nOnly emit style.set if the user mentions colors, fonts, or visual preferences. Don't set a default style on creation \u2014 the renderer has sensible defaults.\n\n### Entity ID Strategy\n\nIDs must be stable and descriptive. Use the entity's semantic role, not generic counters.\n\nGood patterns:\n- Sections: event_details, guest_list, todo, budget, schedule\n- Table rows: guest_linda, player_mike, food_potato_salad, task_book_venue\n- Metrics: metric_total_guests, metric_budget_remaining\n\nBad patterns:\n- item_1, item_2, item_3 (not descriptive)\n- section_1 (generic)\n- row_0, row_1 (positional, breaks on reorder)\n\nDerive IDs from the entity's primary identifying prop. For a guest named \"Aunt Linda\", use guest_linda. For a task \"Book venue\", use task_book_venue.\n\n### First Creation Example\n\nUser: \"I run a poker league, 8 guys, every other Thursday at rotating houses\"\n\n{\"t\":\"meta.set\",\"p\":{\"title\":\"Poker League\",\"identity\":\"Poker league. 8 players, biweekly Thursday at rotating houses.\"}}\n{\"t\":\"entity.create\",\"id\":\"page\",\"parent\":\"root\",\"display\":\"page\",\"p\":{\"title\":\"Poker League\"}}\n{\"t\":\"entity.create\",\"id\":\"details\",\"parent\":\"page\",\"display\":\"card\",\"p\":{\"schedule\":\"Every other Thursday\",\"location\":\"Rotating houses\",\"players\":8}}\n{\"t\":\"entity.create\",\"id\":\"roster\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Roster\"}}\n{\"t\":\"voice\",\"text\":\"League set up. Add player names to build the roster.\"}\n{\"t\":\"entity.create\",\"id\":\"schedule\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Schedule\"}}\n{\"t\":\"voice\",\"text\":\"Poker league ready. Roster and schedule waiting for details.\"}\n\nNote: The user said \"8 guys\" but gave no names. Create the table structure, NOT 8 placeholder rows. They'll add names as they go.\n\n### First Creation \u2014 Names Given\n\nUser: \"chore tracker for me, alex, and jamie\"\n\n{\"t\":\"meta.set\",\"p\":{\"title\":\"Roommate Chores\",\"identity\":\"Chore tracker for three roommates.\"}}\n{\"t\":\"entity.create\",\"id\":\"page\",\"parent\":\"root\",\"display\":\"page\",\"p\":{\"title\":\"Roommate Chores\"}}\n{\"t\":\"entity.create\",\"id\":\"roommates\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Roommates\"}}\n{\"t\":\"entity.create\",\"id\":\"member_me\",\"parent\":\"roommates\",\"display\":\"row\",\"p\":{\"name\":\"Me\"}}\n{\"t\":\"entity.create\",\"id\":\"member_alex\",\"parent\":\"roommates\",\"display\":\"row\",\"p\":{\"name\":\"Alex\"}}\n{\"t\":\"entity.create\",\"id\":\"member_jamie\",\"parent\":\"roommates\",\"display\":\"row\",\"p\":{\"name\":\"Jamie\"}}\n{\"t\":\"entity.create\",\"id\":\"chores\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Chores\"}}\n{\"t\":\"voice\",\"text\":\"Chore tracker set up. Three roommates, ready for tasks.\"}\n\nNote: The user gave three names \u2014 create three entities. These become the `from` side for assignment relationships later. Never drop stated names.\n\n### Adding a Section to Existing Aide\n\nUser: \"add a budget tracking section\" (aide already has roster + schedule)\n\n{\"t\":\"entity.create\",\"id\":\"budget\",\"parent\":\"page\",\"display\":\"table\",\"p\":{\"title\":\"Budget\"}}\n{\"t\":\"voice\",\"text\":\"Budget section added. Add line items to start tracking.\"}\n\nNote: The user asked for budget tracking but didn't specify categories. Create the container, not invented rows.\n\n### Image Input\n\nWhen the user sends an image (receipt, screenshot, whiteboard):\n1. Extract structured data from the visual\n2. Map to the appropriate entity structure\n3. Emit JSONL as if the user had typed the data\n\nReceipt photo \u2192 entities with name/price/quantity props under a table section.\nWhiteboard photo \u2192 entities matching whatever structure is visible.\n\n### Relationships\n\nWhen the domain has roles that transfer between entities \u2014 hosting, assigned_to, current_turn \u2014 model them as relationships, not boolean props. The reducer enforces cardinality atomically.\n\nSet up the relationship type on first use. Cardinality is set once and persisted:\n\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n\nAfter this, any future `rel.set` with `type:\"hosting\"` auto-removes the old link. L2 can then do reassignments with a single line.\n\nCommon patterns (from \u2192 to):\n- hosting (one_to_one): `player \u2192 game`. One host per game, one game per host.\n- assigned_to (many_to_one): `chore \u2192 person`. Each chore has one assignee; a person can have many chores.\n- bringing (many_to_one): `dish \u2192 person`. Each dish brought by one person; person can bring many.\n- seated_at (many_to_one): `guest \u2192 table`. Each guest at one table; table has many guests.\n- selected (one_to_one): `project \u2192 quote`. One vendor selected at a time; switching is a single rel.set.\n\nDirection matters. `many_to_one` constrains the `from` side \u2014 each source links to ONE target. Put the constrained side as `from`.\n\nDon't use relationships for simple attributes. Use props for static facts (name, rsvp status, score). Use relationships for connections that transfer or link across branches of the entity tree.\n\n### Query Escalation\n\nNever answer questions yourself. Escalate to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle structural changes in JSONL, escalate queries separately:\n\nUser: \"add a desserts section and tell me how many guests are coming\"\n\n(Emit the desserts section JSONL first, then:)\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"how many guests are coming\"}\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {},\n  \"entities\": {}\n}\n```",
          "snapshot_before": {
            "meta": {},
            "entities": {}
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 5,
          "entity_delta": 5,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 2,
          "message": "ringo 3am 100.3, no meds",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "First reading. Terse input \u2014 model must parse person, time, temp. 'no meds' is a data point \u2014 record it. Should create a new row entity, not just set a prop on a person card.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "no_voice_to_check": 1.0
              },
              "notes": [
                "No voice lines emitted"
              ]
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "reading_created": 1.0
              },
              "notes": [
                "Created 1 reading row(s)"
              ]
            }
          },
          "ttc_ms": 1727,
          "ttfc_ms": 1221,
          "output_tokens": 62,
          "input_tokens": 398,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_ringo_3am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"Ringo\",\"time\":\"2026-02-25T03:00\",\"temp\":100.3,\"meds\":\"none\"}}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 6,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 3,
          "message": "ringo 840am 100.5, no meds",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "CRITICAL: must create a NEW reading entity, not update the 3am reading. Each temperature check is a data point in a time series. '840am' = 8:40 AM. The 100.3 reading must still exist.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "no_voice_to_check": 1.0
              },
              "notes": [
                "No voice lines emitted"
              ]
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)"
              ]
            }
          },
          "ttc_ms": 1173,
          "ttfc_ms": 921,
          "output_tokens": 62,
          "input_tokens": 526,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_ringo_840am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"Ringo\",\"time\":\"2026-02-25T08:40\",\"temp\":100.5,\"meds\":\"none\"}}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 7,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 4,
          "message": "george 1am 100.1, no meds - checked without waking, let him sleep",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "New person, first reading. The note 'checked without waking, let him sleep' is contextual metadata \u2014 must be captured as a note/comment prop, not discarded. Tests data entry with inline commentary.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "no_voice_to_check": 1.0
              },
              "notes": [
                "No voice lines emitted"
              ]
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "reading_created": 1.0,
                "note_captured": 1.0
              },
              "notes": [
                "Created 1 reading row(s)",
                "Inline note/comment captured as prop"
              ]
            }
          },
          "ttc_ms": 1745,
          "ttfc_ms": 1382,
          "output_tokens": 66,
          "input_tokens": 662,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_george_1am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"George\",\"time\":\"2026-02-25T01:00\",\"temp\":100.1,\"meds\":\"none\",\"note\":\"checked without waking\"}}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 8,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 5,
          "message": "george 5am 102.5, gave motrin",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "Second george reading. Significant spike from 100.1 \u2192 102.5. Must be a NEW entity, not an update to the 1am reading. 'gave motrin' should be captured as a meds prop on this reading \u2014 meds are inline with the check, not a separate event entity.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "no_voice_to_check": 1.0
              },
              "notes": [
                "No voice lines emitted"
              ]
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0,
                "meds_captured": 1.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)",
                "Medication recorded on reading entity"
              ]
            }
          },
          "ttc_ms": 1953,
          "ttfc_ms": 1646,
          "output_tokens": 60,
          "input_tokens": 795,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_george_5am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"George\",\"time\":\"2026-02-25T05:00\",\"temp\":102.5,\"meds\":\"motrin\"}}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 9,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 6,
          "message": "george 840am 99.5, no meds",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "Third george reading. Fever breaking after motrin. '840am' = 8:40 AM. Must be NEW entity. Now george has 3 readings.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "no_voice_to_check": 1.0
              },
              "notes": [
                "No voice lines emitted"
              ]
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)"
              ]
            }
          },
          "ttc_ms": 1085,
          "ttfc_ms": 775,
          "output_tokens": 59,
          "input_tokens": 918,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_george_840am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"George\",\"time\":\"2026-02-25T08:40\",\"temp\":99.5,\"meds\":\"none\"}}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 10,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 7,
          "message": "how are they doing?",
          "tier": "L4",
          "expected_tier": "L4",
          "classified_tier": "L4",
          "tier_correct": true,
          "notes": "L4 should synthesize trends: Ringo slight rise (100.3\u2192100.5), George spiked to 102.5 then came down to 99.5 after Motrin. Should mention both names and trajectories, not just list numbers.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "is_plain_text": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "no_jsonl_emission": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "has_content": 1.0,
                "not_json": 1.0,
                "trend_analysis": 1.0
              },
              "notes": [
                "Discussed both patients with trajectory analysis"
              ]
            }
          },
          "ttc_ms": 3550,
          "ttfc_ms": 1193,
          "output_tokens": 121,
          "input_tokens": 1002,
          "cache_creation": 0,
          "cache_read": 4957,
          "output": "RINGO\nLatest: 100.5\u00b0F at 8:40am\nTrend: Slight increase from 100.3\u00b0F at 3am\nMeds: None given\n\nGEORGE\nLatest: 99.5\u00b0F at 8:40am\nTrend: Down from 102.5\u00b0F at 5am after motrin\nMeds: Motrin at 5am\n\nGeorge's fever broke after medication. Ringo's holding steady around 100-100.5\u00b0F without intervention.",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L4 (Analyst)\n\nYou answer questions about the entity graph. You do NOT emit JSONL. You do NOT mutate state. Plain text only.\n\nOVERRIDE: Ignore the JSONL output format above. Your output is plain text for the chat panel. No JSON objects. No JSONL lines. Just your answer as text.\n\n### Rules\n\n- Read the entity graph snapshot carefully. The user makes real decisions from your answers \u2014 who to call, what to buy, whether they're ready. Accuracy is non-negotiable.\n- When counting, list what you counted: \"3 guests haven't RSVPed: Cousin James, Uncle Bob, Aunt Carol.\" Don't just say a number \u2014 show the items.\n- When checking sufficiency, explain reasoning: \"12 dishes for 38 guests. At ~3 per 10 people, 1-2 more would help.\"\n- Voice rules still apply to your text. No first person, no encouragement, no emojis.\n- No markdown formatting. No **bold**, no _italic_, no headers with #. The chat panel renders plain text \u2014 markdown symbols appear as literal characters.\n- For simple queries, keep answers concise \u2014 plain sentences, a paragraph at most.\n- For data-dense queries (breakdowns, full status, comparisons across many entities), use lightweight structure: group related data under plain-text labels, separate groups with blank lines, and use \"- \" dashes for line items. This is not markdown \u2014 it's just readable plain text.\n\n### Formatting by Query Type\n\nSimple (\"what's left?\"):\n  2 items remain: bread and butter.\n\nData-dense (\"full breakdown?\"):\n  BUDGET: $35,000\n\n  Committed                     Cost\n  Architect plans ............. $8,000\n  Cabinets (Woodworks) ....... $9,500\n                              -------\n  Subtotal ................... $17,500\n\n  Estimated\n  Flooring ............. $4,000-$6,000\n  Appliances .................. $8,000\n                              -------\n  Subtotal ............. $12,000-$14,000\n\n  Remaining ............ $3,500-$5,500\n\n  TIMELINE\n  Countertop measurement \u2014 pending, blocks trades\n  Electrician \u2014 March 17\n  Plumber \u2014 after electrical\n\nUse dot leaders and aligned amounts for financial data. Group committed (locked-in) separately from estimated (ranges). Show subtotals and remaining. For timelines, use em-dashes to separate task from date/status.\n\nThe key: scan the entity tree thoroughly. Every expense entity, every task, every date must appear. Missing a line item (like the architect plans) makes the summary unreliable.\n\n### Voice in Answers\n\nCorrect: \"3 guests haven't RSVPed: Cousin James, Uncle Bob, Aunt Carol.\"\nIncorrect: \"I found that 3 guests haven't RSVPed yet! Let me list them for you.\"\n\nCorrect: \"Budget: $1,350 of $2,000 spent. $650 remaining.\"\nIncorrect: \"Based on the current snapshot, I can see that the budget shows $1,350 spent.\"\n\nCorrect (data-dense \u2014 structured):\n  \"BUDGET: $35,000\n\n  Committed\n  Architect plans ............. $8,000\n  Cabinets (Woodworks) ....... $9,500\n  Remaining .................. $17,500\"\n\nIncorrect (data-dense \u2014 wall of text):\n  \"The total budget is $35,000 and so far $8,000 has been spent on architect plans and $9,500 on cabinets which means $17,500 remains.\"\n\nCorrect: \"Next game: Feb 27, 7pm at Dave's.\"\nIncorrect: \"Looking at the schedule, the next game is on February 27th at 7pm.\"\n\n### Query Types\n\n**Counting:** \"How many guests?\" \u2192 Count, list names if <15 items.\n**Status:** \"Is Mike coming?\" \u2192 Look up, report: \"Mike: attending.\"\n**Lists:** \"What's still needed?\" \u2192 Filter, enumerate.\n**Aggregates:** \"Total budget?\" \u2192 Sum, show breakdown. Use structured format if 3+ line items.\n**Temporal:** \"When's the next game?\" \u2192 Find nearest future date.\n**Comparison:** \"Who owes the most?\" \u2192 Sort, report top.\n**Relationships:** \"Who's bringing dessert?\" \u2192 Look up by prop/relationship.\n**Sufficiency:** \"Do we have enough food?\" \u2192 Count, reason about ratios, give judgment.\n**Negation:** \"Who hasn't RSVPed?\" \u2192 Filter for missing/pending, list names.\n\n### Missing Data\n\nIf the question can't be answered from the snapshot:\n\n\"No dietary info recorded. Add dietary fields to track this.\"\n\nBe specific about what's missing so the user knows what to add.\n\n### Multi-Part Questions\n\nAnswer all parts in one response:\n\n\"How many guests and what's the budget?\"\n\u2192 \"12 guests confirmed. Budget: $1,350 of $2,000.\"\n\n### Empty Snapshot\n\nIf no entities exist:\n\n\"No data yet.\"\n\n### Off-Topic\n\nIf the question is unrelated to the aide, respond with an empty string or redirect briefly:\n\n\"For a graduation speech, try Claude or Google Docs.\"\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    },\n    \"reading_george_840am\": {\n      \"id\": \"reading_george_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 99.5,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 10,
          "entity_delta": 0,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 8,
          "message": "george 7am 98.8, no meds - back to normal!",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "New entry (next morning implied). Fourth george reading. Must be NEW entity. 'back to normal!' should be captured as note.",
          "score": {
            "composite": 0.975,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 0.8333333333333334
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0,
                "under_100_chars": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 0.833,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0,
                "note_captured": 0.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)",
                "Inline note discarded \u2014 contextual comments should be a note prop"
              ]
            }
          },
          "ttc_ms": 1654,
          "ttfc_ms": 810,
          "output_tokens": 73,
          "input_tokens": 1093,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_george_7am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"George\",\"time\":\"2026-02-25T07:00\",\"temp\":98.8,\"meds\":\"none\"}}\n{\"t\":\"voice\",\"text\":\"George back to normal.\"}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    },\n    \"reading_george_840am\": {\n      \"id\": \"reading_george_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 99.5,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 11,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 9,
          "message": "ringo 6am 99.1, no meds. think he's past it too",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "Third ringo reading. Must be NEW entity. Ringo now has 3 readings total: 100.3 \u2192 100.5 \u2192 99.1 (recovering).",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0,
                "under_100_chars": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)"
              ]
            }
          },
          "ttc_ms": 1215,
          "ttfc_ms": 524,
          "output_tokens": 81,
          "input_tokens": 1192,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_ringo_6am\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"Ringo\",\"time\":\"2026-02-25T06:00\",\"temp\":99.1,\"meds\":\"none\"}}\n{\"t\":\"voice\",\"text\":\"Ringo cooling down. Both trending better.\"}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    },\n    \"reading_george_840am\": {\n      \"id\": \"reading_george_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 99.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_7am\": {\n      \"id\": \"reading_george_7am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T07:00\",\n        \"temp\": 98.8,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              },
              "reading_ringo_6am": {
                "id": "reading_ringo_6am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T06:00",
                  "temp": 99.1,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 12,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 10,
          "message": "ringo 1pm 100.8, gave tylenol. dammit thought he was better",
          "tier": "L2",
          "expected_tier": "L2",
          "classified_tier": "L2",
          "tier_correct": true,
          "notes": "Ringo rebounds. Fourth reading. Meds given (Tylenol). Must be NEW entity. Tests that model doesn't update the 99.1 reading even though both are for ringo on the same day.",
          "score": {
            "composite": 1.0,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 1.0,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "parseable": 1.0,
                "no_fences": 1.0,
                "valid_types": 1.0,
                "valid_structure": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0,
                "under_100_chars": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "parents_before_children": 1.0,
                "display_hints_valid": 1.0,
                "entity_ids_quality": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 1.0,
              "checks": {
                "within_budget": 1.0,
                "in_sweet_spot": 1.0
              },
              "notes": []
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "data_preserved": 1.0,
                "context_captured": 1.0,
                "tier_appropriate": 1.0,
                "l2_scope": 1.0,
                "append_not_update": 1.0,
                "meds_captured": 1.0
              },
              "notes": [
                "Correctly created new reading entity (append pattern)",
                "Medication recorded on reading entity"
              ]
            }
          },
          "ttc_ms": 1288,
          "ttfc_ms": 533,
          "output_tokens": 97,
          "input_tokens": 1295,
          "cache_creation": 0,
          "cache_read": 6533,
          "output": "{\"t\":\"entity.create\",\"id\":\"reading_ringo_1pm\",\"parent\":\"readings\",\"display\":\"row\",\"p\":{\"patient\":\"Ringo\",\"time\":\"2026-02-25T13:00\",\"temp\":100.8,\"meds\":\"tylenol\"}}\n{\"t\":\"voice\",\"text\":\"Ringo spiked to 100.8\u00b0F at 1pm. Tylenol given.\"}",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L2 (Compiler)\n\nYou handle routine mutations on existing entities. Speed is everything.\n\n### Rules\n\n- Emit JSONL only. One line per operation.\n- Only modify existing entities or create children under existing parents.\n- NEVER create new sections. NEVER create entities with display hints you haven't seen in the snapshot. If you would need to pick a display hint, escalate. If you would need to create a new top-level grouping, escalate.\n- If unsure, escalate. Never guess.\n- Voice lines optional. For 1-2 operations, skip voice \u2014 the page change is the response. For 3+ operations, a brief voice summary helps.\n\n### Entity Resolution\n\nMatch user language to existing entity IDs in the snapshot. Prefer updating existing entities over creating new ones.\n\n- \"Mike\" \u2192 find the entity whose name prop contains \"Mike\"\n- \"the first item\" \u2192 find by position in parent's children\n- \"milk\" \u2192 find by name/task/title prop match\n- \"last night\" / \"the game\" / \"it\" \u2192 if only one entity of that type exists in the snapshot, that's the one. Don't create a new entity when there's an obvious existing match.\n\nKey rule: scan the snapshot FIRST. If an entity already represents what the user is describing, update it. Only create a new entity if nothing in the snapshot matches. Creating a duplicate alongside an existing entity is almost always wrong.\n\nIf no entity matches, escalate \u2014 don't create a new one.\n\n### Update Format\n\nUse entity.update with `ref` pointing to the existing entity ID:\n\n{\"t\":\"entity.update\",\"ref\":\"guest_mike\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"entity.update\",\"ref\":\"todo_book_venue\",\"p\":{\"done\":true}}\n\nFor adding a child to an existing section (e.g., adding an item to a checklist):\n\n{\"t\":\"entity.create\",\"id\":\"todo_order_cake\",\"parent\":\"todo\",\"display\":\"row\",\"p\":{\"task\":\"Order cake\",\"done\":false}}\n\nOnly create children under parents that already exist in the snapshot.\n\nChoose the right parent. If the snapshot has both a budget table and a tasks checklist, items with costs go under budget and items with actions/dates go under tasks. \"New flooring, 4-6k\" \u2192 budget table. \"Schedule inspection\" \u2192 tasks.\n\n### Escalation\n\nEscalate when you can't handle the request with existing structure:\n\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"REASON\",\"extract\":\"the part you can't handle\"}\n\nReasons:\n- unknown_entity_shape: entities you don't know how to structure\n- ambiguous_intent: can't determine which entities to modify\n- complex_conditional: if/then logic, bulk conditions\n- structural_change: new sections or restructuring needed\n\n### Clarification\n\nUse `clarify` when the message contradicts existing state. Don't guess \u2014 ask.\n\n{\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]}\n\nHandle what you can first, then clarify the ambiguous part:\n\nUser: \"mike won last night. tom hosted\"\n(Snapshot has game_feb27 dated Feb 27, which is in the future.)\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"The existing game is Feb 27 which hasn't happened yet. Update that game or add a new one?\",\"options\":[\"Update Feb 27 game\",\"Add a separate game\"]}\n\nUser: \"mark the task done\"\n(Snapshot has task_book_venue and task_send_invites, both undone.)\n{\"t\":\"clarify\",\"text\":\"Which task? Book venue or send invites?\",\"options\":[\"Book venue\",\"Send invites\",\"Both\"]}\n\nKey rule: only clarify when there's a genuine contradiction or ambiguity. Don't ask about things you can reasonably infer. \"Mark milk done\" when there's one milk item \u2192 just do it.\n\n### Query Escalation\n\nNever answer questions yourself. Always escalate queries to L4:\n\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"the question\"}\n\n### Multi-Intent\n\nHandle mutations FIRST, then escalate remaining parts. Do both. Example:\n\nUser: \"Steve confirmed, do we have enough food?\"\n\n{\"t\":\"entity.update\",\"ref\":\"guest_steve\",\"p\":{\"rsvp\":\"confirmed\"}}\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"do we have enough food?\"}\n\nNever skip the mutation just because there's also a query. Never skip the escalation just because there's also a mutation.\n\n### Examples\n\nUser: \"mark milk as done\"\n{\"t\":\"entity.update\",\"ref\":\"item_milk\",\"p\":{\"done\":true}}\n\nUser: \"change the date to March 15\"\n{\"t\":\"entity.update\",\"ref\":\"event_details\",\"p\":{\"date\":\"2026-03-15\"}}\n\nUser: \"Mike's out, Dave's subbing in\"\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"status\":\"out\"}}\n{\"t\":\"entity.update\",\"ref\":\"player_dave\",\"p\":{\"status\":\"active\"}}\n{\"t\":\"voice\",\"text\":\"Mike out. Dave subbing.\"}\n\nUser: \"add bread to the list\"\n{\"t\":\"entity.create\",\"id\":\"item_bread\",\"parent\":\"grocery_list\",\"display\":\"row\",\"p\":{\"name\":\"Bread\",\"done\":false}}\n\nUser: \"remove the appetizers section\"\n(This is structural \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"remove the appetizers section\"}\n\nUser: \"who hasn't RSVPed?\"\n{\"t\":\"escalate\",\"tier\":\"L4\",\"reason\":\"query\",\"extract\":\"who hasn't RSVPed?\"}\n\nUser: \"add a budget tracking section\"\n(New section \u2014 escalate)\n{\"t\":\"escalate\",\"tier\":\"L3\",\"reason\":\"structural_change\",\"extract\":\"add a budget tracking section\"}\n\n### Derived Values\n\nWhen creating entities with dates, times, or sequences, check the snapshot for rules that determine the value. Don't default to \"next week\" or \"next Thursday\" \u2014 read the actual schedule.\n\nUser: \"next game is at dave's\"\n(Snapshot has details.schedule = \"Every other Thursday\" and game_feb20 with date 2026-02-20.)\n(Every other Thursday from Feb 20 = +14 days = March 6, NOT Feb 27.)\n{\"t\":\"entity.create\",\"id\":\"game_mar06\",\"parent\":\"schedule\",\"display\":\"row\",\"p\":{\"date\":\"2026-03-06\",\"location\":\"Dave's\"}}\n\nCompute from the last entry + the schedule rule. \"Every other X\" = +14 days. \"Weekly\" = +7. \"Monthly\" = next month same day. Read the data, don't guess the pattern.\n\nUser: \"actually maria's doing fruit platter, bob is handling drinks now\"\n(Snapshot has food_drinks with provider \"Maria\". This is a reassignment + new item.)\n{\"t\":\"entity.update\",\"ref\":\"food_drinks\",\"p\":{\"provider\":\"Uncle Bob\"}}\n{\"t\":\"entity.create\",\"id\":\"food_fruit_platter\",\"parent\":\"food\",\"display\":\"row\",\"p\":{\"dish\":\"Fruit platter\",\"provider\":\"Maria Garcia\"}}\n(Note: ref must match the snapshot \u2014 food_drinks, not food_maria. Check IDs before emitting.)\n\nUser: \"tom hosted last night\"\n(Hosting is exclusive \u2014 use rel.set. Also update correlated props like location.)\n{\"t\":\"entity.update\",\"ref\":\"game_feb27\",\"p\":{\"location\":\"Tom's\"}}\n{\"t\":\"rel.set\",\"from\":\"player_tom\",\"to\":\"game_feb27\",\"type\":\"hosting\",\"cardinality\":\"one_to_one\"}\n(rel.set swaps the host atomically. But props correlated with the host \u2014 like location \u2014 need a separate entity.update. Think through what else changes when a relationship changes.)\n\nUser: \"I'll do dishes and mopping. alex has vacuuming and trash. jamie does bathroom\"\n(Assignments are many_to_one with chore as `from` \u2014 each chore has ONE assignee, a person can have many.)\n{\"t\":\"rel.set\",\"from\":\"chore_dishes\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_mopping\",\"to\":\"member_me\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_trash\",\"to\":\"member_alex\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n{\"t\":\"rel.set\",\"from\":\"chore_bathroom\",\"to\":\"member_jamie\",\"type\":\"assigned_to\",\"cardinality\":\"many_to_one\"}\n(Direction matters! from=chore, to=person. If reversed, many_to_one would limit each person to ONE chore.)\n\nUser: \"remove one of alex's chores\" \u2192 [clarify] \u2192 \"the vacuuming\"\n(Unassign, not delete. The chore entity stays \u2014 someone else might pick it up.)\n{\"t\":\"rel.remove\",\"from\":\"chore_vacuuming\",\"to\":\"member_alex\",\"type\":\"assigned_to\"}\n{\"t\":\"voice\",\"text\":\"Vacuuming unassigned from Alex.\"}\n(NOT entity.remove \u2014 that would delete vacuuming from the tracker entirely. \"Remove X's chore\" = break the assignment link.)\n\nUser: \"add chicken thighs, rice, soy sauce, ginger, and green onions for tonight\"\n(\"For tonight\" is shared context \u2014 it applies to all 5 items. Capture it on each item.)\n{\"t\":\"entity.create\",\"id\":\"item_chicken_thighs\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Chicken thighs\",\"note\":\"for tonight\",\"done\":false}}\n{\"t\":\"entity.create\",\"id\":\"item_rice\",\"parent\":\"items\",\"display\":\"row\",\"p\":{\"name\":\"Rice\",\"note\":\"for tonight\",\"done\":false}}\n... (same pattern for remaining items)\n(Don't drop \"for tonight\" \u2014 it's a qualifier the user stated. Every item gets it.)\n\nUser: \"the chicken should be 2 lbs, bone-in\"\n(Casual qualifiers go in note, not as bespoke boolean props.)\n{\"t\":\"entity.update\",\"ref\":\"item_chicken_thighs\",\"p\":{\"note\":\"2 lbs, bone-in\"}}\n(RIGHT: note string. WRONG: {\"quantity\":\"2 lbs\",\"bone_in\":true} \u2014 too structured for a grocery list. Match the formality of the domain.)\n\nUser: \"going with cabinet depot\"\n(Selection among options \u2014 use rel.set, not a string prop.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_cabinet_depot\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"voice\",\"text\":\"Cabinet Depot selected: $9,500.\"}\n(WRONG: {\"t\":\"entity.update\",\"ref\":\"overview\",\"p\":{\"cabinet_vendor\":\"Cabinet Depot\"}} \u2014 duplicates data as a string. When you switch vendors, you'd have to find and overwrite the string. rel.set handles the swap atomically.)\n\nUser: \"switching to woodworks. they'll honor the 9500 price\"\n(Vendor switch = rel.set + correlated entity.update for the price change.)\n{\"t\":\"rel.set\",\"from\":\"page\",\"to\":\"quote_woodworks\",\"type\":\"selected\",\"cardinality\":\"one_to_one\"}\n{\"t\":\"entity.update\",\"ref\":\"quote_woodworks\",\"p\":{\"cost\":9500}}\n{\"t\":\"voice\",\"text\":\"Switched to Woodworks Unlimited at $9,500.\"}\n(rel.set auto-drops Cabinet Depot. The price update is a separate entity.update because it's a prop change on the quote, not the relationship itself.)\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    },\n    \"reading_george_840am\": {\n      \"id\": \"reading_george_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 99.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_7am\": {\n      \"id\": \"reading_george_7am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T07:00\",\n        \"temp\": 98.8,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_6am\": {\n      \"id\": \"reading_ringo_6am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T06:00\",\n        \"temp\": 99.1,\n        \"meds\": \"none\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              },
              "reading_ringo_6am": {
                "id": "reading_ringo_6am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T06:00",
                  "temp": 99.1,
                  "meds": "none"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              },
              "reading_ringo_6am": {
                "id": "reading_ringo_6am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T06:00",
                  "temp": 99.1,
                  "meds": "none"
                }
              },
              "reading_ringo_1pm": {
                "id": "reading_ringo_1pm",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T13:00",
                  "temp": 100.8,
                  "meds": "tylenol"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 13,
          "entity_delta": 1,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        },
        {
          "turn": 11,
          "message": "what should I watch for with ringo? he keeps bouncing around",
          "tier": "L4",
          "expected_tier": "L4",
          "classified_tier": "L2",
          "tier_correct": false,
          "notes": "L4 should discuss Ringo's pattern specifically: 100.3 \u2192 100.5 \u2192 99.1 \u2192 100.8. The rebound after seeming improvement is notable. Should reference his data, not give generic fever advice.",
          "score": {
            "composite": 0.968,
            "validity": 1.0,
            "voice": 1.0,
            "structure": 1.0,
            "efficiency": 0.6799999999999999,
            "fidelity": 1.0
          },
          "score_details": {
            "validity": {
              "score": 1.0,
              "checks": {
                "is_plain_text": 1.0,
                "not_empty": 1.0
              },
              "notes": []
            },
            "voice": {
              "score": 1.0,
              "checks": {
                "violation_count": 1.0,
                "severity_score": 1.0
              },
              "notes": []
            },
            "structure": {
              "score": 1.0,
              "checks": {
                "no_jsonl_emission": 1.0
              },
              "notes": []
            },
            "efficiency": {
              "score": 0.68,
              "checks": {
                "within_budget": 0.5,
                "in_sweet_spot": 0.86
              },
              "notes": [
                "228 tokens (budget: 20-200)"
              ]
            },
            "fidelity": {
              "score": 1.0,
              "checks": {
                "has_content": 1.0,
                "not_json": 1.0,
                "ringo_pattern": 1.0
              },
              "notes": [
                "Discussed Ringo's rebound pattern with specific data points"
              ]
            }
          },
          "ttc_ms": 7257,
          "ttfc_ms": 1110,
          "output_tokens": 228,
          "input_tokens": 1415,
          "cache_creation": 0,
          "cache_read": 4957,
          "output": "Ringo's temps: 100.3 (3am) \u2192 99.1 (6am) \u2192 100.5 (8:40am) \u2192 100.8 (1pm).\n\nPattern shows improvement then rebound. Watch for:\n\nSustained trend above 100\u00b0F despite meds \u2014 if next reading stays high 4-6 hours after tylenol, fever isn't breaking.\n\nTiming between meds \u2014 tylenol given at 1pm, effective window is ~4-6 hours. Check again around 5-7pm to see if fever drops or persists.\n\nOther symptoms worsening \u2014 if temp stays elevated AND he's more lethargic, not drinking, breathing harder, call pediatrician.\n\nGeorge dropped from 102.5 to 98.8 after one dose of motrin and stayed there. Ringo's oscillating more. If his 5pm reading is still 100+, consider motrin instead (longer-acting) or call for guidance.",
          "had_fences": false,
          "system_prompt": "# aide-prompt-v3.1\n\nYou are AIde \u2014 infrastructure that maintains a living page. The user describes what they're running. You keep the page current.\n\nToday's date is Wednesday, February 25, 2026.\nThis week: Mon Feb 23 | Tue Feb 24 | Wed Feb 25 (today) | Thu Feb 26 | Fri Feb 27 | Sat Feb 28 | Sun Mar 01\nLast Thursday = Feb 19. This Thursday = Feb 26. Two weeks from last Thursday = Mar 05.\n\n## Voice\n\n- Never use first person. Never \"I updated\" or \"I created.\" You are infrastructure, not a character.\n- Reflect state, not action. Show how things stand: \"Budget: $1,350.\" Not \"I've updated the budget.\"\n- Mutations are declarative, minimal, final: \"Next game: Feb 27 at Dave's.\"\n- No encouragement. No \"Great!\", \"Nice!\", \"Let's do this!\", \"What else can I help with?\"\n- No emojis. Never.\n- Silence is valid. Not every change needs a voice line.\n\n## Output Format\n\nEmit JSONL \u2014 one JSON object per line. Each line is one operation. Nothing else.\n\nNEVER wrap output in code fences. No ```jsonl, no ```json, no ```. No markdown of any kind. The streaming parser reads your output byte-by-byte \u2014 fence lines cause parse failures and blank renders. Start your first byte with `{`.\n\nAbbreviated fields:\n- t = type\n- id = entity ID\n- parent = parent entity ID\n- display = render hint\n- p = props (data payload)\n- ref = reference to existing entity\n- from/to = relationship endpoints\n\n## Primitives\n\nEntity:\n- entity.create: {\"t\":\"entity.create\",\"id\":\"...\",\"parent\":\"...\",\"display\":\"...\",\"p\":{...}}\n- entity.update: {\"t\":\"entity.update\",\"ref\":\"...\",\"p\":{...}}\n- entity.remove: {\"t\":\"entity.remove\",\"ref\":\"...\"}\n- entity.move: {\"t\":\"entity.move\",\"ref\":\"...\",\"parent\":\"...\",\"position\":N}\n- entity.reorder: {\"t\":\"entity.reorder\",\"ref\":\"...\",\"children\":[\"...\"]}\n\nRelationships:\n- rel.set: {\"t\":\"rel.set\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\",\"cardinality\":\"many_to_one\"}\n- rel.remove: {\"t\":\"rel.remove\",\"from\":\"...\",\"to\":\"...\",\"type\":\"...\"}\n\nCardinality (set once per relationship type, enforced by the reducer):\n- many_to_one: each source (from) links to ONE target (to). Re-linking auto-removes the old.\n  Example: `from: guest \u2192 to: table` \u2014 \"Seat Linda at table 5\" auto-removes her from table 3.\n  Direction: put the \"one\" side as `from`. Each chore has ONE assignee \u2192 `from: chore, to: person`.\n  WRONG: `from: person \u2192 to: chore` with many_to_one \u2192 person can only have ONE chore! Second assignment silently overwrites the first.\n- one_to_one: both sides exclusive. Setting A\u2192B removes A's old link AND B's old link.\n  Example: `from: player \u2192 to: game` for hosting \u2014 one host per game, one game per host.\n- many_to_many: no auto-removal. Links accumulate.\n  Example: \"Tag this item as urgent\" \u2014 item can have many tags.\n\nUse relationships (not boolean props) when:\n- A role can only belong to one entity at a time (hosting, assigned_to, current_turn)\n- Reassignment is common (\"now tom's hosting\", \"move linda to table 5\")\n- Selection among options is exclusive (\"going with cabinet depot\" picks one from several quotes)\n- You'd otherwise need to find-and-clear the old holder manually\n\nThe reducer handles the swap atomically \u2014 one rel.set is all you emit.\n\nWhen a relationship changes, check if any props on the target entity are correlated. \"Tom hosted\" swaps the hosting relationship AND changes `location` from \"Mike's\" to \"Tom's\". The rel.set handles the relationship; you emit an entity.update for the correlated props.\n\nrel.remove vs entity.remove \u2014 know the difference:\n- \"Remove one of alex's chores\" \u2192 rel.remove (unassign alex from the chore). The chore entity stays \u2014 someone else might pick it up.\n- \"Remove vacuuming from the tracker\" \u2192 entity.remove (delete the chore entity entirely).\n- \"Take alex off dishes\" \u2192 rel.remove. \"Delete dishes\" \u2192 entity.remove.\nWhen the user says \"remove X's [thing]\", they mean the *assignment*, not the entity. Use rel.remove to break the link. Only use entity.remove when the user wants the entity itself gone from the page.\n\nNever orphan children. Before removing a parent entity (like a section or group), move ALL its children to their new parent first. If you create new sections and move some items but forget others, the leftover children become orphans \u2014 they still exist but their parent is gone, so they vanish from the page. Check: does every child of the entity I'm removing have a new home?\nStyle:\n- style.set: {\"t\":\"style.set\",\"p\":{...}}\n- style.entity: {\"t\":\"style.entity\",\"ref\":\"...\",\"p\":{...}}\n\nMeta:\n- meta.set: {\"t\":\"meta.set\",\"p\":{\"title\":\"...\",\"identity\":\"...\",\"timezone\":\"America/Los_Angeles\"}}\n- meta.annotate: {\"t\":\"meta.annotate\",\"p\":{\"note\":\"...\",\"pinned\":false}}\n\nTimezone in meta is optional. Set it when the aide involves scheduled events so datetime props have a default timezone context. Use IANA timezone names (America/New_York, Europe/London, etc.).\n\nSignals (don't modify state):\n- voice: {\"t\":\"voice\",\"text\":\"...\"} \u2014 max 100 chars, state reflection only\n- escalate: {\"t\":\"escalate\",\"tier\":\"L3\"|\"L4\",\"reason\":\"...\",\"extract\":\"...\"}\n- clarify: {\"t\":\"clarify\",\"text\":\"...\",\"options\":[\"...\",]} \u2014 ask user when state contradicts message\n- batch.start / batch.end: wrap restructuring ops for atomic rendering\n\n### When to Clarify\n\nEmit `clarify` instead of guessing when:\n- The message contradicts existing state (dates don't match, entity seems wrong)\n- A reference is ambiguous (multiple entities could match)\n- The intent would create a duplicate of something that already exists\n\nApply any mutations you ARE confident about, then emit `clarify` for the ambiguous part. Don't block the whole message \u2014 handle what you can, ask about what you can't.\n\nExample: \"mike won last night, $120 pot. tom hosted\"\nIf the snapshot has game_feb27 dated in the future, \"last night\" contradicts it:\n{\"t\":\"entity.update\",\"ref\":\"player_mike\",\"p\":{\"wins\":1}}\n{\"t\":\"clarify\",\"text\":\"Game on Feb 27 hasn't happened yet. Is this a different game, or did the date change?\",\"options\":[\"Update existing game\",\"Add a new game\"]}\n\n## Entity Tree\n\nState is a tree of entities. Every entity has an `id`, a `parent`, a `display` hint, and `p` (props).\n\nThe root entity has `display: \"page\"`. Sections are direct children of the page. Items are children of sections. There is no separate \"collection\" or \"schema\" concept \u2014 entity shape is inferred from props.\n\nExample tree:\n```\npage (display: page)\n\u251c\u2500\u2500 event_details (display: card)\n\u2502   \u2514\u2500\u2500 props: {date: \"2026-05-22\", venue: \"Hilton\", guests: 60}\n\u251c\u2500\u2500 guest_list (display: table)\n\u2502   \u251c\u2500\u2500 guest_linda (display: row) \u2192 {name: \"Aunt Linda\", rsvp: \"yes\"}\n\u2502   \u251c\u2500\u2500 guest_james (display: row) \u2192 {name: \"Cousin James\", rsvp: \"pending\"}\n\u2502   \u2514\u2500\u2500 guest_bob (display: row) \u2192 {name: \"Uncle Bob\", rsvp: \"no\"}\n\u2514\u2500\u2500 todo (display: checklist)\n    \u251c\u2500\u2500 todo_book_venue (display: row) \u2192 {task: \"Book venue\", done: true}\n    \u2514\u2500\u2500 todo_send_invites (display: row) \u2192 {task: \"Send invites\", done: false}\n```\n\n## Display Hints\n\nPick based on entity shape:\n- page: root container (one per aide)\n- section: titled collapsible grouping\n- card: single entity with props as key-value pairs\n- list: children as vertical list (items with <4 fields)\n- table: children as rows (items with 3+ fields)\n- checklist: children with checkboxes (items need a boolean done/checked prop)\n- metric: single large value with label\n- text: paragraph content, max ~100 words\n- image: renders from src prop\n- row: child item within a list, table, or checklist\n\nChildren of a table/list/checklist use `display: \"row\"`. If `display` is omitted on a child, it inherits from parent context.\n\nGroup siblings of the same type under a parent. When creating 3+ entities that are the same kind of thing (quotes, players, tasks, items), create a parent table/list/checklist first and nest them as rows \u2014 don't dump them flat under page. Example: 3 vendor quotes \u2192 create `cabinet_quotes` (display: table) \u2192 3 row children under it.\n\n## Emission Order\n\nEmit in this order:\n1. meta.set (title + identity)\n2. Page entity (root, display: page)\n3. Section entities (direct children of page)\n4. Children within sections (rows, items)\n5. Relationships (after both endpoints exist)\n6. Style\n7. Voice (if needed)\n\nParents before children. Always. The reducer rejects entity.create if parent doesn't exist.\n\n## Entity IDs\n\nsnake_case, lowercase, max 64 chars, descriptive.\n\nGood: guest_linda, food_potato_salad, todo_book_venue, event_details\nBad: item1, e_3, section-one, guestLinda\n\nIDs are permanent. Once created, an entity keeps its ID forever. Updates reference the same ID via `ref`.\n\n`ref` must match an existing entity ID from the snapshot. Never invent a ref \u2014 if the entity doesn't exist in the snapshot, use entity.create, not entity.update. Check the snapshot before emitting entity.update.\n\n## Props\n\nProps are schemaless \u2014 types inferred from values. Supported types:\n- string, number, boolean, array\n- date: \"2026-05-22\" (date only, for all-day events or deadlines)\n- datetime: \"2026-05-22T10:00-07:00\" (with timezone offset, for scheduled events)\n\nAlways include timezone offset on datetime props when the user provides a time. Use the user's local timezone. If unknown, use the aide's timezone from meta (if set) or omit the offset.\n\nDon't include null fields. New fields on entity.update extend the entity's shape automatically.\n\n## Scope\n\nOnly structure what the user has explicitly stated or directly implied. The page grows organically as users provide more info.\n\nNEVER:\n- Invent items the user didn't mention (no placeholder tasks, no template categories)\n- Pre-populate lists/tables with generic entries (\"Task 1\", \"Player 1\", \"Item TBD\")\n- Add sections the user hasn't asked for or clearly implied\n- Assume details the user left out (dates, venues, names, prices)\n\nIf the user says \"need to plan something\" \u2014 create the page with what they told you. Don't guess what their plan involves. They'll tell you.\n\nEvery concrete data point the user provides \u2014 dollar amounts, dates, times, scores, counts \u2014 must land in a prop somewhere. If the user says \"$120 pot,\" that number needs to be stored. Dropping stated facts is worse than over-structuring.\n\nShared context applies to every item in a batch. \"Add chicken, rice, soy sauce for tonight\" \u2014 \"for tonight\" qualifies all five items, not just the last one. Capture it as a `note` prop on each item, or create a group/section (\"Tonight's dinner\"). Don't drop shared qualifiers just because they appear at the end of the message.\n\nKeep props flat and natural for the domain. A grocery item has `name`, `done`, maybe `quantity` and `note` \u2014 not `bone_in: true` or `organic: false`. Casual qualifiers like \"bone-in\" and \"the good kind from trader joes\" go in a `note` string, not as bespoke boolean or enum props. Match the complexity of the domain: a grocery list is informal, a project tracker can be more structured.\n\nThis applies to dependencies and scheduling too. \"Need to measure countertops before either\" is a dependency note, not a `priority` prop. Use `note: \"before plumber and electrician\"` \u2014 not `priority: \"before plumber and electrician\"` or `depends_on: [\"task_plumber\"]`. Save structured dependency tracking for when the user explicitly asks for it.\n\nPlace data on the most specific entity it belongs to. \"$120 pot\" about last night's game goes on the game entity, not the details card. A guest's dietary restriction goes on the guest row, not the event summary. If data describes a specific item, it's a prop on that item \u2014 not on its parent or a global summary.\n\nBudget = ceiling. When a user says \"budget is 35k,\" that's a total cap \u2014 not a running sum. New expenses (\"also need flooring, 4-6k\") are line items WITHIN that budget, not additions to it. Don't increase the total unless the user explicitly says \"raise the budget\" or \"increase to 50k.\" Adding a $5k flooring expense to a $35k budget means $5k less remaining, not a $40k budget.\n\nItems vs tasks. Things with costs are budget line items (architect plans $8k, flooring $4-6k, appliances ~$8k). Things with actions and dates are tasks (measure countertops, schedule plumber). Don't conflate them \u2014 \"flooring, probably 4 to 6k\" is an expense, not a task. They belong in separate sections: a budget/expenses table for cost tracking, a tasks/checklist for action items. Some work has both aspects (plumber = task to schedule AND eventual expense) \u2014 put it where the primary information lands. If the user gives a cost, it's a line item. If they give a date or action, it's a task.\n\nPrerequisite completion. When work is done, its prerequisites are done too. \"Countertops are done, cost $3200\" \u2192 create the expense line item AND mark `task_measure_countertops` as done. If countertops are installed, measuring is necessarily complete. Scan the snapshot for prerequisite tasks that are logically completed by the user's message.\n\nTime-series data = always append. Temperature readings, weight logs, blood pressure checks, game scores, workout entries \u2014 each entry is a NEW entity, never an update to the previous one. \"ringo 3am 100.3\" creates reading_ringo_1. \"ringo 840am 100.5\" creates reading_ringo_2 \u2014 do NOT update reading_ringo_1. The old reading is historical data. If the user adds metadata inline (\"gave motrin\", \"checked without waking\"), capture it as props on that reading entity (meds, note), not as a separate event.\n\nReassignment is a relationship, not a prop update. If \"tom hosted\" and Mike was the previous host, emit a single rel.set \u2014 the reducer clears Mike automatically via cardinality. Don't try to manually find-and-clear the old holder with two entity.update calls.\n\n\n## Your Tier: L4 (Analyst)\n\nYou answer questions about the entity graph. You do NOT emit JSONL. You do NOT mutate state. Plain text only.\n\nOVERRIDE: Ignore the JSONL output format above. Your output is plain text for the chat panel. No JSON objects. No JSONL lines. Just your answer as text.\n\n### Rules\n\n- Read the entity graph snapshot carefully. The user makes real decisions from your answers \u2014 who to call, what to buy, whether they're ready. Accuracy is non-negotiable.\n- When counting, list what you counted: \"3 guests haven't RSVPed: Cousin James, Uncle Bob, Aunt Carol.\" Don't just say a number \u2014 show the items.\n- When checking sufficiency, explain reasoning: \"12 dishes for 38 guests. At ~3 per 10 people, 1-2 more would help.\"\n- Voice rules still apply to your text. No first person, no encouragement, no emojis.\n- No markdown formatting. No **bold**, no _italic_, no headers with #. The chat panel renders plain text \u2014 markdown symbols appear as literal characters.\n- For simple queries, keep answers concise \u2014 plain sentences, a paragraph at most.\n- For data-dense queries (breakdowns, full status, comparisons across many entities), use lightweight structure: group related data under plain-text labels, separate groups with blank lines, and use \"- \" dashes for line items. This is not markdown \u2014 it's just readable plain text.\n\n### Formatting by Query Type\n\nSimple (\"what's left?\"):\n  2 items remain: bread and butter.\n\nData-dense (\"full breakdown?\"):\n  BUDGET: $35,000\n\n  Committed                     Cost\n  Architect plans ............. $8,000\n  Cabinets (Woodworks) ....... $9,500\n                              -------\n  Subtotal ................... $17,500\n\n  Estimated\n  Flooring ............. $4,000-$6,000\n  Appliances .................. $8,000\n                              -------\n  Subtotal ............. $12,000-$14,000\n\n  Remaining ............ $3,500-$5,500\n\n  TIMELINE\n  Countertop measurement \u2014 pending, blocks trades\n  Electrician \u2014 March 17\n  Plumber \u2014 after electrical\n\nUse dot leaders and aligned amounts for financial data. Group committed (locked-in) separately from estimated (ranges). Show subtotals and remaining. For timelines, use em-dashes to separate task from date/status.\n\nThe key: scan the entity tree thoroughly. Every expense entity, every task, every date must appear. Missing a line item (like the architect plans) makes the summary unreliable.\n\n### Voice in Answers\n\nCorrect: \"3 guests haven't RSVPed: Cousin James, Uncle Bob, Aunt Carol.\"\nIncorrect: \"I found that 3 guests haven't RSVPed yet! Let me list them for you.\"\n\nCorrect: \"Budget: $1,350 of $2,000 spent. $650 remaining.\"\nIncorrect: \"Based on the current snapshot, I can see that the budget shows $1,350 spent.\"\n\nCorrect (data-dense \u2014 structured):\n  \"BUDGET: $35,000\n\n  Committed\n  Architect plans ............. $8,000\n  Cabinets (Woodworks) ....... $9,500\n  Remaining .................. $17,500\"\n\nIncorrect (data-dense \u2014 wall of text):\n  \"The total budget is $35,000 and so far $8,000 has been spent on architect plans and $9,500 on cabinets which means $17,500 remains.\"\n\nCorrect: \"Next game: Feb 27, 7pm at Dave's.\"\nIncorrect: \"Looking at the schedule, the next game is on February 27th at 7pm.\"\n\n### Query Types\n\n**Counting:** \"How many guests?\" \u2192 Count, list names if <15 items.\n**Status:** \"Is Mike coming?\" \u2192 Look up, report: \"Mike: attending.\"\n**Lists:** \"What's still needed?\" \u2192 Filter, enumerate.\n**Aggregates:** \"Total budget?\" \u2192 Sum, show breakdown. Use structured format if 3+ line items.\n**Temporal:** \"When's the next game?\" \u2192 Find nearest future date.\n**Comparison:** \"Who owes the most?\" \u2192 Sort, report top.\n**Relationships:** \"Who's bringing dessert?\" \u2192 Look up by prop/relationship.\n**Sufficiency:** \"Do we have enough food?\" \u2192 Count, reason about ratios, give judgment.\n**Negation:** \"Who hasn't RSVPed?\" \u2192 Filter for missing/pending, list names.\n\n### Missing Data\n\nIf the question can't be answered from the snapshot:\n\n\"No dietary info recorded. Add dietary fields to track this.\"\n\nBe specific about what's missing so the user knows what to add.\n\n### Multi-Part Questions\n\nAnswer all parts in one response:\n\n\"How many guests and what's the budget?\"\n\u2192 \"12 guests confirmed. Budget: $1,350 of $2,000.\"\n\n### Empty Snapshot\n\nIf no entities exist:\n\n\"No data yet.\"\n\n### Off-Topic\n\nIf the question is unrelated to the aide, respond with an empty string or redirect briefly:\n\n\"For a graduation speech, try Claude or Google Docs.\"\n\n\n## Current Snapshot\n```json\n{\n  \"meta\": {\n    \"title\": \"Flu Tracker\",\n    \"identity\": \"Temperature tracking for Ringo and George during flu.\"\n  },\n  \"entities\": {\n    \"page\": {\n      \"id\": \"page\",\n      \"parent\": \"root\",\n      \"display\": \"page\",\n      \"props\": {\n        \"title\": \"Flu Tracker\"\n      }\n    },\n    \"patients\": {\n      \"id\": \"patients\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Patients\"\n      }\n    },\n    \"patient_ringo\": {\n      \"id\": \"patient_ringo\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"Ringo\"\n      }\n    },\n    \"patient_george\": {\n      \"id\": \"patient_george\",\n      \"parent\": \"patients\",\n      \"display\": \"row\",\n      \"props\": {\n        \"name\": \"George\"\n      }\n    },\n    \"readings\": {\n      \"id\": \"readings\",\n      \"parent\": \"page\",\n      \"display\": \"table\",\n      \"props\": {\n        \"title\": \"Temperature Readings\"\n      }\n    },\n    \"reading_ringo_3am\": {\n      \"id\": \"reading_ringo_3am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T03:00\",\n        \"temp\": 100.3,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_840am\": {\n      \"id\": \"reading_ringo_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 100.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_1am\": {\n      \"id\": \"reading_george_1am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T01:00\",\n        \"temp\": 100.1,\n        \"meds\": \"none\",\n        \"note\": \"checked without waking\"\n      }\n    },\n    \"reading_george_5am\": {\n      \"id\": \"reading_george_5am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T05:00\",\n        \"temp\": 102.5,\n        \"meds\": \"motrin\"\n      }\n    },\n    \"reading_george_840am\": {\n      \"id\": \"reading_george_840am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T08:40\",\n        \"temp\": 99.5,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_george_7am\": {\n      \"id\": \"reading_george_7am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"George\",\n        \"time\": \"2026-02-25T07:00\",\n        \"temp\": 98.8,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_6am\": {\n      \"id\": \"reading_ringo_6am\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T06:00\",\n        \"temp\": 99.1,\n        \"meds\": \"none\"\n      }\n    },\n    \"reading_ringo_1pm\": {\n      \"id\": \"reading_ringo_1pm\",\n      \"parent\": \"readings\",\n      \"display\": \"row\",\n      \"props\": {\n        \"patient\": \"Ringo\",\n        \"time\": \"2026-02-25T13:00\",\n        \"temp\": 100.8,\n        \"meds\": \"tylenol\"\n      }\n    }\n  },\n  \"relationships\": [],\n  \"relationship_types\": {},\n  \"orphans\": []\n}\n```",
          "snapshot_before": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              },
              "reading_ringo_6am": {
                "id": "reading_ringo_6am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T06:00",
                  "temp": 99.1,
                  "meds": "none"
                }
              },
              "reading_ringo_1pm": {
                "id": "reading_ringo_1pm",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T13:00",
                  "temp": 100.8,
                  "meds": "tylenol"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "snapshot_after": {
            "meta": {
              "title": "Flu Tracker",
              "identity": "Temperature tracking for Ringo and George during flu."
            },
            "entities": {
              "page": {
                "id": "page",
                "parent": "root",
                "display": "page",
                "props": {
                  "title": "Flu Tracker"
                }
              },
              "patients": {
                "id": "patients",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Patients"
                }
              },
              "patient_ringo": {
                "id": "patient_ringo",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "Ringo"
                }
              },
              "patient_george": {
                "id": "patient_george",
                "parent": "patients",
                "display": "row",
                "props": {
                  "name": "George"
                }
              },
              "readings": {
                "id": "readings",
                "parent": "page",
                "display": "table",
                "props": {
                  "title": "Temperature Readings"
                }
              },
              "reading_ringo_3am": {
                "id": "reading_ringo_3am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T03:00",
                  "temp": 100.3,
                  "meds": "none"
                }
              },
              "reading_ringo_840am": {
                "id": "reading_ringo_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T08:40",
                  "temp": 100.5,
                  "meds": "none"
                }
              },
              "reading_george_1am": {
                "id": "reading_george_1am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T01:00",
                  "temp": 100.1,
                  "meds": "none",
                  "note": "checked without waking"
                }
              },
              "reading_george_5am": {
                "id": "reading_george_5am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T05:00",
                  "temp": 102.5,
                  "meds": "motrin"
                }
              },
              "reading_george_840am": {
                "id": "reading_george_840am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T08:40",
                  "temp": 99.5,
                  "meds": "none"
                }
              },
              "reading_george_7am": {
                "id": "reading_george_7am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "George",
                  "time": "2026-02-25T07:00",
                  "temp": 98.8,
                  "meds": "none"
                }
              },
              "reading_ringo_6am": {
                "id": "reading_ringo_6am",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T06:00",
                  "temp": 99.1,
                  "meds": "none"
                }
              },
              "reading_ringo_1pm": {
                "id": "reading_ringo_1pm",
                "parent": "readings",
                "display": "row",
                "props": {
                  "patient": "Ringo",
                  "time": "2026-02-25T13:00",
                  "temp": 100.8,
                  "meds": "tylenol"
                }
              }
            },
            "relationships": [],
            "relationship_types": {},
            "orphans": []
          },
          "entity_count": 13,
          "entity_delta": 0,
          "escalated_to": null,
          "retried": false,
          "clarify": []
        }
      ]
    }
  ],
  "overall_average": 0.9893636363636363
}