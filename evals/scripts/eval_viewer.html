<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AIde Eval Viewer v3</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-deep:#08080e;--bg-panel:#0c0c14;--bg-surface:#111119;--bg-hover:#1a1a28;
  --border:#1a1a2c;--border-light:#252538;
  --text-primary:#e2e8f0;--text-secondary:#94a3b8;--text-muted:#4e5468;
  --accent-blue:#3b82f6;--accent-purple:#8b5cf6;--accent-green:#4ade80;
  --accent-red:#ef4444;--accent-amber:#fbbf24;--accent-cyan:#22d3ee;
  --font-sans:'DM Sans',system-ui,sans-serif;
  --font-serif:'Playfair Display',Georgia,serif;
  --font-mono:'JetBrains Mono','SF Mono',monospace;
}
body{font-family:var(--font-sans);background:var(--bg-deep);color:var(--text-primary);height:100vh;overflow:hidden;display:flex;flex-direction:column}

/* ── Top Bar ────────────────────────────────── */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid var(--border);background:var(--bg-panel);flex-shrink:0;height:40px}
.topbar-left,.topbar-right{display:flex;align-items:center;gap:12px}
.dot{width:6px;height:6px;border-radius:50%;transition:.3s}
.dot.on{background:var(--accent-red);box-shadow:0 0 8px var(--accent-red)}
.dot.off{background:var(--accent-green);box-shadow:0 0 6px rgba(74,222,128,.3)}
.lbl{font-size:9px;font-weight:600;letter-spacing:.7px;text-transform:uppercase;color:var(--text-muted)}
.sname{font-size:12px;color:var(--text-secondary)}
.badge{font-size:9px;color:var(--text-muted);background:var(--bg-surface);padding:1px 6px;border-radius:3px;border:1px solid var(--border)}
.info{font-size:10px;color:var(--text-muted)}
.btn{background:var(--bg-surface);border:1px solid var(--border-light);color:var(--text-secondary);padding:2px 10px;border-radius:4px;cursor:pointer;font-size:10px;font-family:var(--font-sans);transition:.15s}
.btn:hover{background:var(--bg-hover);color:var(--text-primary);border-color:var(--accent-blue)}

/* ── 3-Panel Layout ─────────────────────────── */
.main{flex:1;display:flex;overflow:hidden}

/* Left: Chat */
.panel-left{width:320;min-width:260px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg-panel)}
.panel-header{padding:6px 14px;font-size:9px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--text-muted);border-bottom:1px solid var(--border);background:var(--bg-surface)}
.chat-scroll{flex:1;overflow-y:auto;padding:10px 12px}
.chat-scroll::-webkit-scrollbar{width:3px}
.chat-scroll::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:2px}

/* Center: 4 Views */
.panel-center{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.view-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg-panel);flex-shrink:0}
.vtab{padding:7px 16px;font-size:10px;font-weight:500;letter-spacing:.3px;color:var(--text-muted);cursor:pointer;border-bottom:2px solid transparent;transition:.15s;user-select:none}
.vtab:hover{color:var(--text-secondary)}
.vtab.active{color:var(--accent-blue);border-bottom-color:var(--accent-blue)}
.view-content{flex:1;overflow:hidden;position:relative}
.view-pane{position:absolute;inset:0;overflow:auto;display:none}
.view-pane.active{display:block}
.view-pane::-webkit-scrollbar{width:4px}
.view-pane::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:2px}
.prompt-content{padding:16px;font-family:var(--font-mono);font-size:11px;line-height:1.65;color:#94a3b8;white-space:pre-wrap;word-break:break-word}
.prompt-content .prompt-section{color:var(--accent-blue);font-weight:600;margin-top:16px}
.prompt-content .prompt-snapshot{color:var(--accent-amber);opacity:.7;font-size:10px}

/* ── Cost Table ────────────────────────────── */
.cost-wrap{padding:20px}
.cost-table{width:100%;border-collapse:collapse;font-size:11px;font-family:var(--font-mono)}
.cost-table th{text-align:left;padding:6px 10px;font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);border-bottom:2px solid var(--border);position:sticky;top:0;background:var(--bg-panel)}
.cost-table th.r,.cost-table td.r{text-align:right}
.cost-table td{padding:5px 10px;border-bottom:1px solid var(--border);color:var(--text-secondary)}
.cost-table tr.current td{background:rgba(96,165,250,.08)}
.cost-table tr.total td{border-top:2px solid var(--border);font-weight:600;color:var(--text-primary)}
.cost-table .tier-pip{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:5px}
.cost-table .tier-pip.L4{background:#312e81}
.cost-table .tier-pip.L3{background:#0c3547}

/* Right: Metrics */
.panel-right{width:260;min-width:220px;border-left:1px solid var(--border);display:flex;flex-direction:column;background:var(--bg-panel);overflow-y:auto}
.panel-right::-webkit-scrollbar{width:3px}
.panel-right::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:2px}
.metrics-section{padding:12px 14px;border-bottom:1px solid var(--border)}
.metrics-section:last-child{border-bottom:none}
.mheader{font-size:9px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px}
.mrow{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:11px}
.mrow .mk{color:var(--text-muted)}
.mrow .mv{color:var(--text-secondary);font-family:var(--font-mono);font-size:10px}
.mrow .mv.good{color:var(--accent-green)}
.mrow .mv.warn{color:var(--accent-amber)}
.mrow .mv.bad{color:var(--accent-red)}
.tier-badge{padding:1px 8px;border-radius:3px;font-weight:600;font-size:10px;display:inline-block}
.tier-badge.L4{background:#312e81;color:#c4b5fd}
.tier-badge.L3{background:#0c3547;color:#7dd3fc}
.model-name{font-family:var(--font-mono);font-size:9px;color:var(--text-muted);margin-top:2px;word-break:break-all}

/* ── Resize Handles ───────────────────────── */
.resize-handle{width:4px;cursor:col-resize;background:transparent;transition:background .15s;flex-shrink:0;z-index:5}
.resize-handle:hover,.resize-handle.dragging{background:var(--accent-blue)}

/* ── Chat Bubbles ───────────────────────────── */
.turn-block{margin-bottom:12px}
.turn-block.future{opacity:.12;pointer-events:none}
.brow{display:flex;margin-bottom:4px}
.brow.user{justify-content:flex-end}
.brow.aide{justify-content:flex-start}
.bub{max-width:92%;padding:7px 11px;font-size:12px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
.bub.user{background:#12122a;color:#b8c0d6;border-radius:11px 11px 2px 11px;border:1px solid var(--border)}
.bub.aide{background:#fff;color:#2D2D2A;border-radius:11px 11px 11px 2px;border:1px solid #ddd}
.silent{font-size:10px;color:var(--text-muted);font-style:italic;padding:2px 8px}

/* ── Tool Pills ─────────────────────────────── */
.pills{display:flex;flex-wrap:wrap;gap:3px}
.pill{display:inline-flex;align-items:center;gap:3px;padding:1px 6px;border-radius:3px;font-family:var(--font-mono);font-size:9px;white-space:nowrap;border:1px solid}
.pill .a{font-weight:600}
.pill .eid{opacity:.65}
.pill.create{background:#052e22;color:#6ee7b7;border-color:#065f46}
.pill.update{background:#0c2d48;color:#7dd3fc;border-color:#0c4a6e}
.pill.remove{background:#3b0f0f;color:#fca5a5;border-color:#7f1d1d}
.pill.move{background:#2e1065;color:#c4b5fd;border-color:#4c1d95}
.pill.set{background:#3d2800;color:#fde68a;border-color:#713f12}

/* ── Raw Output View ────────────────────────── */
.raw-block{padding:12px 16px;font-family:var(--font-mono);font-size:11px;line-height:1.7;color:var(--text-secondary)}
.raw-line{padding:2px 0;border-bottom:1px solid var(--border)}
.raw-line .tag{font-weight:600;margin-right:6px}
.raw-line .tag.text{color:var(--accent-cyan)}
.raw-line .tag.tool{color:var(--accent-purple)}
.raw-line .content{color:var(--text-secondary)}

/* ── Entity Tree View ───────────────────────── */
.tree{padding:12px 16px;font-family:var(--font-mono);font-size:11.5px;line-height:1.7;overflow-x:auto}
.tree-node{padding:1px 0;white-space:nowrap}
.tree-indent{color:#444;user-select:none;white-space:pre}
.tree-connector{color:#444;user-select:none;white-space:pre}
.tree-root-marker{color:#4ade80;margin-right:4px}
.tree-id{color:#e2e8f0;font-weight:600;letter-spacing:0.02em}
.tree-badge{display:inline-block;font-size:9px;font-weight:600;padding:1px 5px;border-radius:3px;margin-left:4px;vertical-align:middle;line-height:1.4}
.tree-badge.display{background:#1e293b;color:#94a3b8;border:1px solid #334155}
.tree-badge.new{background:#052e22;color:#4ade80;border:1px solid #166534}
.tree-badge.mod{background:#0c2d48;color:#60a5fa;border:1px solid #1e40af}
.tree-badge.del{background:#3b0f0f;color:#f87171;border:1px solid #991b1b}
.tree-props{color:#64748b;font-size:10.5px;margin-left:6px}
.tree-props .pk{color:#94a3b8}
.tree-props .pv{color:#cbd5e1}
.tree-props .pv.str{color:#86efac}
.tree-props .pv.num{color:#fbbf24}
.tree-props .pv.bool{color:#c084fc}
.tree-node.is-removed{opacity:.3}
.tree-node.is-removed .tree-id{text-decoration:line-through}

/* ── Before/After View ──────────────────────── */
.diff-container{display:flex;height:100%}
.diff-half{flex:1;overflow:auto;padding:12px 16px;font-family:var(--font-mono);font-size:11px;line-height:1.6}
.diff-half:first-child{border-right:1px solid var(--border)}
.diff-half::-webkit-scrollbar{width:3px}
.diff-half::-webkit-scrollbar-thumb{background:var(--border-light);border-radius:2px}
.diff-label{font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.diff-entity{margin-bottom:8px;padding:6px 8px;border-radius:4px;border:1px solid var(--border)}
.diff-entity.added{border-color:#065f46;background:rgba(74,222,128,.04)}
.diff-entity.changed{border-color:#0c4a6e;background:rgba(59,130,246,.04)}
.diff-entity.removed{border-color:#7f1d1d;background:rgba(252,165,165,.04)}
.diff-eid{font-weight:600;color:var(--text-primary);font-size:11px}
.diff-prop{color:var(--text-muted);font-size:10px;margin-top:2px}
.diff-val-old{color:#fca5a5;text-decoration:line-through}
.diff-val-new{color:#6ee7b7}

/* ── Rendered View (iframe) ─────────────────── */
.preview-frame{width:100%;height:100%;border:none;background:#F7F5F2}
.preview-bar{display:flex;align-items:center;gap:8px;padding:4px 12px;background:#f8f8f6;border-bottom:1px solid #E0DDD8;flex-shrink:0}
.preview-dots{display:flex;gap:4px}
.preview-dots span{width:8px;height:8px;border-radius:50%}
.preview-url{font-size:10px;color:#999;font-family:var(--font-mono)}

/* ── Timeline ───────────────────────────────── */
.timeline{flex-shrink:0;background:var(--bg-panel);border-top:1px solid var(--border);padding:8px 20px 12px}
.controls{display:flex;align-items:center;gap:7px;margin-bottom:6px}
.cbtn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:13px;padding:2px 4px}
.cbtn:hover{color:var(--text-primary)}
.cbtn.pp{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;border:none;cursor:pointer}
.cbtn.pp.on{background:var(--accent-red);box-shadow:0 0 12px rgba(239,68,68,.3)}
.cbtn.pp.off{background:var(--accent-blue);box-shadow:0 0 12px rgba(59,130,246,.3)}
.hint{font-size:9px;color:var(--text-muted);margin-left:8px;letter-spacing:.2px}
.ptrack{height:5px;background:var(--bg-surface);border-radius:3px;cursor:pointer;position:relative}
.pfill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--accent-blue),var(--accent-purple));transition:width .2s}
.tmark{position:absolute;top:-4px;width:12px;height:12px;border-radius:50%;transform:translateX(-50%);cursor:pointer;border:2px solid;transition:.15s}
.tmark:hover{transform:translateX(-50%) scale(1.25)}
.tmark.L4{border-color:#4c1d95}.tmark.L3{border-color:#0c4a6e}
.tmark.on.L4{background:#312e81}.tmark.on.L3{background:#0c3547}
.tmark.off{background:var(--bg-surface)}

/* ── Drop Zone ──────────────────────────────── */
.drop{position:fixed;inset:0;z-index:100;background:rgba(8,8,14,.9);display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.drop.show{display:flex}
.drop-box{padding:40px 56px;border:2px dashed var(--accent-blue);border-radius:14px;text-align:center}
.drop-box h2{font-size:18px;font-weight:500;margin-bottom:6px}
.drop-box p{font-size:12px;color:var(--text-muted)}

/* ── Validation badges ──────────────────────── */
.vpass{color:var(--accent-green);font-size:10px}
.vfail{color:var(--accent-red);font-size:10px}
</style>
</head>
<body>

<div class="drop" id="drop"><div class="drop-box"><h2>Drop golden file</h2><p>.json from evals/golden_v3/</p></div></div>

<!-- Top Bar -->
<div class="topbar">
  <div class="topbar-left">
    <div class="dot off" id="dot"></div>
    <span class="lbl">Eval Viewer v3</span>
    <span class="sname" id="sname">—</span>
    <span class="badge" id="pbadge">—</span>
  </div>
  <div class="topbar-right">
    <span class="info" id="tinfo">—</span>
    <button class="btn" id="btnLoad">Load File</button>
    <input type="file" id="fi" accept=".json" style="display:none">
  </div>
</div>

<!-- Main 3 panels -->
<div class="main">
  <!-- LEFT: Chat -->
  <div class="panel-left" id="panelLeft">
    <div class="panel-header">Conversation</div>
    <div class="chat-scroll" id="chat"></div>
  </div>

  <div class="resize-handle" id="resizeLeft"></div>

  <!-- CENTER: 5 Views -->
  <div class="panel-center">
    <div class="view-tabs" id="vtabs">
      <div class="vtab active" data-view="rendered">Rendered</div>
      <div class="vtab" data-view="raw">Raw Output</div>
      <div class="vtab" data-view="diff">Before / After</div>
      <div class="vtab" data-view="tree">Entity Tree</div>
      <div class="vtab" data-view="prompt">Prompt</div>
      <div class="vtab" data-view="cost">Cost</div>
    </div>
    <div class="view-content">
      <div class="view-pane active" id="v-rendered">
        <div class="preview-bar">
          <div class="preview-dots"><span style="background:#fecaca"></span><span style="background:#fef3c7"></span><span style="background:#dcfce7"></span></div>
          <span class="preview-url" id="purl">toaide.com/s/—</span>
        </div>
        <iframe class="preview-frame" id="pframe" sandbox="allow-same-origin" title="Preview"></iframe>
      </div>
      <div class="view-pane" id="v-raw"></div>
      <div class="view-pane" id="v-diff"></div>
      <div class="view-pane" id="v-tree"></div>
      <div class="view-pane" id="v-prompt"></div>
      <div class="view-pane" id="v-cost"></div>
    </div>
  </div>

  <div class="resize-handle" id="resizeRight"></div>

  <!-- RIGHT: Metrics -->
  <div class="panel-right" id="panelRight">
    <div class="panel-header">Turn Metrics</div>
    <div id="metrics"></div>
  </div>
</div>

<!-- Timeline -->
<div class="timeline">
  <div class="controls">
    <button class="cbtn" id="cRew">⏮</button>
    <button class="cbtn" id="cPrev">◂</button>
    <button class="cbtn pp off" id="cPlay">▶</button>
    <button class="cbtn" id="cNext">▸</button>
    <button class="cbtn" id="cEnd">⏭</button>
    <span class="hint">←→ step · Space play · 1-6 views</span>
  </div>
  <div class="ptrack" id="ptrack"><div class="pfill" id="pfill"></div></div>
</div>

<script>
// ── State ──────────────────────────────────
let G = null, cur = 0, playing = false, pInt = null, activeView = "rendered";

const $ = id => document.getElementById(id);
const esc = s => { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; };
const hum = s => s ? s.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase()) : "";
// Normalize text_block entry: can be string or {text, timestamp_ms}
const tbText = tb => typeof tb === "string" ? tb : (tb?.text || "");
// Normalize tier for CSS class (L3->L4->L3 → L3)
const tierBase = t => (t || "").split("->").pop();

// Model name lookup
const MODELS = { L4: "claude-opus-4-5-20251101", L3: "claude-sonnet-4-5-20250929" };

// ── Snapshot Builder ───────────────────────
function snap(g, ti) {
  const s = { entities:{}, rels:[], meta:{} };
  for (let i = 0; i <= ti; i++) {
    const t = g.turns[i]; if (!t) break;
    for (const tc of t.tool_calls) {
      if (tc.name === "mutate_entity") {
        const p = tc.input;
        if (p.action === "create") s.entities[p.id] = { id:p.id, parent:p.parent||"root", display:p.display||null, props:{...(p.props||{})}, _removed:false };
        else if (p.action === "update" && s.entities[p.ref]) { Object.assign(s.entities[p.ref].props, p.props||{}); if (p.display) s.entities[p.ref].display = p.display; }
        else if (p.action === "remove" && s.entities[p.ref]) s.entities[p.ref]._removed = true;
        else if (p.action === "move" && s.entities[p.ref]) s.entities[p.ref].parent = p.parent;
      } else if (tc.name === "set_relationship") {
        const r = tc.input;
        if (r.action === "set") {
          // one_to_one: remove existing rels of same type+from before adding
          if (r.cardinality === "one_to_one") s.rels = s.rels.filter(x => !(x.from === r.from && x.type === r.type));
          s.rels.push({ from:r.from, to:r.to, type:r.type, cardinality:r.cardinality||"many_to_one" });
        } else if (r.action === "remove") {
          s.rels = s.rels.filter(x => !(x.from === r.from && x.to === r.to && x.type === r.type));
        }
      }
    }
  }
  const pg = Object.values(s.entities).find(e => e.parent === "root" && e.display === "page");
  if (pg) s.meta.title = pg.props.title || g.name;
  return s;
}

// ── Diff: which entities changed this turn ──
function turnDiff(g, ti) {
  const before = ti > 0 ? snap(g, ti - 1) : { entities:{} };
  const after = snap(g, ti);
  const changes = { added:[], updated:[], removed:[] };

  for (const [id, e] of Object.entries(after.entities)) {
    if (!before.entities[id]) { changes.added.push(e); }
    else if (e._removed && !before.entities[id]._removed) { changes.removed.push(e); }
    else if (JSON.stringify(e.props) !== JSON.stringify(before.entities[id].props) || e.display !== before.entities[id].display) {
      changes.updated.push({ id, before: before.entities[id], after: e });
    }
  }
  for (const id of Object.keys(before.entities)) {
    if (!after.entities[id]) changes.removed.push(before.entities[id]);
  }
  return { before, after, changes };
}

// ── Render: Snapshot → HTML ────────────────
function renderHTML(s) {
  const E = s.entities;
  const rels = s.rels || [];
  const ch = pid => Object.values(E).filter(e => e.parent === pid && !e._removed).sort((a,b) => a.id > b.id ? 1 : -1);
  const propStr = p => Object.entries(p).filter(([k])=>!k.startsWith("_")&&k!=="title"&&k!=="name").map(([k,v])=>`<span style="color:#8B8680;font-size:12px"><b style="color:#a09a90">${esc(hum(k))}</b> ${esc(v===true?"✓":v===false?"✗":String(v??"—"))}</span>`).join(" · ");

  // Build lookup: entity_id → inbound rels
  const inboundRels = {};
  const outboundRels = {};
  rels.forEach(r => {
    if (!inboundRels[r.to]) inboundRels[r.to] = [];
    inboundRels[r.to].push(r);
    if (!outboundRels[r.from]) outboundRels[r.from] = [];
    outboundRels[r.from].push(r);
  });

  // Format rels for an entity as small tags
  const relTags = (eid) => {
    const all = [...(inboundRels[eid]||[]).map(r => ({dir:"in",r})), ...(outboundRels[eid]||[]).map(r => ({dir:"out",r}))];
    if (!all.length) return "";
    return all.map(({dir,r}) => {
      const other = dir === "in" ? r.from : r.to;
      const otherName = E[other]?.props?.name || E[other]?.props?.title || hum(other);
      const color = r.type === "absent" ? "#dc2626" : r.type === "sub" ? "#f59e0b" : r.type === "selected" ? "#22c55e" : "#6366f1";
      return `<span style="display:inline-block;font-size:10px;padding:1px 6px;border-radius:3px;background:${color}18;color:${color};border:1px solid ${color}40;margin-left:4px">${esc(r.type)}${dir==="in"?" ← ":" → "}${esc(otherName)}</span>`;
    }).join("");
  };

  const tbl = sec => {
    const c = ch(sec.id); if(!c.length) return `<p style="color:#B5B0A8;font-style:italic;font-size:13px;padding:12px 0">Empty.</p>`;
    const ks=[...new Set(c.flatMap(x=>Object.keys(x.props).filter(k=>!k.startsWith("_"))))];
    // Check if any child has relationships
    const hasRels = c.some(x => inboundRels[x.id] || outboundRels[x.id]);
    return `<table style="width:100%;border-collapse:collapse"><thead><tr>${ks.map(k=>`<th style="text-align:left;padding:5px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#8B8680;border-bottom:2px solid #E0DDD8;font-weight:500">${esc(hum(k))}</th>`).join("")}${hasRels?`<th style="text-align:left;padding:5px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:#8B8680;border-bottom:2px solid #E0DDD8;font-weight:500"></th>`:""}</tr></thead><tbody>${c.map(x=>`<tr>${ks.map(k=>{const v=x.props[k];return`<td style="padding:7px 10px;border-bottom:1px solid #E8E5E0;font-size:13px">${esc(v===true?"✓":v===false?"✗":String(v??"—"))}</td>`}).join("")}${hasRels?`<td style="padding:7px 10px;border-bottom:1px solid #E8E5E0;font-size:13px">${relTags(x.id)}</td>`:""}</tr>`).join("")}</tbody></table>`;
  };

  const grid = sec => {
    const rows=sec.props._rows||8, cols=sec.props._cols||8, c=ch(sec.id), map={};
    c.forEach(x=>{if(x.props.row!==undefined&&x.props.col!==undefined) map[x.props.row+"_"+x.props.col]=x;});
    let h=`<div style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:1px;background:#bbb;padding:1px;border-radius:4px;overflow:hidden">`;
    for(let r=0;r<rows;r++) for(let c2=0;c2<cols;c2++){const cell=map[r+"_"+c2];const txt=cell?.props.piece||cell?.props.owner||"";const bg=(r+c2)%2===0?"#f0d9b5":"#b58863";h+=`<div style="background:${bg};min-height:26px;display:flex;align-items:center;justify-content:center;font-size:10px">${esc(txt)}</div>`;}
    return h+"</div>";
  };

  const ckl = sec => { const c=ch(sec.id); if(!c.length) return `<p style="color:#B5B0A8;font-style:italic;font-size:13px;padding:12px 0">Empty.</p>`; return c.map(x=>{const d=x.props.done||x.props.checked||false;const l=x.props.name||x.props.label||hum(x.id);return`<div style="padding:3px 0;font-size:13px;${d?"text-decoration:line-through;opacity:.5":""}">${d?"☑":"☐"} ${esc(l)}</div>`;}).join(""); };

  const rend = e => {
    const c2=ch(e.id), disp=e.display||"card", nm=e.props.title||e.props.name||hum(e.id);
    if(disp==="page") return `<h1 style="font-family:'Playfair Display',serif;font-size:26px;font-weight:600;margin-bottom:24px">${esc(nm)}</h1>`+c2.map(rend).join("");
    if(disp==="table") return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2>${tbl(e)}</div>`;
    if(disp==="section") return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2>${c2.map(rend).join("")}</div>`;
    if(disp==="checklist") return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2>${ckl(e)}</div>`;
    if(disp==="grid") return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2>${grid(e)}</div>`;
    if(disp==="metric") return `<div style="text-align:center;padding:16px"><div style="font-family:'Playfair Display',serif;font-size:32px;font-weight:700">${esc(String(e.props.value||e.props.count||"—"))}</div><div style="font-size:11px;color:#8B8680;text-transform:uppercase;letter-spacing:1px;margin-top:3px">${esc(nm)}</div></div>`;
    if(disp==="text") return `<div style="font-size:13px;line-height:1.6;color:#4A4A46;margin-bottom:16px"><p>${esc(e.props.content||e.props.text||"")}</p></div>`;
    if(disp==="list"){if(!c2.length) return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2><p style="color:#B5B0A8;font-style:italic;font-size:13px;padding:12px 0">Empty.</p></div>`; return `<div style="margin-bottom:20px"><h2 style="font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:1.5px;color:#6B6963;margin-bottom:10px">${esc(nm)}</h2>${c2.map(x=>`<div style="padding:5px 0;font-size:13px;border-bottom:1px solid #E8E5E0">${esc(x.props.name||hum(x.id))} ${propStr(x.props)}</div>`).join("")}</div>`;}
    // card
    return `<div style="background:#fff;border:1px solid #E0DDD8;border-radius:6px;padding:12px;margin-bottom:8px"><div style="font-weight:600;font-size:14px;margin-bottom:4px">${esc(nm)}${relTags(e.id)}</div><div>${propStr(e.props)}</div>${c2.map(rend).join("")}</div>`;
  };

  const body = ch("root").map(rend).join("");
  return `<!DOCTYPE html><html><head><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'DM Sans',system-ui,sans-serif;background:#F7F5F2;color:#2D2D2A;padding:28px 36px}</style></head><body>${body}</body></html>`;
}

// ── View: Raw Output ───────────────────────
function renderRaw(t) {
  let h = `<div class="raw-block">`;
  // Interleave text_blocks and tool_calls in emission order
  // We approximate by showing text blocks first if they exist, then tool calls
  if (t.text_blocks?.length) {
    t.text_blocks.forEach(tb => {
      h += `<div class="raw-line"><span class="tag text">TEXT</span><span class="content">${esc(tbText(tb))}</span></div>`;
    });
  }
  t.tool_calls.forEach((tc, i) => {
    const action = tc.input?.action || tc.input?.type || "call";
    const id = tc.input?.id || tc.input?.ref || tc.input?.from || "";
    const jsonStr = JSON.stringify(tc.input, null, 0);
    h += `<div class="raw-line"><span class="tag tool">${esc(tc.name)}</span><span class="content">${esc(jsonStr)}</span></div>`;
  });
  h += `</div>`;
  return h;
}

// ── View: Before/After Diff ────────────────
function renderDiffView(g, ti) {
  const d = turnDiff(g, ti);
  let left = `<div class="diff-label">Before (Turn ${ti})</div>`;
  let right = `<div class="diff-label">After (Turn ${ti + 1})</div>`;

  if (d.changes.added.length === 0 && d.changes.updated.length === 0 && d.changes.removed.length === 0) {
    right += `<div style="color:var(--text-muted);font-size:11px;padding:8px">No entity changes this turn (query only).</div>`;
  }

  d.changes.added.forEach(e => {
    right += `<div class="diff-entity added"><div class="diff-eid">+ ${esc(e.id)}</div>`;
    if (e.display) right += `<div class="diff-prop">display: <span class="diff-val-new">${esc(e.display)}</span></div>`;
    Object.entries(e.props).forEach(([k,v]) => {
      if (!k.startsWith("_")) right += `<div class="diff-prop">${esc(k)}: <span class="diff-val-new">${esc(String(v))}</span></div>`;
    });
    right += `</div>`;
  });

  d.changes.updated.forEach(({id, before: b, after: a}) => {
    left += `<div class="diff-entity changed"><div class="diff-eid">${esc(id)}</div>`;
    right += `<div class="diff-entity changed"><div class="diff-eid">~ ${esc(id)}</div>`;
    const allKeys = new Set([...Object.keys(b.props), ...Object.keys(a.props)]);
    allKeys.forEach(k => {
      if (k.startsWith("_")) return;
      const bv = b.props[k], av = a.props[k];
      if (JSON.stringify(bv) !== JSON.stringify(av)) {
        left += `<div class="diff-prop">${esc(k)}: <span class="diff-val-old">${esc(String(bv ?? "—"))}</span></div>`;
        right += `<div class="diff-prop">${esc(k)}: <span class="diff-val-new">${esc(String(av ?? "—"))}</span></div>`;
      }
    });
    left += `</div>`; right += `</div>`;
  });

  d.changes.removed.forEach(e => {
    left += `<div class="diff-entity removed"><div class="diff-eid">- ${esc(e.id)}</div></div>`;
  });

  return `<div class="diff-container"><div class="diff-half">${left}</div><div class="diff-half">${right}</div></div>`;
}

// ── View: Entity Tree ──────────────────────
function renderTree(g, ti) {
  const s = snap(g, ti);
  const d = turnDiff(g, ti);
  const addedIds = new Set(d.changes.added.map(e => e.id));
  const updatedIds = new Set(d.changes.updated.map(c => c.id));
  const removedIds = new Set(d.changes.removed.map(e => e.id));

  const ch = pid => Object.values(s.entities)
    .filter(e => e.parent === pid && !e._removed)
    .sort((a,b) => a.id > b.id ? 1 : -1);

  function fmtVal(v) {
    if (v === null || v === undefined) return '<span class="pv">null</span>';
    if (typeof v === "boolean") return `<span class="pv bool">${v}</span>`;
    if (typeof v === "number") return `<span class="pv num">${v}</span>`;
    const s = String(v);
    return `<span class="pv str">"${esc(s.length > 24 ? s.slice(0,22) + "…" : s)}"</span>`;
  }

  function renderProps(props) {
    const entries = Object.entries(props).filter(([k]) => !k.startsWith("_")).slice(0, 6);
    if (!entries.length) return "";
    return entries.map(([k,v]) => `<span class="pk">${esc(k)}</span>=${fmtVal(v)}`).join("  ");
  }

  function renderNode(e, prefix, isLast, isRoot) {
    const isNew = addedIds.has(e.id);
    const isMod = updatedIds.has(e.id);
    const isDel = e._removed || removedIds.has(e.id);
    const rmCls = isDel ? " is-removed" : "";

    // Connector
    let connector = "";
    if (isRoot) {
      connector = `<span class="tree-root-marker">◆</span>`;
    } else {
      connector = `<span class="tree-connector">${esc(prefix)}${isLast ? "└── " : "├── "}</span>`;
    }

    // Badges
    let badges = "";
    if (isNew) badges += `<span class="tree-badge new">new</span>`;
    if (isMod && !isNew) badges += `<span class="tree-badge mod">mod</span>`;
    if (isDel) badges += `<span class="tree-badge del">del</span>`;
    if (e.display) badges += `<span class="tree-badge display">${esc(e.display)}</span>`;
    if (e.props._pattern) badges += `<span class="tree-badge display" style="border-color:#6d28d9;color:#a78bfa">${esc(e.props._pattern)}</span>`;

    // Props
    const propsHtml = renderProps(e.props);

    let h = `<div class="tree-node${rmCls}">`;
    h += connector;
    h += `<span class="tree-id">${esc(e.id)}</span>`;
    h += badges;
    if (propsHtml) h += `<br><span class="tree-indent">${esc(isRoot ? "  " : prefix + (isLast ? "    " : "│   "))}</span><span class="tree-props">${propsHtml}</span>`;
    h += `</div>`;

    // Children
    const children = ch(e.id);
    const childPrefix = isRoot ? "" : prefix + (isLast ? "    " : "│   ");
    children.forEach((child, i) => {
      h += renderNode(child, childPrefix, i === children.length - 1, false);
    });
    return h;
  }

  // Header
  let html = `<div class="tree">`;
  html += `<div style="color:#64748b;margin-bottom:8px;font-size:10px;text-transform:uppercase;letter-spacing:0.1em">Entity Tree — Turn ${ti + 1}</div>`;
  const roots = ch("root");
  if (roots.length === 0) {
    html += `<div style="color:var(--text-muted);padding:12px">No entities yet.</div>`;
  }
  roots.forEach((r, i) => { html += renderNode(r, "", i === roots.length - 1, true); });

  // Relationships
  if (s.rels.length > 0) {
    // Diff: which rels are new this turn
    const prevRels = ti > 0 ? snap(g, ti - 1).rels : [];
    const prevRelKeys = new Set(prevRels.map(r => `${r.from}→${r.to}:${r.type}`));

    html += `<div style="margin-top:16px;padding-top:12px;border-top:1px solid #1e293b">`;
    html += `<div style="color:#64748b;margin-bottom:6px;font-size:10px;text-transform:uppercase;letter-spacing:0.1em">Relationships</div>`;
    s.rels.forEach(r => {
      const key = `${r.from}→${r.to}:${r.type}`;
      const isNewRel = !prevRelKeys.has(key);
      const newBadge = isNewRel ? `<span class="tree-badge new">new</span>` : "";
      const cardBadge = r.cardinality ? `<span class="tree-badge display" style="border-color:#6d28d9;color:#a78bfa;font-size:8px">${esc(r.cardinality)}</span>` : "";
      html += `<div class="tree-node" style="padding:2px 0">`;
      html += `<span style="color:#94a3b8">${esc(r.from)}</span>`;
      html += `<span style="color:#fbbf24;margin:0 6px">─${esc(r.type)}→</span>`;
      html += `<span style="color:#94a3b8">${esc(r.to)}</span>`;
      html += cardBadge + newBadge;
      html += `</div>`;
    });
    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

// ── View: Prompt ───────────────────────────
function renderPrompt(t) {
  if (!t.system_prompt) {
    return `<div class="prompt-content" style="color:var(--text-muted);font-style:italic">No prompt data. Re-run eval to capture prompts.</div>`;
  }
  const raw = t.system_prompt;
  // Highlight markdown headers and snapshot JSON
  let html = `<div class="prompt-content">`;
  const lines = raw.split("\n");
  let inSnapshot = false;
  for (const line of lines) {
    if (line.startsWith("## Current Snapshot")) {
      inSnapshot = true;
      html += `<span class="prompt-section">${esc(line)}</span>\n`;
    } else if (line.startsWith("```") && inSnapshot) {
      html += `<span class="prompt-snapshot">${esc(line)}</span>\n`;
    } else if (inSnapshot && !line.startsWith("```")) {
      html += `<span class="prompt-snapshot">${esc(line)}</span>\n`;
      if (line.trim() === "```") inSnapshot = false;
    } else if (line.startsWith("# ") || line.startsWith("## ") || line.startsWith("### ")) {
      html += `<span class="prompt-section">${esc(line)}</span>\n`;
    } else {
      html += esc(line) + "\n";
    }
  }
  html += `</div>`;
  return html;
}

// ── View: Cost Summary ─────────────────────
function renderCost(golden, currentTurn) {
  if (!golden) return "";

  const RATES = {
    L4: { in: 5, out: 25, cache_read: 0.5, cache_write: 6.25 },
    L3: { in: 3, out: 15, cache_read: 0.3, cache_write: 3.75 },
  };

  let totalIn = 0, totalOut = 0, totalCache = 0, totalCost = 0;
  let l4Turns = 0, l3Turns = 0, l4Cost = 0, l3Cost = 0;

  let rows = "";
  golden.turns.forEach((t, i) => {
    const base = tierBase(t.tier);
    const r = RATES[base] || RATES.L3;
    const tokIn = t.usage?.input_tokens || 0;
    const tokOut = t.usage?.output_tokens || 0;
    const tokCacheRead = t.usage?.cache_read || 0;
    const tokCacheWrite = t.usage?.cache_creation || 0;
    // input_tokens = fresh tokens AFTER cache breakpoint (already excludes cached)
    // cache_read = tokens served from cache (charged at 0.1x)
    // cache_creation = tokens written to cache (charged at 1.25x)
    const costIn = tokIn * r.in / 1e6;
    const costCacheRead = tokCacheRead * r.cache_read / 1e6;
    const costCacheWrite = tokCacheWrite * r.cache_write / 1e6;
    const costOut = tokOut * r.out / 1e6;
    const cost = costIn + costCacheRead + costCacheWrite + costOut;
    const tokTotal = tokIn + tokCacheRead + tokCacheWrite;
    const cachePct = tokTotal > 0 ? Math.round(tokCacheRead / tokTotal * 100) : 0;

    totalIn += tokIn; totalOut += tokOut; totalCache += tokCacheRead; totalCost += cost;
    if (base === "L4") { l4Turns++; l4Cost += cost; } else { l3Turns++; l3Cost += cost; }

    const cls = i === currentTurn ? " current" : "";
    rows += `<tr class="${cls}" style="cursor:pointer" onclick="go(${i})">
      <td>${i + 1}</td>
      <td><span class="tier-pip ${base}"></span>${t.tier}</td>
      <td>${MODELS[base]?.split("-").slice(1, 3).join("-") || "?"}</td>
      <td class="r">${tokIn.toLocaleString()}</td>
      <td class="r">${tokOut.toLocaleString()}</td>
      <td class="r">${tokCacheRead > 0 ? `${tokCacheRead.toLocaleString()} (${cachePct}%)` : "—"}</td>
      <td class="r">${t.ttfc_ms || "—"}</td>
      <td class="r">${t.ttc_ms || "—"}</td>
      <td class="r" style="color:${cost < 0.01 ? "var(--accent-green)" : cost < 0.05 ? "var(--text-secondary)" : "var(--accent-amber)"}">$${cost.toFixed(4)}</td>
    </tr>`;
  });

  // Total row
  rows += `<tr class="total">
    <td colspan="3">${golden.turns.length} turns (${l4Turns} L4, ${l3Turns} L3)</td>
    <td class="r">${totalIn.toLocaleString()}</td>
    <td class="r">${totalOut.toLocaleString()}</td>
    <td class="r">${totalCache > 0 ? totalCache.toLocaleString() : "—"}</td>
    <td class="r" colspan="2"></td>
    <td class="r">$${totalCost.toFixed(4)}</td>
  </tr>`;

  let h = `<div class="cost-wrap">`;
  h += `<table class="cost-table">
    <thead><tr>
      <th>#</th><th>Tier</th><th>Model</th>
      <th class="r">Fresh In</th><th class="r">Out</th><th class="r">Cache Read</th>
      <th class="r">TTFC</th><th class="r">TTC</th><th class="r">Cost</th>
    </tr></thead>
    <tbody>${rows}</tbody>
  </table>`;

  // Breakdown cards
  h += `<div style="display:flex;gap:16px;margin-top:20px">`;
  h += `<div style="flex:1;padding:12px;border-radius:6px;background:var(--bg-surface);border:1px solid var(--border)">
    <div style="font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">L4 (Opus)</div>
    <div style="font-size:20px;font-weight:600;color:#c4b5fd">$${l4Cost.toFixed(4)}</div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${l4Turns} turns · ${Math.round(l4Cost/totalCost*100)||0}% of total</div>
  </div>`;
  h += `<div style="flex:1;padding:12px;border-radius:6px;background:var(--bg-surface);border:1px solid var(--border)">
    <div style="font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">L3 (Sonnet)</div>
    <div style="font-size:20px;font-weight:600;color:#7dd3fc">$${l3Cost.toFixed(4)}</div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${l3Turns} turns · ${Math.round(l3Cost/totalCost*100)||0}% of total</div>
  </div>`;
  h += `<div style="flex:1;padding:12px;border-radius:6px;background:var(--bg-surface);border:1px solid var(--border)">
    <div style="font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Total</div>
    <div style="font-size:20px;font-weight:600;color:var(--text-primary)">$${totalCost.toFixed(4)}</div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${totalIn.toLocaleString()} fresh + ${totalCache.toLocaleString()} cached · ${totalOut.toLocaleString()} out</div>
  </div>`;
  // Cache savings: what would it cost if all cache_read tokens were charged at full input price?
  const noCacheCost = golden.turns.reduce((sum, t) => {
    const base = tierBase(t.tier);
    const r = RATES[base] || RATES.L3;
    const allIn = (t.usage?.input_tokens||0) + (t.usage?.cache_read||0) + (t.usage?.cache_creation||0);
    return sum + allIn * r.in / 1e6 + (t.usage?.output_tokens||0) * r.out / 1e6;
  }, 0);
  const saved = noCacheCost - totalCost;
  const savedPct = noCacheCost > 0 ? Math.round(saved / noCacheCost * 100) : 0;
  h += `<div style="flex:1;padding:12px;border-radius:6px;background:var(--bg-surface);border:1px solid var(--border)">
    <div style="font-size:9px;font-weight:600;letter-spacing:.6px;text-transform:uppercase;color:var(--text-muted);margin-bottom:6px">Cache Savings</div>
    <div style="font-size:20px;font-weight:600;color:var(--accent-green)">-$${saved.toFixed(4)}</div>
    <div style="font-size:10px;color:var(--text-muted);margin-top:2px">${savedPct}% saved vs no cache ($${noCacheCost.toFixed(4)})</div>
  </div>`;
  h += `</div>`;

  h += `</div>`;
  return h;
}

// ── Right Panel: Metrics ───────────────────
function renderMetrics(g, ti) {
  const t = g.turns[ti];
  const s = snap(g, ti);
  const entCount = Object.values(s.entities).filter(e => !e._removed).length;
  const relCount = s.rels.length;

  // Tool call breakdown
  const tcSummary = {};
  t.tool_calls.forEach(tc => { const a = tc.input?.action||"unknown"; tcSummary[a] = (tcSummary[a]||0) + 1; });

  // Cumulative stats
  let totalTools = 0, totalTokensIn = 0, totalTokensOut = 0, totalCacheRead = 0;
  for (let i = 0; i <= ti; i++) {
    totalTools += g.turns[i].tool_calls.length;
    totalTokensIn += g.turns[i].usage?.input_tokens || 0;
    totalTokensOut += g.turns[i].usage?.output_tokens || 0;
    totalCacheRead += g.turns[i].usage?.cache_read || 0;
  }

  let h = "";

  // Tier & Model
  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Routing</div>`;
  h += `<div class="mrow"><span class="mk">Tier</span><span class="tier-badge ${tierBase(t.tier)}">${esc(t.tier)}</span></div>`;
  h += `<div class="mrow"><span class="mk">Model</span><span class="mv">${MODELS[tierBase(t.tier)] || "unknown"}</span></div>`;
  h += `<div class="mrow"><span class="mk">Temperature</span><span class="mv">${tierBase(t.tier) === "L4" ? "0" : "0"}</span></div>`;
  h += `</div>`;

  // Latency
  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Latency</div>`;
  const ttfcCls = t.ttfc_ms < 500 ? "good" : t.ttfc_ms < 1500 ? "" : "warn";
  const ttcCls = t.ttc_ms < 2000 ? "good" : t.ttc_ms < 5000 ? "" : "warn";
  h += `<div class="mrow"><span class="mk">TTFC</span><span class="mv ${ttfcCls}">${t.ttfc_ms}ms</span></div>`;
  h += `<div class="mrow"><span class="mk">TTC</span><span class="mv ${ttcCls}">${t.ttc_ms}ms</span></div>`;
  const msPerTool = t.tool_calls.length > 0 ? Math.round(t.ttc_ms / t.tool_calls.length) : "—";
  h += `<div class="mrow"><span class="mk">ms/tool call</span><span class="mv">${msPerTool}</span></div>`;
  h += `</div>`;

  // Tokens
  const tokIn = t.usage?.input_tokens || 0;
  const tokOut = t.usage?.output_tokens || 0;
  const tokCR = t.usage?.cache_read || 0;
  const tokCW = t.usage?.cache_creation || 0;
  const tokTotalIn = tokIn + tokCR + tokCW;
  const cPct = tokTotalIn > 0 ? Math.round(tokCR / tokTotalIn * 100) : 0;

  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Tokens (this turn)</div>`;
  h += `<div class="mrow"><span class="mk">Fresh input</span><span class="mv">${tokIn.toLocaleString()}</span></div>`;
  h += `<div class="mrow"><span class="mk">Output</span><span class="mv">${tokOut.toLocaleString()}</span></div>`;
  if (tokCR > 0) {
    h += `<div class="mrow"><span class="mk">Cache read</span><span class="mv good">${tokCR.toLocaleString()} (${cPct}%)</span></div>`;
  }
  if (tokCW > 0) {
    h += `<div class="mrow"><span class="mk">Cache write</span><span class="mv warn">${tokCW.toLocaleString()}</span></div>`;
  }
  h += `<div class="mrow"><span class="mk">Total input</span><span class="mv">${tokTotalIn.toLocaleString()}</span></div>`;

  // Cost (Opus 4.5: $5/$25, Sonnet 4.5: $3/$15, cache read 0.1x, cache write 1.25x)
  const isL4 = tierBase(t.tier) === "L4";
  const turnCostIn = tokIn * (isL4 ? 5 : 3) / 1e6;
  const turnCostCR = tokCR * (isL4 ? 0.5 : 0.3) / 1e6;
  const turnCostCW = tokCW * (isL4 ? 6.25 : 3.75) / 1e6;
  const turnCostOut = tokOut * (isL4 ? 25 : 15) / 1e6;
  const turnCost = turnCostIn + turnCostCR + turnCostCW + turnCostOut;
  const costCls = turnCost < 0.01 ? "good" : turnCost < 0.05 ? "" : "warn";
  h += `<div class="mrow"><span class="mk">Est. cost</span><span class="mv ${costCls}">$${turnCost.toFixed(4)}</span></div>`;
  h += `</div>`;

  // Tool Calls
  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Tool Calls (this turn)</div>`;
  h += `<div class="mrow"><span class="mk">Total</span><span class="mv">${t.tool_calls.length}</span></div>`;
  Object.entries(tcSummary).forEach(([a, c]) => {
    h += `<div class="mrow"><span class="mk">${a}</span><span class="mv">${c}</span></div>`;
  });
  h += `<div class="mrow"><span class="mk">Text blocks</span><span class="mv">${t.text_blocks?.length || 0}</span></div>`;
  h += `</div>`;

  // Entity State
  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Snapshot State</div>`;
  h += `<div class="mrow"><span class="mk">Entities</span><span class="mv">${entCount}</span></div>`;
  h += `<div class="mrow"><span class="mk">Relationships</span><span class="mv">${relCount}</span></div>`;
  h += `</div>`;

  // Validation
  if (t.validation) {
    h += `<div class="metrics-section">`;
    h += `<div class="mheader">Validation</div>`;
    if (t.validation.passed) {
      h += `<div class="mrow"><span class="vpass">✓ All checks passed</span></div>`;
    } else {
      t.validation.issues.forEach(issue => {
        h += `<div class="mrow"><span class="vfail">⚠ ${esc(issue)}</span></div>`;
      });
    }
    if (t.validation.warnings?.length) {
      t.validation.warnings.forEach(w => {
        h += `<div class="mrow"><span class="mv warn">⚡ ${esc(w)}</span></div>`;
      });
    }
    h += `</div>`;
  }

  // Cumulative
  h += `<div class="metrics-section">`;
  h += `<div class="mheader">Cumulative (turns 1–${ti+1})</div>`;
  h += `<div class="mrow"><span class="mk">Tool calls</span><span class="mv">${totalTools}</span></div>`;
  h += `<div class="mrow"><span class="mk">Tokens in</span><span class="mv">${totalTokensIn.toLocaleString()}</span></div>`;
  h += `<div class="mrow"><span class="mk">Tokens out</span><span class="mv">${totalTokensOut.toLocaleString()}</span></div>`;
  if (totalCacheRead > 0) h += `<div class="mrow"><span class="mk">Cache reads</span><span class="mv">${totalCacheRead.toLocaleString()}</span></div>`;
  h += `</div>`;

  return h;
}

// ── Chat Render ────────────────────────────
function renderChat() {
  if (!G) { $("chat").innerHTML = `<p style="color:var(--text-muted);padding:16px;font-size:12px">Drop or load a golden file.</p>`; return; }
  let h = "";
  G.turns.forEach((t, i) => {
    const cls = i <= cur ? "turn-block active" : "turn-block future";
    h += `<div class="${cls}">`;
    h += `<div class="brow user"><div class="bub user">${esc(t.message)}</div></div>`;
    if (t.text_blocks?.length) t.text_blocks.forEach(tb => { h += `<div class="brow aide"><div class="bub aide">${esc(tbText(tb))}</div></div>`; });
    else if (t.tool_calls.length && i <= cur) h += `<div class="brow aide"><span class="silent">[${t.tool_calls.length} mutations]</span></div>`;
    h += `</div>`;
  });
  $("chat").innerHTML = h;
  const blocks = $("chat").querySelectorAll(".turn-block.active");
  if (blocks.length) blocks[blocks.length-1].scrollIntoView({behavior:"smooth",block:"end"});
}

// ── Master Update ──────────────────────────
function update() {
  if (!G) return;
  const t = G.turns[cur], total = G.turns.length;
  const s = snap(G, cur);
  const entCount = Object.values(s.entities).filter(e=>!e._removed).length;

  // Top bar
  $("sname").textContent = G.name || G.scenario_id;
  $("pbadge").textContent = G.pattern || "—";
  $("tinfo").textContent = `Turn ${cur+1}/${total} · ${entCount} entities`;

  // Preview
  if (activeView === "rendered") $("pframe").srcdoc = renderHTML(s);
  $("purl").textContent = `toaide.com/s/${(G.scenario_id||"demo").replace(/_/g,"-")}`;

  // Raw
  $("v-raw").innerHTML = renderRaw(t);

  // Diff
  $("v-diff").innerHTML = renderDiffView(G, cur);

  // Tree
  $("v-tree").innerHTML = renderTree(G, cur);

  // Prompt
  $("v-prompt").innerHTML = renderPrompt(t);

  // Cost
  $("v-cost").innerHTML = renderCost(G, cur);

  // Metrics
  $("metrics").innerHTML = renderMetrics(G, cur);

  // Progress
  const pct = total > 1 ? (cur/(total-1))*100 : 0;
  $("pfill").style.width = pct + "%";

  // Markers
  $("ptrack").querySelectorAll(".tmark").forEach((m,i) => {
    m.classList.toggle("on", i<=cur);
    m.classList.toggle("off", i>cur);
  });

  // Play state
  $("dot").className = "dot " + (playing?"on":"off");
  $("cPlay").className = "cbtn pp " + (playing?"on":"off");
  $("cPlay").textContent = playing ? "⏸" : "▶";

  renderChat();
}

// ── Navigation ─────────────────────────────
function go(n) { if(!G)return; cur=Math.max(0,Math.min(n,G.turns.length-1)); stop(); update(); }
function play() { if(!G)return; playing=true; pInt=setInterval(()=>{if(cur>=G.turns.length-1){stop();return;} cur++; update();},2500); update(); }
function stop() { playing=false; if(pInt){clearInterval(pInt);pInt=null;} update(); }
function toggle() { playing ? stop() : play(); }

// ── Tab Switching ──────────────────────────
function switchView(v) {
  activeView = v;
  document.querySelectorAll(".vtab").forEach(t => t.classList.toggle("active", t.dataset.view === v));
  document.querySelectorAll(".view-pane").forEach(p => p.classList.toggle("active", p.id === "v-"+v));
  if (G) update();
}

// ── File Loading ───────────────────────────
function loadFile(file) {
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    try {
      const d = JSON.parse(e.target.result);
      if(!d.turns?.length) { alert("Invalid golden file"); return; }
      G = d; cur = 0; stop();
      // Rebuild timeline markers
      $("ptrack").querySelectorAll(".tmark").forEach(m=>m.remove());
      G.turns.forEach((t,i)=>{
        const pct = G.turns.length>1?(i/(G.turns.length-1))*100:0;
        const m = document.createElement("div");
        m.className = `tmark ${tierBase(t.tier)} ${i===0?"on":"off"}`;
        m.style.left = pct+"%";
        m.title = `Turn ${i+1} (${t.tier})`;
        m.addEventListener("click", e=>{e.stopPropagation();go(i);});
        $("ptrack").appendChild(m);
      });
      update();
    } catch(err) { alert("Parse error: "+err.message); }
  };
  r.readAsText(file);
}

// ── Events ─────────────────────────────────
$("btnLoad").addEventListener("click", ()=>$("fi").click());
$("fi").addEventListener("change", e=>{if(e.target.files[0])loadFile(e.target.files[0]);});
$("cRew").addEventListener("click",()=>go(0));
$("cPrev").addEventListener("click",()=>go(cur-1));
$("cNext").addEventListener("click",()=>go(cur+1));
$("cEnd").addEventListener("click",()=>G&&go(G.turns.length-1));
$("cPlay").addEventListener("click",toggle);
$("ptrack").addEventListener("click",e=>{if(!G)return;const r=$("ptrack").getBoundingClientRect();const p=Math.max(0,Math.min((e.clientX-r.left)/r.width,1));go(Math.round(p*(G.turns.length-1)));});

document.querySelectorAll(".vtab").forEach(tab=>{
  tab.addEventListener("click",()=>switchView(tab.dataset.view));
});

document.addEventListener("keydown",e=>{
  if(e.key==="ArrowRight"||e.key==="l")go(cur+1);
  else if(e.key==="ArrowLeft"||e.key==="h")go(cur-1);
  else if(e.key===" "){e.preventDefault();toggle();}
  else if(e.key==="Home")go(0);
  else if(e.key==="End")G&&go(G.turns.length-1);
  else if(e.key==="d"||e.key==="D"){/* could toggle detail */}
  else if(e.key==="1")switchView("rendered");
  else if(e.key==="2")switchView("raw");
  else if(e.key==="3")switchView("diff");
  else if(e.key==="4")switchView("tree");
  else if(e.key==="5")switchView("prompt");
  else if(e.key==="6")switchView("cost");
});

document.addEventListener("dragenter",e=>{e.preventDefault();$("drop").classList.add("show");});

// ── Resize handles ───────────────────────────
(function initResize() {
  const panelL = $("panelLeft");
  const panelR = $("panelRight");
  const handleL = $("resizeLeft");
  const handleR = $("resizeRight");
  let dragging = null; // "left" or "right"
  let startX = 0, startW = 0;

  function onDown(which, e) {
    e.preventDefault();
    dragging = which;
    startX = e.clientX;
    startW = which === "left" ? panelL.offsetWidth : panelR.offsetWidth;
    (which === "left" ? handleL : handleR).classList.add("dragging");
    document.body.style.cursor = "col-resize";
    document.body.style.userSelect = "none";
  }
  handleL.addEventListener("mousedown", e => onDown("left", e));
  handleR.addEventListener("mousedown", e => onDown("right", e));

  document.addEventListener("mousemove", e => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    if (dragging === "left") {
      const w = Math.max(200, Math.min(600, startW + dx));
      panelL.style.width = w + "px";
      panelL.style.minWidth = w + "px";
    } else {
      const w = Math.max(180, Math.min(500, startW - dx));
      panelR.style.width = w + "px";
      panelR.style.minWidth = w + "px";
    }
  });

  document.addEventListener("mouseup", () => {
    if (!dragging) return;
    handleL.classList.remove("dragging");
    handleR.classList.remove("dragging");
    document.body.style.cursor = "";
    document.body.style.userSelect = "";
    dragging = null;
  });
})();
$("drop").addEventListener("dragleave",e=>{if(e.target===$("drop"))$("drop").classList.remove("show");});
$("drop").addEventListener("dragover",e=>e.preventDefault());
$("drop").addEventListener("drop",e=>{e.preventDefault();$("drop").classList.remove("show");if(e.dataTransfer.files[0])loadFile(e.dataTransfer.files[0]);});

// ── Resizable Panels ──────────────────────
(function initResize() {
  function makeDraggable(handleId, getPanel, side) {
    const handle = $(handleId);
    let startX, startW;
    function onDown(e) {
      e.preventDefault();
      const panel = getPanel();
      startX = e.clientX;
      startW = panel.getBoundingClientRect().width;
      handle.classList.add("dragging");
      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);
      document.body.style.cursor = "col-resize";
      document.body.style.userSelect = "none";
    }
    function onMove(e) {
      const panel = getPanel();
      const dx = e.clientX - startX;
      const newW = side === "left" ? startW + dx : startW - dx;
      const clamped = Math.max(180, Math.min(newW, window.innerWidth * 0.5));
      panel.style.width = clamped + "px";
      panel.style.minWidth = clamped + "px";
    }
    function onUp() {
      handle.classList.remove("dragging");
      document.removeEventListener("mousemove", onMove);
      document.removeEventListener("mouseup", onUp);
      document.body.style.cursor = "";
      document.body.style.userSelect = "";
    }
    handle.addEventListener("mousedown", onDown);
  }
  makeDraggable("resizeLeft", () => $("panelLeft"), "left");
  makeDraggable("resizeRight", () => $("panelRight"), "right");
})();

// ── Demo Data ──────────────────────────────
const DEMO = {"scenario_id":"poker_league_demo","name":"Poker League","pattern":"roster + timeline + ledger","timestamp":"2026-02-26T15:00:00Z","turns":[{"turn":1,"tier":"L4","message":"I'm running a poker league. 8 players, Thursday nights biweekly, rotating hosts and snack duty. Players are Mike, Dave, Sarah, Linda, Tom, Amy, Jake, and Priya. Mike's hosting first game, Dave's on snacks.","tool_calls":[{"name":"mutate_entity","input":{"action":"create","id":"page","parent":"root","display":"page","props":{"title":"Poker League — Spring 2026"}}},{"name":"mutate_entity","input":{"action":"create","id":"roster","parent":"page","display":"table","props":{"title":"Roster","_pattern":"roster"}}},{"name":"mutate_entity","input":{"action":"create","id":"player_mike","parent":"roster","props":{"name":"Mike","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_dave","parent":"roster","props":{"name":"Dave","status":"active","snack_duty":true}}},{"name":"mutate_entity","input":{"action":"create","id":"player_sarah","parent":"roster","props":{"name":"Sarah","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_linda","parent":"roster","props":{"name":"Linda","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_tom","parent":"roster","props":{"name":"Tom","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_amy","parent":"roster","props":{"name":"Amy","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_jake","parent":"roster","props":{"name":"Jake","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"player_priya","parent":"roster","props":{"name":"Priya","status":"active","snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"schedule","parent":"page","display":"table","props":{"title":"Schedule","_pattern":"timeline"}}},{"name":"mutate_entity","input":{"action":"create","id":"game_1","parent":"schedule","props":{"date":"2026-02-19","host":"Mike","snacks":"Dave","status":"upcoming"}}}],"text_blocks":["Poker league. 8 players, biweekly Thursday.","Roster and schedule set. Mike hosting game 1, Dave on snacks."],"usage":{"input_tokens":1850,"output_tokens":680,"cache_read":0},"ttfc_ms":1320,"ttc_ms":4800,"validation":{"passed":true,"issues":[]}},{"turn":2,"tier":"L3","message":"We need to track standings too. Points, wins, and losses.","tool_calls":[{"name":"mutate_entity","input":{"action":"create","id":"standings","parent":"page","display":"table","props":{"title":"Standings","_pattern":"ledger","_sort_by":"points","_sort_order":"desc"}}}],"text_blocks":["Standings section added. Tracking points, wins, losses."],"usage":{"input_tokens":2400,"output_tokens":220,"cache_read":1600},"ttfc_ms":420,"ttc_ms":1200,"validation":{"passed":true,"issues":[]}},{"turn":3,"tier":"L3","message":"Mike's out this week. Dave's subbing in for hosting. Dave's on snacks since it was Mike's rotation.","tool_calls":[{"name":"mutate_entity","input":{"action":"update","ref":"player_mike","props":{"status":"out"}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_dave","props":{"snack_duty":true}}},{"name":"mutate_entity","input":{"action":"update","ref":"game_1","props":{"host":"Dave","snacks":"Dave"}}}],"text_blocks":["Mike out. Dave hosting and on snacks. 7 active."],"usage":{"input_tokens":2600,"output_tokens":190,"cache_read":1800},"ttfc_ms":350,"ttc_ms":980,"validation":{"passed":true,"issues":[]}},{"turn":4,"tier":"L3","message":"Game 1 results: Sarah won, Tom second, Linda third. Sarah 10 pts, Tom 7, Linda 5. Everyone else 2 points for showing up.","tool_calls":[{"name":"mutate_entity","input":{"action":"update","ref":"game_1","props":{"status":"complete","winner":"Sarah"}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_sarah","parent":"standings","props":{"name":"Sarah","points":10,"wins":1,"losses":0}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_tom","parent":"standings","props":{"name":"Tom","points":7,"wins":0,"losses":1}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_linda","parent":"standings","props":{"name":"Linda","points":5,"wins":0,"losses":1}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_dave","parent":"standings","props":{"name":"Dave","points":2,"wins":0,"losses":1}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_amy","parent":"standings","props":{"name":"Amy","points":2,"wins":0,"losses":1}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_jake","parent":"standings","props":{"name":"Jake","points":2,"wins":0,"losses":1}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_priya","parent":"standings","props":{"name":"Priya","points":2,"wins":0,"losses":1}}}],"text_blocks":["Game 1 recorded. Sarah leads with 10 points."],"usage":{"input_tokens":2900,"output_tokens":420,"cache_read":2000},"ttfc_ms":380,"ttc_ms":2100,"validation":{"passed":true,"issues":[]}},{"turn":5,"tier":"L3","message":"Actually let's also track a buy-in amount per player. Default $20.","tool_calls":[{"name":"mutate_entity","input":{"action":"update","ref":"player_mike","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_dave","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_sarah","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_linda","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_tom","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_amy","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_jake","props":{"buy_in":20}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_priya","props":{"buy_in":20}}}],"text_blocks":["Buy-in field added. $20 default across all 8 players."],"usage":{"input_tokens":3100,"output_tokens":340,"cache_read":2200},"ttfc_ms":360,"ttc_ms":1600,"validation":{"passed":true,"issues":[]}},{"turn":6,"tier":"L3","message":"Mike's back for game 2. Jake can't make it. Sarah's hosting, Priya on snacks.","tool_calls":[{"name":"mutate_entity","input":{"action":"update","ref":"player_mike","props":{"status":"active"}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_jake","props":{"status":"out"}}},{"name":"mutate_entity","input":{"action":"update","ref":"player_dave","props":{"snack_duty":false}}},{"name":"mutate_entity","input":{"action":"create","id":"game_2","parent":"schedule","props":{"date":"2026-03-05","host":"Sarah","snacks":"Priya","status":"upcoming"}}}],"text_blocks":["Mike active. Jake out for game 2. Sarah hosting, Priya on snacks."],"usage":{"input_tokens":3400,"output_tokens":250,"cache_read":2600},"ttfc_ms":330,"ttc_ms":1100,"validation":{"passed":true,"issues":[]}},{"turn":7,"tier":"L3","message":"Who's in the lead right now?","tool_calls":[],"text_blocks":["Sarah leads with 10 points and 1 win. Tom is second with 7, Linda third with 5. Dave, Amy, Jake, and Priya each have 2 points."],"usage":{"input_tokens":3600,"output_tokens":120,"cache_read":2800},"ttfc_ms":280,"ttc_ms":650,"validation":{"passed":true,"issues":[]}},{"turn":8,"tier":"L3","message":"Game 2 results: Mike won! Tom second again, Amy third. Mike 10, Tom 7, Amy 5, everyone else 2. Update the standings.","tool_calls":[{"name":"mutate_entity","input":{"action":"update","ref":"game_2","props":{"status":"complete","winner":"Mike"}}},{"name":"mutate_entity","input":{"action":"create","id":"standing_mike","parent":"standings","props":{"name":"Mike","points":10,"wins":1,"losses":0}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_tom","props":{"points":14,"losses":2}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_amy","props":{"points":7,"losses":2}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_sarah","props":{"points":12,"losses":1}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_linda","props":{"points":7,"losses":2}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_dave","props":{"points":4,"losses":2}}},{"name":"mutate_entity","input":{"action":"update","ref":"standing_priya","props":{"points":4,"losses":2}}}],"text_blocks":["Game 2 recorded. Tom leads overall at 14 points. Sarah 12, Mike 10."],"usage":{"input_tokens":3900,"output_tokens":380,"cache_read":3000},"ttfc_ms":340,"ttc_ms":1900,"validation":{"passed":true,"issues":[]}}]};

// ── Init ───────────────────────────────────
loadGoldenData(DEMO);
renderChat();
</script>
</body>
</html>
